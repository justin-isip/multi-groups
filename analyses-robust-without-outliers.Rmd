---
title: "Untitled"
author: "Justin Isip"
date: "2023-08-24"
output: html_document
---

# This Rmd is for the pairwise comparisons using robust linear mixed models to identify outliers, as well as run the 
# robust lms without the ouliers and then create % change in abundance or species richness plots to see if the inferences change without the outliers

### Clear the workspace
```{r}
rm(list=ls())
```

### Load required packages
```{r}
library(tidyverse) # data processing
library(lme4) # for mixed effects models
library(car) # for getting anova tables with significance values
library(DHARMa) # for model criticism plots
library(MuMIn) # for checking explanatory power of mixed effects models
library(sjPlot) # for visualising results
library(effects) # for extracting model effects
library(merTools) # useful for a few things, but we're using it for extracting estimates for plotting
library(emmeans) # testing multiple comparisons (but also useful for plotting)
library(coefplot) # visualising model coefficients
library(cli)
library(ggeffects)
library(ggpubr)
library(lmerTest)
library(influence.ME)
library(robustlmm)
library(performance)
library(StatisticalModels)
library(lmtest)
library(aod)
library(parameters)
```

### Load in model plot function
```{r}

## Load in a model criticism function - this function is used for checking the residual/model diagnostic plots to test that the model is meeting all of its assumptions
model_plot <-function(mod.for.plot){
  require(lattice)
  
  # set up a 2 x 2 grid for plotting
  par(mfrow = c(2,2))
  par(ask = TRUE)
  
  # qqplot
  qqnorm(resid(mod.for.plot))
  qqline(resid(mod.for.plot), col = 2)
  
  # residuals vs fitted plot
  plot(fitted(mod.for.plot), resid(mod.for.plot),xlab = "Fitted Values", ylab = "Residuals", main = "Residuals vs fitted")
  abline(h=0, lty=2)
  lines(smooth.spline(fitted(mod.for.plot), resid(mod.for.plot)), col = "red")
  
  # histogram of residuals
  hist(resid(mod.for.plot))
  
  # random effects distribution
  dotplot(ranef(mod.for.plot,condVar = TRUE))
}
```

### Load add_order_fold function to split the diversity data into exclusive insect orders 
```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Diptera"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Coleoptera"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Lepidoptera"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Hemiptera"
    data$order_fold[data$Higher_taxon == "Arachnida"] <- "Arachnida"
    data$order_fold[data$Higher_taxon == "Odonata" |
                    data$Higher_taxon == "Trichoptera" |
                    data$Higher_taxon == "Ephemeroptera" |
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Phylum == "Arthropoda" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Arachnida" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherArthropods"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

### Load get_site_abundances_order function to calculate total abundance for each site x order_fold combination
```{r}
# Calculate total abundance for each site --------------------------------------
# Modified to clarify reporting is on site x fold combinations
get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
        # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance),
           MinNonZero = min(TotalAbundance[TotalAbundance > 0])) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
    # If a study reports abundance as a count, add 1 to all values; otherwise
  # add 1/2 the minimum non-zero value; then log-transform to get a useful
  # logAbundance value that may be more symmetric than sqrtRescaledAbundance.
  sites$to_add <- ifelse(sites$Diversity_metric_unit %in%
                           c("individuals", "times observed"), 1,
                         sites$MinNonZero/2)
  sites$logAbundance <- log(sites$TotalAbundance + sites$to_add)
  
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

### Load all other functions
```{r}
source("/Applications/PhD/Andy/data_prep_functions.R")
source("/Applications/PhD/Andy/site_comparison_functions.R")
source("https://highstat.com/Books/Book2/HighstatLibV10.R") # collinearity
source("/Applications/PhD/Projects/multi-groups/scripts/combine_and_plot_function.R")
source("/Applications/PhD/Projects/multi-groups/scripts/predict_this_model.R")
```

### Read in the data
```{r}
diversity <- readRDS("./data/diversity-2022-04-13-02-33-10.rds")
```

### Correct for sampling effort
```{r}
if(check_sampling_effort_nas(diversity) ==
   FALSE) stop("Some studies have NA for sampling effort in only some sites!")

diversity <- correct_for_sampling_effort(diversity)
print(summarise_diversity(diversity))
```

### Merge sites
```{r}
merged <- merge_sites(diversity, verbose = TRUE) 
```

# Filter merged for five orders of interest and then subset for studies that look at more than one of those orders
```{r}
# Start from the merged data not the model data
five_orders <-
  merged %>%
  filter(Higher_taxon %in% c("Diptera", "Coleoptera", "Lepidoptera", "Hymenoptera", "Hemiptera")) %>% 
  # filter here for the orders of interest so that when we group by study, we are only looking at studies that observe those five orders
  group_by(SS) %>% # group by SS
  mutate(
    Multiple_groups = 
      case_when(
        (length(unique(Higher_taxon))) > 1 ~ "YES",
        (length(unique(Higher_taxon))) == 1 ~ "NO")) %>%  
  filter(Multiple_groups == "YES") %>% 
  droplevels()

# five_orders only contains studies that look at more than one of those five orders

levels(five_orders$Higher_taxon)
table(five_orders$Higher_taxon)
```

### Add_order_fold to allow taxonomic cross-validation 
```{r}
# Just adds order_fold column
five_orders <- add_order_fold(five_orders, verbose = TRUE)
levels(five_orders$order_fold)
```

### Calculate site level diversity metrics using get_site_abundances_order and order_fold for each site x order combination
```{r}

five_orders <- get_site_abundances_order(five_orders, 
                                  order_folds = TRUE, verbose = TRUE)

table(five_orders$order_fold) # number of rows for each site x order combination

# We have 8065 sites for the five orders in multi group studies

```

### Fix up your explanatory variables 
```{r}

# Rename predominant habitat since its not really habitat we're looking at
five_orders <- rename(five_orders,
                Predominant_land_use = Predominant_habitat)


# Relevel the land use and use intensity classes
five_orders <- five_orders %>%
  
  mutate(
    
    # collapse primary forest and non-forest together into primary vegetation as these aren't well distinguished
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Primary forest" = "Primary", 
                                         "Primary non-forest" = "Primary"),
    
    # indeterminate secondary veg and cannot decide get NA
    Predominant_land_use = na_if(Predominant_land_use, "Secondary vegetation (indeterminate age)"),
    Predominant_land_use = na_if(Predominant_land_use, "Cannot decide"), 
    Use_intensity = na_if(Use_intensity, "Cannot decide"),
    
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# take a look at the LandUse/Use intensity split
table(five_orders$Predominant_land_use, five_orders$Use_intensity)
```

# Collinearity
```{r}
source("https://highstat.com/Books/Book2/HighstatLibV10.R")
corvif(five_orders[ , c("Predominant_land_use", "Use_intensity")])
```

### Complete cases
```{r}

# This will drop all the rows with NAs for abundance, land use or use intensity so we have complete data for modelling
model_data_ab <- drop_na(five_orders, 
                         RescaledAbundance, Predominant_land_use,
                         Use_intensity)

model_data_sr <- drop_na(five_orders, 
                         SpeciesRichness, Predominant_land_use,
                         Use_intensity)

#sum(is.na(five_orders$RescaledAbundance))
#sum(is.na(five_orders$SpeciesRichness))
#sum(is.na(five_orders$Predominant_land_use))
# There are no NAs for either of our explanatory variables so model_data_ab and model_data_sr are the same dataframe
```

### Prepare the abundance model dataframe
```{r}

# No longer needed as lme4 has improved, can use logAbundance provided in get_site_abundances()
# model_data_ab$logRescaledAbundance <- log(model_data_ab$RescaledAbundance + 1)
# sum(model_data_ab$RescaledAbundance == 1)

# Check the distributions
#hist(model_data_ab$RescaledAbundance) ; hist(model_data_ab$logAbundance) ; hist(model_data_ab$sqrtRescaledAbundance)

#plot(density(model_data_ab$logAbundance)) 

# Have a look at sample sizes
#table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity)

# Collapse intense and light land use intensities to have a more even spread of the data
model_data_ab <- 
  model_data_ab %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
# Have a look at sample sizes
#table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity)
```

# Tims function
```{r}

PredictGLMERRandIter <- function(model,data,nIters=1000){
  
  # stopifnot((class(model)[1] == "lmerMod") | (class(model)[1] == "glmerMod"))
  
  # Get names of model factors from prediction data frame
  model.factors <- names(which(sapply(data,is.factor)))
  
  # For each factor, check that levels in prediction data frame match levels
  # in model data frame
  invisible(sapply(X = model.factors,FUN = function(fac){
    stopifnot(all(levels(data[[fac]]) == levels(model@frame[[fac]])))
  }))
  
  # Sapply takes lists as input and gives output in vector or matrix
  preds <- sapply(X = 1:nIters,FUN = function(i){
    
    # Creates a design matrix, by expanding the factors to a set of dummy variables 
    mm<-model.matrix(terms(model),data)
    
    if(ncol(mm)>length(lme4::fixef(model))){
      mm <- mm[,-which(!(names(mm[1,]) %in% names(
        lme4::fixef(model))))]
    }
    
    # Produces one sample from the specified multivariate normal distribution
    # mu = a vector giving the means of the variables
    # Sigma = a positive-definite symmetric matrix specifying the covariance matrix of the variables
    fe.draw <- mvrnorm(n = 1,mu = fixef(model),Sigma = vcov(model))
    
    #  %*%  = multiplication of matrices in R
    y <- mm %*% fe.draw
    
  })
  
  return(preds)
}

```




# Order comparisons for abundance




### diptera_hymenoptera prepare df
```{r}
# Remove chubby datasets
rm(merged, diversity)

# Filter for studies that only compare hymenoptera and diptera
dip_hym_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies
diptera_hymenoptera <- model_data_ab %>% filter(SS %in% dip_hym_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Hymenoptera", "Diptera")) %>% droplevels()

```

### Robust lms to extract outliers
```{r}
# First run the robust lm
r_m1 <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# Have a look
#summary(r_m1)
#plot(r_m1)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_hymenoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_hymenoptera %>% filter(weights == 1) 

# Extract the potential outliers, i.e. those weights not equal to 1
#outliers_only <- diptera_hymenoptera[diptera_hymenoptera$weights != 1,]

# Now I have a dataframe without the outliers to predict the effects for each order, to see if the inferences change.

# Diptera as the ref
r_dip <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
#summary(r_dip)
#plot(r_dip)
```

### Simulate Diptera effects
```{r}
# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logAbundance <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

### Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_hym) ; summary(r_dip)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logAbundance <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))
```

### Plot the effects
```{r}
  # Add land-use factors for plotting
  comb_plot_limits <- c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban") 
  
  # Add specific colours for each order
  group_colours <- c(Diptera = "#FFC300", Lepidoptera = "#ff5733", Hymenoptera = "#c70039", Hemiptera = "#900c3f", Coleoptera = "#581845")
  
combined <- rbind(dip_df, hym_df)

diptera_hymenoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_hymenoptera_plot_AB.png", diptera_hymenoptera_plot_AB_robust, height = 7, width = 9)

```

### Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Below is the full model with the interaction term
# r_dip <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
# The error around the models not being nested is because I relevel the df to make hymenoptera the reference order, so I compare add to r_hym instead of add to r_dip.
test_wald(add, r_hym) 

# Check residuals
#hist(residuals(r_dip)) ; hist(residuals(r_hym))

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
d <- corr_dip[2:8, 1]
h <- corr_hym[2:8, 1]
plot(d,h)
cor(d,h)

# Don't include primary in the correlations as it isn't included in the plot.

# Extract correlation coefficients
#corr_dip_hym <- as.matrix(summary(r_dip)$coefficients)
#diptera <- corr_dip[2:8, 1]
#hymenoptera <- corr_dip_hym[10:nrow(corr_dip_hym), 1] 
# Plot the coefficients
#plot(diptera, hymenoptera)
#cor(diptera, hymenoptera)

rm(add, combined, corr_dip, corr_hym, dip_df, diptera_hymenoptera, hym_df, no_outliers, preds, r_dip, r_hym, r_m1, d, h, preds.lower.95, preds.median, preds.upper.95, weights, diptera_hymenoptera_plot_AB_robust)
```




# diptera_coleoptera abundance prepare df
```{r}
# Studies
dip_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_coleoptera <- model_data_ab %>% filter(SS %in% dip_col_ss) %>% filter(Order %in% c("Diptera", "Coleoptera")) %>% droplevels()

```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_coleoptera)

# Have a look
#summary(r_m1)
#plot(r_m1)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_coleoptera %>% filter(weights == 1)

# Now I have a dataframe without the outliers to predict the effects for each order, to see if the inferences change.

# Coleoptera as the ref
r_col <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
#summary(r_col)
#plot(r_col)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logAbundance <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Diptera effects
```{r}
# relevel model with Diptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Diptera"))

# Hymenoptera as the ref
r_dip <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
# summary(r_hym) ; summary(r_dip)

# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logAbundance <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, dip_df)

# Relevel so Diptera appear first
combined <- combined %>% mutate(Order = relevel(Order, ref = "Diptera"))

diptera_coleoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_coleoptera_plot_AB.png", diptera_coleoptera_plot_AB_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_dip)

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_col <- as.matrix(summary(r_col)$coefficients)
d <- corr_dip[2:8, 1]
c <- corr_col[2:8, 1]
plot(d,c)
cor(d,c)

rm(add, col_df, combined, corr_col, corr_dip, dip_df, diptera_coleoptera, no_outliers, preds, r_dip, r_col, r_m1, d, c, preds.lower.95, preds.median, preds.upper.95, weights, diptera_coleoptera_plot_AB_robust)
```




# diptera_hemiptera abundance prepare df
```{r}
# Studies
dip_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_hemiptera <- model_data_ab %>% filter(SS %in% dip_hemi_ss) %>% filter(Order %in% c("Diptera", "Hemiptera")) %>% droplevels()

```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

#summary(r_m1)
#plot(r_m1)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_hemiptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_hemiptera %>% filter(weights == 1)

# Diptera as the reference
r_dip <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
#summary(r_dip)
#plot(r_dip)
```

### Simulate Diptera effects
```{r}
# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logAbundance <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hemiptera effects
```{r}
# relevel model with Hemiptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# Hemiptera as the ref
r_hemi <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_hemi)

# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logAbundance <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(dip_df, hemi_df)

diptera_hemiptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_hemiptera_plot_AB.png", diptera_hemiptera_plot_AB_robust, height = 7, width = 9)


```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hemi) 

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
d <- corr_dip[2:8, 1]
h <- corr_hemi[2:8, 1]
plot(d,h)
cor(d,h)

rm(add, combined, dip_df, diptera_hemiptera, hemi_df, no_outliers, preds, r_dip, d, h, r_hemi, r_m1, preds.lower.95, preds.median, preds.upper.95, weights, corr_dip, corr_hemi)
```




# diptera_lepidoptera abundance prepare df
```{r}
# Studies
dip_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_lepidoptera <- model_data_ab %>% filter(SS %in% dip_lep_ss) %>% filter(Order %in% c("Diptera", "Lepidoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_lepidoptera %>% filter(weights == 1)

# Diptera as ref
r_dip <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
#summary(r_dip)
#plot(r_dip)
```

# Simulate Diptera effects
```{r}
# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logAbundance <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logAbundance <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(dip_df, lep_df)

diptera_lepidoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_lepidoptera_plot_AB.png", diptera_lepidoptera_plot_AB_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
d <- corr_dip[2:8, 1]
l <- corr_lep[2:8, 1]
plot(d,l)
cor(d,l)

rm(add, combined, dip_df, diptera_lepidoptera, lep_df, no_outliers, preds, r_dip, r_lep, r_m1, preds.lower.95, preds.median, preds.upper.95, weights, corr_dip, corr_lep, d, l)
```




# hymenoptera_coleoptera abundance prepare df
```{r}
hym_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_coleoptera <- model_data_ab %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_coleoptera %>% filter(weights == 1)

# Coleoptera as ref
r_col <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
#summary(r_col)
#plot(r_col)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logAbundance <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_hym)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logAbundance <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, hym_df)

hymenoptera_coleoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hymenoptera_coleoptera_plot_AB.png", hymenoptera_coleoptera_plot_AB_robust, height = 7, width = 9)


```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hym) 

# Extract correlation coefficients
corr_col <- as.matrix(summary(r_col)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
c <- corr_col[2:8, 1]
h <- corr_hym[2:8, 1]
plot(c,h)
cor(c,h)

rm(add, col_df, hym_df, combined, corr_col, corr_hym, hymenoptera_coleoptera, no_outliers, preds, r_col, r_hym, r_m1, c, h, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hymenoptera_hemiptera abundance prepare df
```{r}
# Studies
hym_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_hemiptera <- model_data_ab %>% filter(SS %in% hym_hemi_ss) %>% filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_hemiptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_hemiptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_hemiptera %>% filter(weights == 1)

# Hemiptera as ref
r_hemi <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
# summary(r_hemi)
# plot(r_hemi)
```

# Simulate Hemiptera effects
```{r}
# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logAbundance <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_hym)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logAbundance <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hemi_df, hym_df)

hemiptera_hymenoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hemiptera_hymenoptera_plot_AB.png", hemiptera_hymenoptera_plot_AB_robust, height = 7, width = 9)


```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hym) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
hemi <- corr_hemi[2:8, 1]
hym <- corr_hym[2:8, 1]
plot(hemi,hym)
cor(hemi,hym)

rm(add, combined, corr_hemi, corr_hym, hemi_df, hym_df, hymenoptera_hemiptera, no_outliers, preds, r_hemi, r_hym, r_m1, hemi, hym, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hymenoptera_lepidoptera abundance prepare df
```{r}
# Studies
hym_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_lepidoptera <- model_data_ab %>% filter(SS %in% hym_lep_ss) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_lepidoptera %>% filter(weights == 1)

# Hymenoptera as ref
r_hym <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
# summary(r_hym)
# plot(r_hym)
```

# Simulate Hymenoptera effects
```{r}
# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logAbundance <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logAbundance <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hym_df, lep_df)

hymenoptera_lepidoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hymenoptera_lepidoptera_plot_AB.png", hymenoptera_lepidoptera_plot_AB_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_hym <- as.matrix(summary(r_hym)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
h <- corr_hym[2:8, 1]
l <- corr_lep[2:8, 1]
plot(h,l)
cor(h,l)

rm(add, combined, corr_lep, corr_hym, lep_df, hym_df, hymenoptera_lepidoptera, no_outliers, preds, r_lep, r_hym, r_m1, h, l, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hemiptera_lepidoptera abundance prepare df
```{r}
# Studies
hemi_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hemiptera_lepidoptera <- model_data_ab %>% filter(SS %in% hemi_lep_ss) %>% filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hemiptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <-  hemiptera_lepidoptera %>% filter(weights == 1)

# Hemiptera as ref
r_hemi <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
# summary(r_hym)
# plot(r_hym)
```

# Simulate Hemiptera effects
```{r}
# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logAbundance <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logAbundance <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hemi_df, lep_df)

hemiptera_lepidoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hemiptera_lepidoptera_plot_AB.png", hemiptera_lepidoptera_plot_AB_robust, height = 7, width = 9)
```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
h <- corr_hemi[2:8, 1]
l <- corr_lep[2:8, 1]
plot(h,l)
cor(h,l)

rm(add, combined, corr_lep, corr_hemi, lep_df, hemi_df, hemiptera_lepidoptera, no_outliers, preds, r_lep, r_hemi, r_m1, h, l, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hemiptera_coleoptera abundance prepare df
```{r}
# Studies
hemi_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hemiptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hemiptera_coleoptera <- model_data_ab %>% filter(SS %in% hemi_col_ss) %>% filter(Order %in% c("Hemiptera", "Coleoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_coleoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hemiptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hemiptera_coleoptera %>% filter(weights == 1)

# Coleoptera as ref
r_col <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
# summary(r_col)
# plot(r_col)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logAbundance <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hemiptera effects
```{r}
# relevel model with Hemiptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# Hemiptera as the ref
r_hemi <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_hemi)

# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logAbundance <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, hemi_df)

coleoptera_hemiptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/coleoptera_hemiptera_plot_AB.png", coleoptera_hemiptera_plot_AB_robust, height = 7, width = 9)
```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hemi) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_col <- as.matrix(summary(r_col)$coefficients)
h <- corr_hemi[2:8, 1]
c <- corr_col[2:8, 1]
plot(h,c)
cor(h,c)

rm(add, combined, corr_col, corr_hemi, col_df, hemi_df, hemiptera_coleoptera, no_outliers, preds, r_col, r_hemi, r_m1, h, c, preds.lower.95, preds.median, preds.upper.95, weights)
```




### coleoptera_lepidoptera abundance prepare df
```{r}
# Studies
col_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
coleoptera_lepidoptera <- model_data_ab %>% filter(SS %in% col_lep_ss) %>% filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% droplevels()
```

# Robust lms to extract outliers
```{r}
# Robust model
r_m1 <-rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
coleoptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- coleoptera_lepidoptera %>% filter(weights == 1)

# Coleoptera as ref
r_col <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Have a look
# summary(r_col)
# plot(r_col)

```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logAbundance <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logAbundance <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logAbundance) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, lep_df)

coleoptera_lepidoptera_plot_AB_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/coleoptera_lepidoptera_plot_AB.png", coleoptera_lepidoptera_plot_AB_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_lep <- as.matrix(summary(r_lep)$coefficients)
corr_col <- as.matrix(summary(r_col)$coefficients)
l <- corr_lep[2:8, 1]
c <- corr_col[2:8, 1]
plot(l,c)
cor(l,c)

rm(add, combined, corr_col, corr_lep, col_df, lep_df, coleoptera_lepidoptera, no_outliers, preds, r_col, r_lep, r_m1, l, c, preds.lower.95, preds.median, preds.upper.95, weights)
```






### Species Richness

### Prepare the species richness model dataframe
```{r}
# Log transform species richness
model_data_sr$logSR <- log(model_data_sr$SpeciesRichness + 1)

# Check the distributions
#hist(model_data_sr$SpeciesRichness) ; hist(model_data_sr$logSR) ; hist(model_data_ab$logAbundance) ; hist(log(model_data_ab$TotalAbundance + 1))

# Have a look at sample sizes
#table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)

# Collapse intense and light land use intensities to have a more even spread of the data
model_data_sr <- 
  model_data_sr %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
# Have a look at sample sizes
#table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)
```




# diptera_hymenoptera species richness prepare df
```{r}
# Studies
dip_hym_ss_sr <-  model_data_sr %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Its the same sets of studies for abundance and richness so I don't need to recalculate the studies for species richness data
# cbind(dip_hym_ss_sr, dip_hym_ss) %>% View()

# Model data
diptera_hymenoptera <- model_data_sr %>% filter(SS %in% dip_hym_ss_sr) %>% filter(Order %in% c("Diptera", "Hymenoptera")) %>% droplevels()
```

#  Robust lms to extract outliers
```{r}
# Robust lmer model
r_m1 <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

#summary(r_m1)
#plot(r_m1)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_hymenoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_hymenoptera %>% filter(weights == 1)

# Robust lmer model
r_dip <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)
```

# Simulate Diptera effects
```{r}
# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logSR <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

### Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_hym) ; summary(r_dip)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logSR <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))
```

### Plot the effects
```{r}
combined <- rbind(dip_df, hym_df)

diptera_hymenoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_hymenoptera_plot_SR.png", diptera_hymenoptera_plot_SR_robust, height = 7, width = 9)

```

### Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
# The error around the models not being nested is because I relevel the df to make hymenoptera the reference order, so I compare add to r_hym instead of add to r_dip.
test_wald(add, r_hym) 

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
d <- corr_dip[2:8, 1]
h <- corr_hym[2:8, 1]
plot(d,h)
cor(d,h)

rm(add, combined, corr_dip, corr_hym, dip_df, diptera_hymenoptera, hym_df, no_outliers, preds, r_dip, r_hym, r_m1, d, h, preds.lower.95, preds.median, preds.upper.95, weights)
```




# diptera_coleoptera species richness prepare df + robust lm to extract outliers (ERROR)
```{r}
# Studies
dip_col_ss_sr <-  model_data_sr %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_coleoptera <- model_data_sr %>% filter(SS %in% dip_col_ss_sr) %>% filter(Order %in% c("Diptera", "Coleoptera")) %>% droplevels()

# Robust model
r_m1 <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), data = diptera_coleoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_coleoptera %>% filter(weights == 1)

# Diptera as the reference
r_dip <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Can't do as logSR values are too similar once the outliers are removed.
```



# diptera_hemiptera species richness prepare df + robust lm to extract outliers (ERROR)
```{r}
# Model data
diptera_hemiptera <- model_data_sr %>% filter(SS %in% dip_hemi_ss) %>% filter(Order %in% c("Diptera", "Hemiptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB), data = diptera_hemiptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_hemiptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_hemiptera %>% filter(weights == 1)

# Diptera as the reference
r_dip <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Same error message
```



# diptera_lepidoptera species richness prepare df + robust lm to extract outliers
```{r}
# Model data
diptera_lepidoptera <- model_data_sr %>% filter(SS %in% dip_lep_ss) %>% filter(Order %in% c("Diptera", "Lepidoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB), data = diptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
diptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- diptera_lepidoptera %>% filter(weights == 1)

# Diptera as the reference
r_dip <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)
```

# Simulate Diptera effects
```{r}
# Diptera df
dip_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

dip_df$logSR <- 0

dip_df$Predominant_land_use <- factor(dip_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

dip_df$Higher_taxon <- factor(dip_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Diptera predictions 
preds <- PredictGLMERRandIter(model = r_dip, data = dip_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
dip_df$Percent_diff <- preds.median
dip_df$Percent_upper <- preds.upper.95
dip_df$Percent_lower <- preds.lower.95

# pull out effects for Diptera
dip_df <- dip_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logSR <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(dip_df, lep_df)

diptera_lepidoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/diptera_lepidoptera_plot_SR.png", diptera_lepidoptera_plot_SR_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_dip <- as.matrix(summary(r_dip)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
d <- corr_dip[2:8, 1]
l <- corr_lep[2:8, 1]
plot(d,l)
cor(d,l)

rm(add, combined, dip_df, diptera_lepidoptera, lep_df, no_outliers, preds, r_dip, r_lep, r_m1, preds.lower.95, preds.median, preds.upper.95, weights, corr_dip, corr_lep, d, l)
```



# hymenoptera_coleoptera species richness prepare df + robust lm to extract outliers
```{r}
# Model data
hymenoptera_coleoptera <- model_data_sr %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_coleoptera %>% filter(weights == 1)

# Coleoptera as the ref
r_col <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logSR <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_hym)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logSR <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, hym_df)

hymenoptera_coleoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hymenoptera_coleoptera_plot_SR.png", hymenoptera_coleoptera_plot_SR_robust, height = 7, width = 9)


```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hym) 

# Extract correlation coefficients
corr_col <- as.matrix(summary(r_col)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
c <- corr_col[2:8, 1]
h <- corr_hym[2:8, 1]
plot(c,h)
cor(c,h)

rm(add, col_df, hym_df, combined, corr_col, corr_hym, hymenoptera_coleoptera, no_outliers, preds, r_col, r_hym, r_m1, c, h, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hymenoptera_hemiptera species richness prepare df + robust lm to extract outliers
```{r}
# Model data
hymenoptera_hemiptera <- model_data_sr %>% filter(SS %in% hym_hemi_ss) %>% filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
              data = hymenoptera_hemiptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_hemiptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_hemiptera %>% filter(weights == 1)

# Hemiptera as the reference order
r_hemi <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

```

# Simulate Hemiptera effects
```{r}
# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logSR <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hymenoptera effects
```{r}
# relevel model with Hymenoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# Hymenoptera as the ref
r_hym <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_hym)

# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logSR <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hemi_df, hym_df)

hemiptera_hymenoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hemiptera_hymenoptera_plot_SR.png", hemiptera_hymenoptera_plot_SR_robust, height = 7, width = 9)
```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hym) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_hym <- as.matrix(summary(r_hym)$coefficients)
hemi <- corr_hemi[2:8, 1]
hym <- corr_hym[2:8, 1]
plot(hemi,hym)
cor(hemi,hym)

rm(add, combined, corr_hemi, corr_hym, hemi_df, hym_df, hymenoptera_hemiptera, no_outliers, preds, r_hemi, r_hym, r_m1, hemi, hym, preds.lower.95, preds.median, preds.upper.95, weights)
```





# hymenoptera_lepidoptera species_richness prepare df + robust lm to extract outliers
```{r}
# Model data
hymenoptera_lepidoptera <- model_data_sr %>% filter(SS %in% hym_lep_ss) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
              data = hymenoptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hymenoptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hymenoptera_lepidoptera %>% filter(weights == 1)

#  Hymenoptera as ref
r_hym <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)
```

# Simulate Hymenoptera effects
```{r}
# Hymenoptera df
hym_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hym_df$logSR <- 0

hym_df$Predominant_land_use <- factor(hym_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hym_df$Higher_taxon <- factor(hym_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hymenoptera predictions 
preds <- PredictGLMERRandIter(model = r_hym, data = hym_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hym_df$Percent_diff <- preds.median
hym_df$Percent_upper <- preds.upper.95
hym_df$Percent_lower <- preds.lower.95

# pull out effects for Hymenoptera
hym_df <- hym_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logSR <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hym_df, lep_df)

hymenoptera_lepidoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hymenoptera_lepidoptera_plot_SR.png", hymenoptera_lepidoptera_plot_SR_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_hym <- as.matrix(summary(r_hym)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
h <- corr_hym[2:8, 1]
l <- corr_lep[2:8, 1]
plot(h,l)
cor(h,l)

rm(add, combined, corr_lep, corr_hym, lep_df, hym_df, hymenoptera_lepidoptera, no_outliers, preds, r_lep, r_hym, r_m1, h, l, preds.lower.95, preds.median, preds.upper.95, weights)
```





# hemiptera_lepidoptera species richness prepare df + robust lm to extract outliers
```{r}
# Model data
hemiptera_lepidoptera <- model_data_sr %>% filter(SS %in% hemi_lep_ss) %>% filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
              data = hemiptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hemiptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hemiptera_lepidoptera %>% filter(weights == 1)

# Hemiptera as the ref
r_hemi <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)
```

# Simulate Hemiptera effects
```{r}
# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logSR <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logSR <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(hemi_df, lep_df)

hemiptera_lepidoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/hemiptera_lepidoptera_plot_SR.png", hemiptera_lepidoptera_plot_SR_robust, height = 7, width = 9)
```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_lep <- as.matrix(summary(r_lep)$coefficients)
h <- corr_hemi[2:8, 1]
l <- corr_lep[2:8, 1]
plot(h,l)
cor(h,l)

rm(add, combined, corr_lep, corr_hemi, lep_df, hemi_df, hemiptera_lepidoptera, no_outliers, preds, r_lep, r_hemi, r_m1, h, l, preds.lower.95, preds.median, preds.upper.95, weights)
```




# hemiptera_coleoptera species_richness prepare df + robust lm to extract outliers
```{r}
# Model data
hemiptera_coleoptera <- model_data_sr %>% filter(SS %in% hemi_col_ss) %>% filter(Order %in% c("Hemiptera", "Coleoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_coleoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
hemiptera_coleoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- hemiptera_coleoptera %>% filter(weights == 1)

# Coleoptera as the ref
r_col <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = no_outliers)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logSR <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Hemiptera effects
```{r}
# relevel model with Hemiptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# Hemiptera as the ref
r_hemi <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
#summary(r_hemi)

# Hemiptera df
hemi_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

hemi_df$logSR <- 0

hemi_df$Predominant_land_use <- factor(hemi_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

hemi_df$Higher_taxon <- factor(hemi_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Hemiptera predictions 
preds <- PredictGLMERRandIter(model = r_hemi, data = hemi_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
hemi_df$Percent_diff <- preds.median
hemi_df$Percent_upper <- preds.upper.95
hemi_df$Percent_lower <- preds.lower.95

# pull out effects for Hemiptera
hemi_df <- hemi_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, hemi_df)

coleoptera_hemiptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust total abundance difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/coleoptera_hemiptera_plot_SR.png", coleoptera_hemiptera_plot_SR_robust, height = 7, width = 9)
```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_hemi) 

# Extract correlation coefficients
corr_hemi <- as.matrix(summary(r_hemi)$coefficients)
corr_col <- as.matrix(summary(r_col)$coefficients)
h <- corr_hemi[2:8, 1]
c <- corr_col[2:8, 1]
plot(h,c)
cor(h,c)

rm(add, combined, corr_col, corr_hemi, col_df, hemi_df, hemiptera_coleoptera, no_outliers, preds, r_col, r_hemi, r_m1, h, c, preds.lower.95, preds.median, preds.upper.95, weights)
```




# coleoptera_lepidoptera species richness prepare df + robust lm to extract outliers
```{r}
# Model data
coleoptera_lepidoptera <- model_data_sr %>% filter(SS %in% col_lep_ss) %>% filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% droplevels()

# Robust model
r_m1 <-rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
              data = coleoptera_lepidoptera)

# Extract the robustness weights for each of the observations
weights <- getME(r_m1, "w_e")

# Add those weights to the initial df
coleoptera_lepidoptera$weights <- weights

# Filter only for weights == 1, i.e. not outliers
no_outliers <- coleoptera_lepidoptera %>% filter(weights == 1)

# Coleoptera as ref
r_col <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)
```

# Simulate Coleoptera effects
```{r}
# Coleoptera df
col_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

col_df$logSR <- 0

col_df$Predominant_land_use <- factor(col_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

col_df$Higher_taxon <- factor(col_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Coleoptera predictions 
preds <- PredictGLMERRandIter(model = r_col, data = col_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
col_df$Percent_diff <- preds.median
col_df$Percent_upper <- preds.upper.95
col_df$Percent_lower <- preds.lower.95

# pull out effects for Coleoptera
col_df <- col_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Simulate Lepidoptera effects
```{r}
# relevel model with Lepidoptera as reference level
no_outliers <- within(no_outliers, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# Lepidoptera as the ref
r_lep <- rlmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = no_outliers)

# Check
summary(r_lep)

# Lepidoptera df
lep_df <- expand.grid(Predominant_land_use=unique(levels(no_outliers$Predominant_land_use)),
                    Higher_taxon=unique(levels(no_outliers$Higher_taxon)))

lep_df$logSR <- 0

lep_df$Predominant_land_use <- factor(lep_df$Predominant_land_use,levels=levels(no_outliers$Predominant_land_use))

lep_df$Higher_taxon <- factor(lep_df$Higher_taxon,levels=levels(no_outliers$Higher_taxon))

# Generate the Lepidoptera predictions 
preds <- PredictGLMERRandIter(model = r_lep, data = lep_df, nIters = 1000)

# Inverse transform out of log space
preds <- (exp(preds))

# Rescale predictions to reference level (i.e. all probabilities = 1 in natural habitat)
preds <- sweep(x = preds,MARGIN = 2,STATS = preds[1,],FUN = '/') 

# Calculate median
preds.median <- ((apply(X = preds,MARGIN = 1,FUN = median,na.rm=TRUE))*100)-100

# Upper 95 CI
preds.upper.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.975,
                       na.rm=TRUE))*100)-100

# Lwr 95 CI
preds.lower.95 <- ((apply(X = preds,MARGIN = 1,FUN = quantile,probs=0.025,
                       na.rm=TRUE))*100)-100

# Append to initial DF
lep_df$Percent_diff <- preds.median
lep_df$Percent_upper <- preds.upper.95
lep_df$Percent_lower <- preds.lower.95

# pull out effects for Lepidoptera
lep_df <- lep_df %>%
  slice(1:8) %>%
  dplyr::select(-logSR) %>%
      rename(Order = Higher_taxon) %>%
      mutate(Predominant_land_use =c("Primary", "YSV", "ISV", "MSV", "Plantation", "Pasture", "Cropland", "Urban"))

```

# Plot the effects
```{r}
# Combine the effects
combined <- rbind(col_df, lep_df)

coleoptera_lepidoptera_plot_SR_robust <- combined %>%
      ggplot()+
      aes(x = Predominant_land_use, y = Percent_diff, colour = Order, group = Order)+
      geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
      geom_point(size = 3, position = position_dodge(width = 0.5))+
      geom_linerange(aes(ymin = Percent_lower, ymax = Percent_upper), position = position_dodge(width = 0.5), linewidth = 1)+
      theme_classic()+
      scale_x_discrete(limits=comb_plot_limits)+
      geom_vline(xintercept = 1.5, linetype = 2)+
      geom_vline(xintercept = 2.5, linetype = 2)+
      geom_vline(xintercept = 3.5, linetype = 2)+
      geom_vline(xintercept = 4.5, linetype = 2)+
      geom_vline(xintercept = 5.5, linetype = 2)+
      geom_vline(xintercept = 6.5, linetype = 2)+
      geom_vline(xintercept = 7.5, linetype = 2)+
      theme(axis.text.x = element_text(face= "bold", angle = 45, hjust = 1),
            axis.title.x = element_blank(),
            axis.title.y = element_text(face = "bold"),
            panel.border = element_rect(colour = "black",  fill=NA))+
      xlab("Land use intensity class")+
      ylab("Robust SR difference (%)") +
      scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
      guides(color = guide_legend(
        override.aes=list(shape = 15, size = 8)))

#ggsave("./figures/no_outliers_figures/coleoptera_lepidoptera_plot_SR.png", coleoptera_lepidoptera_plot_SR_robust, height = 7, width = 9)

```

# Calculate significance of robust model
```{r}
# Run the additive model
add <- rlmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = no_outliers)

# Run a Walds test, to compare the additive model to the full model, to test the importance of the interaction term
test_wald(add, r_lep) 

# Extract correlation coefficients
corr_lep <- as.matrix(summary(r_lep)$coefficients)
corr_col <- as.matrix(summary(r_col)$coefficients)
l <- corr_lep[2:8, 1]
c <- corr_col[2:8, 1]
plot(l,c)
cor(l,c)

rm(add, combined, corr_col, corr_lep, col_df, lep_df, coleoptera_lepidoptera, no_outliers, preds, r_col, r_lep, r_m1, l, c, preds.lower.95, preds.median, preds.upper.95, weights)
```