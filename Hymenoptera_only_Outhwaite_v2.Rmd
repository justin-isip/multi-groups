---
title: "Hymenoptera_only_Outhwaite_v2"
output: html_document
date: "2024-05-01"
---

# This markdown takes a diversity extract of the PREDICTS database (18th April 2024) and (after removing bycatch) generates a site-level dataframe for all Hymenoptera data for Charlies analysis.

#### Clear the work space

```{r}
rm(list=ls())
```

# Read in the data and load packages
```{r}
diversity <- readRDS("/Users/jusi/Desktop/multi-groups/diversity-2024-04-18-02-32-40.rds")
library(tidyverse)
```

# Load functions
```{r}
source("/Users/jusi/Desktop/PhD/Andy/data_prep_functions.R")
```

# Correct for sampling effort
```{r}
if(check_sampling_effort_nas(diversity) ==
   FALSE) stop("Some studies have NA for sampling effort in only some sites!")

diversity <- correct_for_sampling_effort(diversity) # correct for sampling effort

print(summarise_diversity(diversity)) # quick summary
```

# Merge sites
```{r}
merged <- merge_sites(diversity, verbose = TRUE) 
```

# Now that we've merged sites, there's an important distinction to make here for removing bycatch data. There are two kinds of Hymenoptera studies I am interested in when removing bycatch. 1 - Studies that ONLY sample Hymenoptera and 2 - Studies that sample multiple groups including Hymenoptera, i.e. additional groups alongside Hymenoptera. I do not need to worry about bycatch for the first option, because we can assume that all Hymenoptera observations were deliberately targeted, since they are the only sampled group. I do need to worry about bycatch for the second option (as there is a possibility that Hymenoptera could be bycatch in studies that sample multiple groups) and these are the studies that need to be checked ane verified. These studies tend to be on assemblages, communities or have multiple sampling methods for instance.

# Therefore I will subset merged only for studies that sample multiple groups, where at least one of those groups is Hymenoptera.

```{r}
# This filters merged for all of the studies that sample multiple groups where at least one of the groups is Hymenoptera
multi_hymenoptera <- merged %>% 
  group_by(SS) %>% 
  filter(n_distinct(Higher_taxon) > 1 & any(Higher_taxon == "Hymenoptera")) %>% 
  droplevels()

length(unique(multi_hymenoptera$SS)) # 102 studies

# Lets pull the individual multi-group studies which will need to be verified manually into a nicely formatted csv
only_hymenoptera <- multi_hymenoptera %>% 
  filter(Higher_taxon == "Hymenoptera") %>% 
  distinct(SS, .keep_all = TRUE) %>% 
  dplyr::select(SS, Higher_taxon, Sampling_method) %>% 
  unique()

#write.csv(only_hymenoptera, "multi_group_hymenoptera.csv")

```

# In a seperate excel file, I verified the multi-group studies on Hymenoptera (where Hymenoptera is one of the groups sampled alongside at least one other group within a study) for bycatch and updated their sampling methods (if needed) by checking the source papers.

# I will start by updating the sampling methods for those studies which have unspecified sampling methods, i.e. "various", "multiple", "mixed". 

```{r}
# Merge similar sampling methods, e.g. sweep netting and sweep net.
multi_hymenoptera <- multi_hymenoptera %>%
mutate(Sampling_method = recode_factor(Sampling_method,
                                       "sweep netting" = "sweep net", # Combine sweep net and sweep netting
                                       "sweep_netting" = "sweep net",
                                       "sweep nets" = "sweep net",
                                       "soil core" = "soil sample",
                                      "soil cores along transects" = "soil sample", # Combine soil cores, soil cores along transect and soil sample
                                      "mixed traps" = "multiple", # Combine mixed traps with multiple traps
                                      "window trap" = "flight trap",# Combine window/harp trap with flight trap as they are the same thing
                                      "harp trap" = "flight trap",
                                      )) 


# Check the methods
unique(multi_hymenoptera$Sampling_method)

# Update the unspecified sampling methods for those studies based on checking the source publication
multi_hymenoptera <- multi_hymenoptera %>%
  mutate(Sampling_method = case_when(
    SS == "AD1_2002__Vazquez 1" ~ "flower visitation observation",
    SS == "AD1_2006__Blanche 1" ~ "flower visitation observation",
    SS == "AD1_2006__Blanche 2" ~ "flower visitation observation", 
    SS == "AD1_2007__Meyer 2" ~ "flower visitation observation",
    SS == "AD1_2009__Vergara 1" ~ "flower visitation observation",
    SS == "AD1_2011__Bates 1" ~ "pan trap, sweep net, hand searching", # multiple
    SS == "AD1_2011__Weiner 1" ~ "flower visitation observation",
    SS == "AD1_2012__MudriStojnic 1" ~ "flower visitation observation",
    SS == "AD1_2013__Grass 1" ~ "flower visitation observation",
    SS == "AR1_2008__Basset 1" ~ "malaise trap, pan trap, pit-fall trap", # multiple
    SS == "CC1_2005__Barratt 1" ~ "soil sample", 
    SS == "CC1_2005__Barratt 2" ~ "soil sample",
    SS == "CC1_2010__Schon 2" ~ "soil coring",
    SS == "CC1_2012__Waite 2" ~ "bole trap, flight intercept trap, foliage sampling", # multiple
    SS == "CC1_2013__Litchwark 1" ~ "flower visitation observation",
    SS == "CC1_2014__Rader 1" ~ "flight intercept trap, pan trap", # multiple
    SS == "DG1_2012__Ge 1" ~ "soil coring",
    SS == "DI1_2003__Nakamura 1" ~ "leaf litter sampling",
    SS == "GP1_2009__Vasconcelos 2" ~ "leaf litter sampling",
    SS == "MH1_2009__Turner 1" ~ "leaf litter sampling, fogging, ferns cut and bagged", # multiple
    SS == "SC1_2005__Richardson 1" ~ "leaf litter sampling", 
    SS == "SC1_2019__Haggar 1" ~ "leaf litter sampling",
    SS == "SE1_2012__Cabra 1" ~ "pit-fall traps and litter collection", # multiple
    SS == "SH1_2011__Todd 1" ~ "flight intercept trap, pan trap, pit-fall trap", # multiple
    SS == "SJ2_2019__Eckert 1" ~ "pit-fall traps, active searching within quadrat", # multiple
    SS == "TN1_2009__Peters 1" ~ "active visual survey",
    SS == "VB1_2005__Eggleton 2" ~ "soil sampling, leaf litter sampling", # multiple
    SS == "VB1_2012a_Carpenter 1" ~ "hand sorting in quadrat and litter collection", # multiple
    SS == "VB1_2012__LeightonGoodall 1" ~ "soil sampling, leaf litter sampling", # multiple
    SS == "VB1_2020__Burton 2" ~ "soil coring, hand sorting and mustard vermifuge", # multiple
    SS == "VC1_2018__Berkley 2" ~ "active visual survey",
    SS == "VC1_2018__Berkley 3" ~ "active visual survey",
    TRUE ~ Sampling_method
  )) 

unique(multi_hymenoptera$Sampling_method)
```

# Some studies sample larvae, speaking with Gavin Broad (Entomologist at the NHM), you would only expect to sample larvae in the soil, therefore all other instances of larvae caught with any sampling method other than soil sampling are bycatch. Larvae found in the soil are deliberately targeted (not bycatch).

```{r}
# Lets have a look at all instances of larvae 
multi_hymenoptera %>% 
  filter(grepl('larv|immatu|pupa|nymphe|nymph_', Taxon_name_entered, ignore.case = T)) %>% # different words for larvae 
  dplyr::select(SS, Higher_taxon, Taxon_name_entered, Order, Genus, Species, Sampling_method) %>% 
  filter(Higher_taxon == "Hymenoptera") %>% # order of interest
  unique() %>% 
  View() 

# Surprisingly there is only one Hymenoptera study (SS1_2015__Ponge 1) which samples larvae and the method was soil sampling, so no need to filter out larvae not sampled in the soil (as there is none).

# Cross referenced this with merged to be double sure the above was correct (checked there were no other studies with larvae)
merged %>% 
  filter(grepl('larv|immatu|pupa|nymphe|nymph_', Taxon_name_entered, ignore.case = T)) %>% # different words for larvae 
  dplyr::select(SS, Higher_taxon, Taxon_name_entered, Order, Genus, Species, Sampling_method) %>% 
  unique() %>% 
  View() 

```


# Now, based on the expert questionnare, I will match the expert sampling methods to the PREDICTS sampling methods and filter out bycatch if necessary. 

```{r}
active_visual_surveys <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method %in% c("aerial transect",
                                                                                                      "sweep net",
                                                                                                      "flower visitation observation",
                                                                                                      "active visual survey",
                                                                                                      "visual encounter survey",
                                                                                                      "pan trap, sweep net, hand searching")) 
light_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "light trap")


pan_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method %in% c("pan traps",
                                                                                         "pan trap, sweep net, hand searching",
                                                                                         "malaise trap, pan trap, pit-fall trap",
                                                                                         "flight intercept trap, pan trap",
                                                                                         "flight intercept trap, pan trap, pit-fall trap"))
                                                      
flight_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method %in% c("flight trap",
                                                                                            "flight intercept trap, pan trap, pit-fall trap",
                                                                                            "bole trap, flight intercept trap, foliage sampling",
                                                                                            "flight intercept trap, pan trap"))
                                            
malaise_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method %in% c("malaise traps",
                                                                                             "malaise trap, pan trap, pit-fall trap"))    

# Litter sampling only good for ants.
litter_ants <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Family == "Formicidae" 
                                            & Sampling_method %in% c("hand sorting in quadrat and litter collection",
                                                                                            "leaf litter sampling",
                                                                                            "leaf litter sampling, fogging, ferns cut and bagged",
                                                                                            "litter collection",
                                                                                            "pit-fall traps and litter collection",
                                                                                            "soil sampling, leaf litter sampling"))

# All expert methods have now been cleaned.
```

# Some of the PREDICTS sampling methods could not be assigned to an expert sampling method, e.g. "soil sampling", "glue trap", "trap nests", "bole trap", "suction sampling", "live traps", baited traps", "specimen collection".
# I will clean these methods based on comms with VB, GB and BW. Note - where a study contained multipled sampling methods, if any one of those methods was suitable for Hymenoptera then it was included.

```{r}

# Soil sampling only good for ants.
soil_sampling <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Family == "Formicidae" 
                                              & Sampling_method %in% c("soil coring",
                                                                       "soil coring, hand sorting and mustard vermifuge",
                                                                       "soil sample",
                                                                       "soil sampling, leaf litter sampling"))



glue_traps <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "glue traps")

trap_nests <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "trap nests")

# Pitfall traps only good for ants.
pitfall_ants <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Family == "Formicidae" 
                                             & Sampling_method %in% c("flight intercept trap, pan trap, pit-fall trap",
                                                                      "malaise trap, pan trap, pit-fall trap",
                                                                      "pit-fall traps",
                                                                      "pit-fall traps and litter collection",
                                                                      "pit-fall traps, active searching within quadrat"))

# Smith 2023 is the only baited traps Hymenoptera paper, checking source paper - Hymenoptera > 20% individuals so not bycatch.
baited_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "baited traps")

# Live traps (Bouyer 2 and Bouyer 3 2007) checked source paper and Hymenoptera deliberately targeted.
live_trap <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "live traps")

# Specimen collection (Dobrosavljevic 2020) checked source paper and Hymenopteran leaf miners deliberately targeted.
specimen_collection <- multi_hymenoptera %>% filter(Order == "Hymenoptera" & Sampling_method == "specimen collection")

# BYCATCH METHODS
# Hymenoptera are bycatch in both bole traps and suction sampling so no data frames created for those sampling methods.

# Below is code I use to filter for all possible iterations of a given sampling method.                                               
multi_hymenoptera %>% 
  filter(grepl('pit', Sampling_method, ignore.case = T)) %>% # different sampling methods containing pit
  dplyr::select(SS,Sampling_method) %>% 
  unique() %>% 
  View()

# All PREDICTS sampling methods that could not be matched to an expert sampling method have now been cleaned.   
```

# Now that I've cleaned all of the sampling methods for Hymenoptera, I will combine them.
```{r}
clean <- bind_rows(active_visual_surveys,
                   light_trap,
                   pan_trap,
                   flight_trap,
                   malaise_trap,
                   litter_ants,
                   soil_sampling,
                   glue_traps,
                   trap_nests,
                   pitfall_ants,
                   baited_trap,
                   live_trap,
                   specimen_collection)

# Remove duplicate rows as some data will have been duplicated due to the studies with multiple sampling methods.
clean <- unique(clean)

# Tidy the environment
rm(active_visual_surveys,light_trap,pan_trap,flight_trap,malaise_trap,litter_ants,soil_sampling,glue_traps,trap_nests,pitfall_ants,baited_trap,live_trap,specimen_collection)
```

# Ok, I've cleaned and verified the multi-group Hymenoptera studies for bycatch, but I do need to remerge them to the single group Hymenoptera studies (which do not need to be verified for bycatch since they would be deliberately targeted as the only group), to have an overall dataframe for all Hymenoptera.

```{r}
all_hymenoptera <- merged %>% filter(Higher_taxon == "Hymenoptera") %>%  droplevels() # 441658 rows for all Hymenoptera

# Lets do a few sense checks

# Overall number of Hymenoptera studies
length(unique(all_hymenoptera$SS)) # 269

# Number of multi group Hymenoptera studies
length(unique(multi_hymenoptera$SS)) # 102

# Therefore single group studies should be 167 (269 - 102) 
single_hymenoptera <- merged %>% 
  group_by(SS) %>% 
  filter(n_distinct(Higher_taxon) == 1 & any(Higher_taxon == "Hymenoptera")) %>% 
  droplevels()

# Number of single group Hymenoptera studies
length(unique(single_hymenoptera$SS)) # 167

# We've sense checked numbers of studies (i.e. the difference between the number of studies for all Hymenoptera and multi-group Hymenoptera == single group Hymenoptera studies), now lets have a deeper look:

# Lets sense check the numbers of rows, which for multi-hymenoptera should be the difference between all_hymenoptera and single_hymenoptera, so 441658 (all) - 359704 (single) = 81954 (multi)

# lets have a look:

# This returns all the rows in all_hymenoptera without a match in single_hymenoptera, i.e. the multi-group rows.
sense_check <- anti_join(all_hymenoptera, single_hymenoptera) %>% droplevels() 


nrow(sense_check) # It is 81954

# I can do an additional sense check, if I filter multi_hymenoptera for just Hymenoptera (the additional rows are for the other groups sampled alongside Hymenoptera) - it should also have 81954 rows.

sense_check2 <- multi_hymenoptera %>%  filter(Higher_taxon == "Hymenoptera") %>% droplevels()
# This returns all the rows in multi_hymenoptera for Hymenoptera.

nrow(sense_check2) # 81954

# In theory sense_check and sense_check2 should be the same data
# sense_check = all the rows in all_hymenoptera without a match in single_hymenoptera, i.e. the multi-group rows.
# sense_check2 = all the rows in multi_hymenoptera for Hymenoptera.

# They are the same length which is reassuring, they're not identical though
identical(sense_check, sense_check2)

# Lets have a look at the rows in sense_check but not in sense_check2
diff <- setdiff(sense_check, sense_check2) 

diff %>% dplyr::select(SS, Order, Sampling_method) %>% unique() %>% View()

# It seems like the sampling methods for these studies need to be updated in sense_check too, in order to match the sampling methods for
# sense_check2 which is filtered from multi_hymenoptera which already had its sampling methods updated.
sense_check <- sense_check %>%
  mutate(Sampling_method = case_when(
    SS == "AD1_2002__Vazquez 1" ~ "flower visitation observation",
    SS == "AD1_2006__Blanche 1" ~ "flower visitation observation",
    SS == "AD1_2006__Blanche 2" ~ "flower visitation observation", 
    SS == "AD1_2007__Meyer 2" ~ "flower visitation observation",
    SS == "AD1_2009__Vergara 1" ~ "flower visitation observation",
    SS == "AD1_2011__Bates 1" ~ "pan trap, sweep net, hand searching", # multiple
    SS == "AD1_2011__Weiner 1" ~ "flower visitation observation",
    SS == "AD1_2012__MudriStojnic 1" ~ "flower visitation observation",
    SS == "AD1_2013__Grass 1" ~ "flower visitation observation",
    SS == "AR1_2008__Basset 1" ~ "malaise trap, pan trap, pit-fall trap", # multiple
    SS == "CC1_2005__Barratt 1" ~ "soil sample", 
    SS == "CC1_2005__Barratt 2" ~ "soil sample",
    SS == "CC1_2010__Schon 2" ~ "soil coring",
    SS == "CC1_2012__Waite 2" ~ "bole trap, flight intercept trap, foliage sampling", # multiple
    SS == "CC1_2013__Litchwark 1" ~ "flower visitation observation",
    SS == "CC1_2014__Rader 1" ~ "flight intercept trap, pan trap", # multiple
    SS == "DG1_2012__Ge 1" ~ "soil coring",
    SS == "DI1_2003__Nakamura 1" ~ "leaf litter sampling",
    SS == "GP1_2009__Vasconcelos 2" ~ "leaf litter sampling",
    SS == "MH1_2009__Turner 1" ~ "leaf litter sampling, fogging, ferns cut and bagged", # multiple
    SS == "SC1_2005__Richardson 1" ~ "leaf litter sampling", 
    SS == "SC1_2019__Haggar 1" ~ "leaf litter sampling",
    SS == "SE1_2012__Cabra 1" ~ "pit-fall traps and litter collection", # multiple
    SS == "SH1_2011__Todd 1" ~ "flight intercept trap, pan trap, pit-fall trap", # multiple
    SS == "SJ2_2019__Eckert 1" ~ "pit-fall traps, active searching within quadrat", # multiple
    SS == "TN1_2009__Peters 1" ~ "active visual survey",
    SS == "VB1_2005__Eggleton 2" ~ "soil sampling, leaf litter sampling", # multiple
    SS == "VB1_2012a_Carpenter 1" ~ "hand sorting in quadrat and litter collection", # multiple
    SS == "VB1_2012__LeightonGoodall 1" ~ "soil sampling, leaf litter sampling", # multiple
    SS == "VB1_2020__Burton 2" ~ "soil coring, hand sorting and mustard vermifuge", # multiple
    SS == "VC1_2018__Berkley 2" ~ "active visual survey",
    SS == "VC1_2018__Berkley 3" ~ "active visual survey",
    TRUE ~ Sampling_method
  )) 

# I'll also merge similar methods again
sense_check <- sense_check %>%
mutate(Sampling_method = recode_factor(Sampling_method,
                                       "sweep netting" = "sweep net", # Combine sweep net and sweep netting
                                       "sweep_netting" = "sweep net",
                                       "sweep nets" = "sweep net",
                                       "soil core" = "soil sample",
                                      "soil cores along transects" = "soil sample", # Combine soil cores, soil cores along transect and soil sample
                                      "mixed traps" = "multiple", # Combine mixed traps with multiple traps
                                      "window trap" = "flight trap",# Combine window/harp trap with flight trap as they are the same thing
                                      "harp trap" = "flight trap",
                                      )) 

# Lets have a look at diff again
diff <- setdiff(sense_check, sense_check2)  # there are no rows in sense_check which are not in sense_check2

# Another sensitivity check
all.equal(sense_check, sense_check2) # Test if Two Objects are (Nearly) Equal
```


# Great, now that I'm confident that merging the cleaned multi-group Hymenoptera data with the single-group Hymenoptera (which did not need to be verified for bycatch) gives me all of the relevant data on Hymenopterans within PREDICTS for Charlies analysis, lets go ahead and do that:

```{r}
# Tidy
rm(diff, sense_check, sense_check2)

# Lets merge the two df - this is the cleaned multi-group data combined with all of the single-group Hymenoptera studies
overall <- rbind(clean, single_hymenoptera)

# Lets also calculate how many rows were removed as bycatch
nrow(clean)

# Number of rows for Hymenoptera before cleaning
non_clean <- (multi_hymenoptera %>% filter(Higher_taxon == "Hymenoptera"))

nrow(non_clean) - nrow(clean) # 6456 rows of bycatch removed, not too bad!

# Lets have a look at the actual bycatch data

bycatch <- anti_join(non_clean, clean)

bycatch %>% select(SS, Order, Family, Taxon_name_entered, Sampling_method) %>% unique() %>%View()

# We can sense check this again by checking that the difference between all_hymenoptera and the cleaned overall dataset = 6456 (bycatch data)
nrow(all_hymenoptera) - nrow(overall) # 6456! 

# tidy
rm(all_hymenoptera, bycatch, diversity, multi_hymenoptera, non_clean, single_hymenoptera)
```

# Ok, we've got our cleaned overall data frame for Hymenoptera, lets calculate the site level diversity metrics.

#### Load add_order_fold function to split the cleaned data into exclusive insect orders (in this case just Hymenoptera)

```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Diptera"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Coleoptera"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Lepidoptera"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Hemiptera"
    data$order_fold[data$Higher_taxon == "Arachnida"] <- "Arachnida"
    data$order_fold[data$Higher_taxon == "Odonata" |
                    data$Higher_taxon == "Trichoptera" |
                    data$Higher_taxon == "Ephemeroptera" |
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Phylum == "Arthropoda" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Arachnida" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherArthropods"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

#### Load get_site_abundances_order function to calculate total abundance for each site x order_fold combination

```{r}
# Calculate total abundance for each site --------------------------------------
# Modified to clarify reporting is on site x fold combinations
get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
        # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance),
           MinNonZero = min(TotalAbundance[TotalAbundance > 0])) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
    # If a study reports abundance as a count, add 1 to all values; otherwise
  # add 1/2 the minimum non-zero value; then log-transform to get a useful
  # logAbundance value that may be more symmetric than sqrtRescaledAbundance.
  sites$to_add <- ifelse(sites$Diversity_metric_unit %in%
                           c("individuals", "times observed"), 1,
                         sites$MinNonZero/2)
  sites$logAbundance <- log(sites$TotalAbundance + sites$to_add)
  
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

#### Add_order_fold to allow taxonomic cross-validation

```{r}
# Just adds order_fold column
overall <- add_order_fold(overall, verbose = TRUE) # 435202 rows for Hymenoptera
levels(overall$order_fold) # check its just for Hymenoptera
```

#### Calculate site level diversity metrics using get_site_abundances_order and order_fold for Hymenoptera
```{r}

overall <- get_site_abundances_order(overall, order_folds = TRUE, verbose = TRUE)
# 6457 sites, 231 studies, 157 sources.

table(overall$order_fold) # number of sites (each row is a site)

# Few checks to make sure its only for Hymenopterans
levels(overall$Order)
levels(overall$Higher_taxon)
levels(overall$order_fold)

overall %>% select(SS, Order, Sampling_method) %>% unique() %>% View()


saveRDS(hymenoptera, file = "hymenoptera_only.rds")


clean %>% dplyr::select(Source_ID, SS, SSB, SSBS, SSBST, Sampling_method, Region, Higher_taxon) %>% View()
```





