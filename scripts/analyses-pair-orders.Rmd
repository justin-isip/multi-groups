---
title: "Untitled"
author: "Justin Isip"
date: "2023-03-07"
output: html_document
---

# This Rmd runs the models and the subsequent figures for each of the pairwise comparisons (10 for abundance, 10 for species richness) between the five orders (Coleoptera, Diptera, Hymenoptera, Hemiptera and Lepidoptera).

### Clear the workspace
```{r}
rm(list=ls())
```

### Load required packages
```{r}
library(tidyverse) # data processing
library(lme4) # for mixed effects models
library(car) # for getting anova tables with significance values
library(DHARMa) # for model criticism plots
library(MuMIn) # for checking explanatory power of mixed effects models
library(sjPlot) # for visualising results
library(effects) # for extracting model effects
library(merTools) # useful for a few things, but we're using it for extracting estimates for plotting
library(emmeans) # testing multiple comparisons (but also useful for plotting)
library(coefplot) # visualising model coefficients
library(cli)
library(ggeffects)
library(ggpubr)
library(lmerTest)
```

### Load in model plot function
```{r}

## Load in a model criticism function - this function is used for checking the residual/model diagnostic plots to test that the model is meeting all of its assumptions
model_plot <-function(mod.for.plot){
  require(lattice)
  
  # set up a 2 x 2 grid for plotting
  par(mfrow = c(2,2))
  par(ask = TRUE)
  
  # qqplot
  qqnorm(resid(mod.for.plot))
  qqline(resid(mod.for.plot), col = 2)
  
  # residuals vs fitted plot
  plot(fitted(mod.for.plot), resid(mod.for.plot),xlab = "Fitted Values", ylab = "Residuals", main = "Residuals vs fitted")
  abline(h=0, lty=2)
  lines(smooth.spline(fitted(mod.for.plot), resid(mod.for.plot)), col = "red")
  
  # histogram of residuals
  hist(resid(mod.for.plot))
  
  # random effects distribution
  dotplot(ranef(mod.for.plot,condVar = TRUE))
}
```

### Load add_order_fold function to split the diversity data into exclusive insect orders 
```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Diptera"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Coleoptera"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Lepidoptera"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Hemiptera"
    data$order_fold[data$Higher_taxon == "Arachnida"] <- "Arachnida"
    data$order_fold[data$Higher_taxon == "Odonata" |
                    data$Higher_taxon == "Trichoptera" |
                    data$Higher_taxon == "Ephemeroptera" |
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Phylum == "Arthropoda" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Arachnida" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherArthropods"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

### Load get_site_abundances_order function to calculate total abundance for each site x order_fold combination
```{r}
# Calculate total abundance for each site --------------------------------------
# Modified to clarify reporting is on site x fold combinations
get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
        # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance),
           MinNonZero = min(TotalAbundance[TotalAbundance > 0])) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
    # If a study reports abundance as a count, add 1 to all values; otherwise
  # add 1/2 the minimum non-zero value; then log-transform to get a useful
  # logAbundance value that may be more symmetric than sqrtRescaledAbundance.
  sites$to_add <- ifelse(sites$Diversity_metric_unit %in%
                           c("individuals", "times observed"), 1,
                         sites$MinNonZero/2)
  sites$logAbundance <- log(sites$TotalAbundance + sites$to_add)
  
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

### Load all other functions
```{r}
source("/Applications/PhD/Andy/data_prep_functions.R")
source("/Applications/PhD/Andy/site_comparison_functions.R")
source("https://highstat.com/Books/Book2/HighstatLibV10.R") # collinearity
source("/Applications/PhD/Projects/multi-groups/scripts/combine_and_plot_function.R")
source("/Applications/PhD/Projects/multi-groups/scripts/predict_this_model.R")
```

### Read in the data
```{r}
diversity <- readRDS("../data/diversity-2022-04-13-02-33-10.rds")

```

### Correct for sampling effort
```{r}
if(check_sampling_effort_nas(diversity) ==
   FALSE) stop("Some studies have NA for sampling effort in only some sites!")

diversity <- correct_for_sampling_effort(diversity)
print(summarise_diversity(diversity))
```

### Merge sites
```{r}
merged <- merge_sites(diversity, verbose = TRUE) 
```

# Filter merged for five orders of interest and then subset for studies that look at more than one of those orders
```{r}
# Start from the merged data not the model data
five_orders <-
  merged %>%
  filter(Higher_taxon %in% c("Diptera", "Coleoptera", "Lepidoptera", "Hymenoptera", "Hemiptera")) %>% 
  # filter here for the orders of interest so that when we group by study, we are only looking at studies that observe those five orders
  group_by(SS) %>% # group by SS
  mutate(
    Multiple_groups = 
      case_when(
        (length(unique(Higher_taxon))) > 1 ~ "YES",
        (length(unique(Higher_taxon))) == 1 ~ "NO")) %>%  
  filter(Multiple_groups == "YES") %>% 
  droplevels()

# five_orders only contains studies that look at more than one of those five orders

levels(five_orders$Higher_taxon)
table(five_orders$Higher_taxon)
```

### Add_order_fold to allow taxonomic cross-validation 
```{r}
# Just adds order_fold column
five_orders <- add_order_fold(five_orders, verbose = TRUE)
levels(five_orders$order_fold)
```

### Calculate site level diversity metrics using get_site_abundances_order and order_fold for each site x order combination
```{r}

five_orders <- get_site_abundances_order(five_orders, 
                                  order_folds = TRUE, verbose = TRUE)

table(five_orders$order_fold) # number of rows for each site x order combination

# We have 8065 sites for the five orders in multi group studies

```

### Fix up your explanatory variables 
```{r}

# Rename predominant habitat since its not really habitat we're looking at
five_orders <- rename(five_orders,
                Predominant_land_use = Predominant_habitat)


# Relevel the land use and use intensity classes
five_orders <- five_orders %>%
  
  mutate(
    
    # collapse primary forest and non-forest together into primary vegetation as these aren't well distinguished
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Primary forest" = "Primary", 
                                         "Primary non-forest" = "Primary"),
    
    # indeterminate secondary veg and cannot decide get NA
    Predominant_land_use = na_if(Predominant_land_use, "Secondary vegetation (indeterminate age)"),
    Predominant_land_use = na_if(Predominant_land_use, "Cannot decide"), 
    Use_intensity = na_if(Use_intensity, "Cannot decide"),
    
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# take a look at the LandUse/Use intensity split
table(five_orders$Predominant_land_use, five_orders$Use_intensity)
```

# Collinearity
```{r}
source("https://highstat.com/Books/Book2/HighstatLibV10.R")
corvif(five_orders[ , c("Predominant_land_use", "Use_intensity")])
```

### Complete cases
```{r}

# This will drop all the rows with NAs for abundance, land use or use intensity so we have complete data for modelling
model_data_ab <- drop_na(five_orders, 
                         RescaledAbundance, Predominant_land_use,
                         Use_intensity)

model_data_sr <- drop_na(five_orders, 
                         SpeciesRichness, Predominant_land_use,
                         Use_intensity)

#sum(is.na(five_orders$RescaledAbundance))
#sum(is.na(five_orders$SpeciesRichness))
#sum(is.na(five_orders$Predominant_land_use))
# There are no NAs for either of our explanatory variables so model_data_ab and model_data_sr are the same dataframe
```

### Prepare the abundance model dataframe
```{r}

# No longer needed as lme4 has improved, can use logAbundance provided in get_site_abundances()
# model_data_ab$logRescaledAbundance <- log(model_data_ab$RescaledAbundance + 1)
# sum(model_data_ab$RescaledAbundance == 1)

# Check the distributions
hist(model_data_ab$RescaledAbundance) ; hist(model_data_ab$logAbundance) ; hist(model_data_ab$sqrtRescaledAbundance)

plot(density(model_data_ab$logAbundance)) 

# Have a look at sample sizes
table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity)

# Collapse intense and light land use intensities to have a more even spread of the data
model_data_ab <- 
  model_data_ab %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
# Have a look at sample sizes
table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity)
```


# Calculate stats template
```{r}
# Extract f ratio, df and p value
anova(x)

# Check residuals
hist(residuals(x))

# Check r2
r.squaredGLMM(x)

# Extract correlation coefficients
corr <- as.matrix(summary(x)$coefficients)

# Split the coefficients into two groups
x <- corr[2:8, 1] 
x <- corr[10:nrow(corr), 1] 

plot(x, x)
cor(x, x)

rm(col_eff, corr, dc_m2, dc_m4, dc_m5, dc_m6, dc_m7, dip_eff, dip_m2, coleoptera, diptera, diptera_coleoptera)

```

# Model template
```{r}
## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
x_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = x_m)

## Just land use as predictor
x_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = x_m)

## Just Higher_taxon as the predictor
x_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = x_m)

## Make a null, intercept only model
x_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = x_m)

## Compare the models
AIC(x_m, x_m4, x_m5, x_m6, x_m7)
model.sel(x_m, x_m5, x_m5, x_m6, x_m7)

# x still optimal

```


### Order comparisons for abundance


### Diptera


# diptera_hymenoptera abundance
```{r}
# Remove chubby datasets
rm(merged, diversity)

# Filter for studies that only compare hymenoptera and diptera
dip_hym_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies
diptera_hymenoptera <- model_data_ab %>% filter(SS %in% dip_hym_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Hymenoptera", "Diptera")) 

# maximal model
dhy_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hymenoptera)

# remove block
dhy_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# remove study
dhy_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hymenoptera)
  
# Compare models 
AIC(dhy_m1, dhy_m2, dhy_m3) # dhy_m2 best model

rm(dhy_m1, dhy_m3)

Anova(dhy_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dhy_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just land use as predictor
dhy_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just Higher_taxon as the predictor
dhy_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Make a null, intercept only model
dhy_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Compare the models
AIC(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)
model.sel(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)

# dhy_m2 still the best

# model estimates
summary(dhy_m2)
anova(dhy_m2)

```

### Simulate diptera_hymenoptera effects
```{r}
# Predict Diptera effects
dip_eff <- predict_this_model(dhy_m2, order = "Diptera")

# relevel model with hymenoptera as reference level
diptera_hymenoptera <- within(diptera_hymenoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model
hym_1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# Predict hymenoptera effects
hym_eff <- predict_this_model(hym_1, order = "Hymenoptera")

# Combine effects and plot them
diptera_hymenoptera_plot_AB <- combine_and_plot(dip_eff, hym_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(dhy_m2)

# Check residuals
hist(residuals(dhy_m2))

# Check r2
r.squaredGLMM(dhy_m2)

# Extract correlation coefficients
corr_dip_hym <- as.matrix(summary(dhy_m2)$coefficients)

# Split the coefficients into the two orders
diptera <- corr_dip_hym[2:8, 1]
hymenoptera <- corr_dip_hym[10:nrow(corr_dip_hym), 1] 

# Plot the coefficients
plot(diptera, hymenoptera)
cor(diptera, hymenoptera)


rm(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7, hym_1, hym_eff, diptera_hymenoptera, dip_eff, corr_dip_hym, diptera, hymenoptera)
    
```

# diptera_coleoptera abundance
```{r}

# Studies
dip_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

## Backwards stepwise selection of random effects 

# Model data
diptera_coleoptera <- model_data_ab %>% filter(SS %in% dip_col_ss) %>% filter(Order %in% c("Diptera", "Coleoptera")) 

# maximal model
dc_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_coleoptera)

# remove block
dc_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_coleoptera)

# remove study
dc_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_coleoptera)

# Compare models 
AIC(dc_m1, dc_m2, dc_m3) # dc_m2 best model

rm(dc_m1, dc_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dc_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Just land use as predictor
dc_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Just Higher_taxon as the predictor
dc_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Make a null, intercept only model
dc_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Compare the models
AIC(dc_m2, dc_m4, dc_m5, dc_m6, dc_m7)
model.sel(dc_m2, dc_m4, dc_m5, dc_m6, dc_m7)

# dc_m2 still optimal
model_plot(dc_m2)

# model estimates
summary(dc_m2)

```

### Simulate diptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(dc_m2, order = "Coleoptera")

# relevel model with Diptera as reference level
diptera_coleoptera <- within(diptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Diptera"))

# maximal model
dip_m2 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_coleoptera)

model_plot(dip_m2)

# Predict Diptera effects - remember that this overwrites previous effects of Diptera model
dip_eff <- predict_this_model(dip_m2, order = "Diptera")

# Combine effects and relevel Diptera as reference
diptera_coleoptera_plot_AB <- combine_and_plot(dip_eff, col_eff, relevel = "Diptera", diversity = "Abundance")

# Extract f ratio, df and p value
anova(dc_m2)

# Check residuals
hist(residuals(dc_m2))

# Check r2
r.squaredGLMM(dc_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(dc_m2)$coefficients)

# Split the coefficients into two groups
coleoptera <- corr[2:8, 1] 
diptera <- corr[10:nrow(corr), 1] 

plot(coleoptera, diptera)
cor(coleoptera, diptera)

rm(col_eff, corr, dc_m2, dc_m4, dc_m5, dc_m6, dc_m7, dip_eff, dip_m2, coleoptera, diptera, diptera_coleoptera)

```



# diptera_hemiptera abundance
```{r}
# Studies
dip_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_hemiptera <- model_data_ab %>% filter(SS %in% dip_hemi_ss) %>% filter(Order %in% c("Diptera", "Hemiptera")) 

# maximal model
dh_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

# remove block
dh_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hemiptera)

# remove study
dh_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

# Compare models 
AIC(dh_m1, dh_m2, dh_m3) # dh_m1 best model

rm(dh_m2, dh_m3)

# model estimates
summary(dh_m1)
Anova(dh_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dh_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = diptera_hemiptera)

## Just land use as predictor
dh_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1 | SSB), data = diptera_hemiptera)

## Just Higher_taxon as the predictor
dh_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = diptera_hemiptera)

## Make a null, intercept only model
dh_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS) + (1 | SSB), data = diptera_hemiptera)

## Compare the models
AIC(dh_m1, dh_m4, dh_m5, dh_m6, dh_m7)
model.sel(dh_m1, dh_m4, dh_m5, dh_m6, dh_m7)

# dh_m1 still optimal
model_plot(dh_m1)
```
### Simulate diptera_hemiptera effects
```{r}
# Predict Diptera effects 
dip_eff <- predict_this_model(dh_m1, order = "Diptera")

# relevel model with Hemiptera as reference level
diptera_hemiptera <- within(diptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
hemi_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

model_plot(hemi_m1)
summary(hemi_m1)
Anova(hemi_m1)

# Predict Hemiptera effects 
hemi_eff <- predict_this_model(hemi_m1, order = "Hemiptera")

# Combine effects and plot
diptera_hemiptera_plot_AB <- combine_and_plot(dip_eff, hemi_eff, diversity = "Abundance") 

# Extract f ratio, df and p value
anova(dh_m1)

# Check residuals
hist(residuals(dh_m1))

# Check r2
r.squaredGLMM(dh_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(dh_m1)$coefficients)

# Split the coefficients into two groups
diptera <- corr[2:8, 1] 
hemiptera <- corr[10:nrow(corr), 1] 

plot(diptera, hemiptera)
cor(diptera, hemiptera)

rm(corr, dh_m1, dh_m4, dh_m5, dh_m6, dh_m7, dip_eff, diptera_hemiptera, hemi_eff, hemi_m1, diptera, hemiptera)

```

# diptera_lepidoptera abundance
```{r}
# Studies
dip_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
diptera_lepidoptera <- model_data_ab %>% filter(SS %in% dip_lep_ss) %>% filter(Order %in% c("Diptera", "Lepidoptera")) 

# maximal model
dl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_lepidoptera)

# remove block
dl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_lepidoptera)

# remove study
dl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

# Compare models 
AIC(dl_m1, dl_m2, dl_m3) # dl_m2 best model

model_plot(dl_m2)

rm(dl_m1, dl_m3)

# model estimates
summary(dl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just land use as predictor
dl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just Higher_taxon as the predictor
dl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Make a null, intercept only model
dl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Compare the models
AIC(dl_m2, dl_m4, dl_m5, dl_m6, dl_m7)
model.sel(dl_m2, dl_m4, dl_m5, dl_m6, dl_m7)

# dl_m2 still optimal

# model estimates
summary(dl_m2)

```
### Simulate diptera_lepidoptera effects
```{r}
# Predict Diptera effects 
dip_eff <- predict_this_model(dl_m2, order = "Diptera")

# relevel model with Lepidoptera as reference level
diptera_lepidoptera <- within(diptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
diptera_lepidoptera_plot_AB <- combine_and_plot(dip_eff, lep_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(dl_m2)

# Check residuals
hist(residuals(dl_m2))

# Check r2
r.squaredGLMM(dl_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(dl_m2)$coefficients)

# Split the coefficients into two groups
diptera <- corr[2:8, 1] 
lepidoptera <- corr[10:nrow(corr), 1] 

plot(diptera, lepidoptera)
cor(diptera, lepidoptera)

rm(col_eff, corr, dl_m2, dl_m4, dl_m5, dl_m6, dl_m7, lep_eff, dip_eff, lep_m1, lepidoptera, diptera, diptera_lepidoptera)
```

## Hymenoptera

# hymenoptera_coleoptera abundance
```{r}
hym_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_coleoptera <- model_data_ab %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) 

# maximal model
hc_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# remove block
hc_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

# remove study
hc_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m2 best model

rm(hc_m1, hc_m3)

model_plot(hc_m2)

# model estimates
summary(hc_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Compare the models
AIC(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)

# hc_m2 still optimal
model_plot(hc_m2)

# model estimates
summary(hc_m2)
```
### Simulate hymenoptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(hc_m2, order = "Coleoptera")

# relevel model with Hymenoptera as reference level
hymenoptera_coleoptera <- within(hymenoptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

model_plot(hym_m1)
summary(hym_m1)
Anova(hym_m1)

# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hym_m1, order = "Hymenoptera")

# Combine effects and plot
hymenoptera_coleoptera_plot_AB <- combine_and_plot(col_eff, hym_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(hc_m2)

# Check residuals
hist(residuals(hc_m2))

# Check r2
r.squaredGLMM(hc_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(hc_m2)$coefficients)

# Split the coefficients into two groups
coleoptera <- corr[2:8, 1] 
hymenoptera <- corr[10:nrow(corr), 1] 

plot(coleoptera, hymenoptera)
cor(coleoptera, hymenoptera)

rm(col_eff, corr, hc_m2, hc_m4, hc_m5, hc_m6, hc_m7, hym_eff, hym_m1, coleoptera, hymenoptera, hymenoptera_coleoptera)
```

# hymenoptera_hemiptera abundance
```{r}
# Studies
hym_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_hemiptera <- model_data_ab %>% filter(SS %in% hym_hemi_ss) %>% filter(Order %in% c("Hymenoptera", "Hemiptera")) 

# maximal model
hh_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_hemiptera)

# remove block
hh_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_hemiptera)

# remove study
hh_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_hemiptera)

# Compare models 
AIC(hh_m1, hh_m2, hh_m3) # hh_m1 best model

model_plot(hh_m1)

rm(hh_m2, hh_m3)

# model estimates
summary(hh_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hh_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hymenoptera_hemiptera)

## Just land use as predictor
hh_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hymenoptera_hemiptera)

## Just Higher_taxon as the predictor
hh_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hymenoptera_hemiptera)

## Make a null, intercept only model
hh_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS) + (1 | SSB), data = hymenoptera_hemiptera)

## Compare the models
AIC(hh_m1, hh_m4, hh_m5, hh_m6, hh_m7)
model.sel(hh_m1, hh_m4, hh_m5, hh_m6, hh_m7)

# hh_m1 still optimal

```
### Simulate hymenoptera_hemiptera effects
```{r}
# Predict Hemiptera effects 
hem_eff <- predict_this_model(hh_m1, order = "Hemiptera")

# relevel model with Hymenoptera as reference level
hymenoptera_hemiptera <- within(hymenoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hymenoptera_hemiptera)

model_plot(hym_m1)
summary(hym_m1)
anova(hym_m1)

# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hym_m1, order = "Hymenoptera")

# Combine effects and plot
hymenoptera_hemiptera_plot_AB <- combine_and_plot(hem_eff, hym_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(hh_m1)

# Check residuals
hist(residuals(hh_m1))

# Check r2
r.squaredGLMM(hh_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(hh_m1)$coefficients)

# Split the coefficients into two groups
hemiptera <- corr[2:8, 1] 
hymenoptera <- corr[10:nrow(corr), 1] 

plot(hemiptera, hymenoptera)
cor(hemiptera, hymenoptera)

rm(hem_eff, corr, hh_m1, hh_m4, hh_m5, hh_m6, hh_m7, hym_eff, hym_m1, hemiptera, hymenoptera, hymenoptera_hemiptera)
```

# hymenoptera_lepidoptera abundance
```{r}
# Studies
hym_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_lepidoptera <- model_data_ab %>% filter(SS %in% hym_lep_ss) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera")) 

# maximal model
hl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_lepidoptera)

# remove block
hl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

# remove study
hl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m2 best model

model_plot(hl_m2)

rm(hl_m1, hl_m3)

# model estimates
summary(hl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Compare the models
AIC(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m2 still optimal
```
### Simulate hymenoptera_lepidoptera effects
```{r}
# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hl_m2, order = "Hymenoptera")

# relevel model with Lepidoptera as reference level
hymenoptera_lepidoptera <- within(hymenoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
hymenoptera_lepidoptera_plot_AB <- combine_and_plot(hym_eff, lep_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(hl_m2)

# Check residuals
hist(residuals(hl_m2))

# Check r2
r.squaredGLMM(hl_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(hl_m2)$coefficients)

# Split the coefficients into two groups
hymenoptera <- corr[2:8, 1] 
lepidoptera <- corr[10:nrow(corr), 1] 

plot(hymenoptera, lepidoptera)
cor(hymenoptera, lepidoptera)

rm(hym_eff, corr, hl_m2, hl_m4, hl_m5, hl_m6, hl_m7, lep_eff, lep_m1, hymenoptera, lepidoptera, hymenoptera_lepidoptera)
```

## Hemiptera

# hemiptera_lepidoptera abundance
```{r}
# Studies
hemi_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hemiptera_lepidoptera <- model_data_ab %>% filter(SS %in% hemi_lep_ss) %>% filter(Order %in% c("Hemiptera", "Lepidoptera"))

# maximal model
hl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_lepidoptera)

# remove block
hl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_lepidoptera)

# remove study
hl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m1 best model

model_plot(hl_m1)
rm(hl_m2, hl_m3)

# model estimates
summary(hl_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_lepidoptera)

## Compare the models
AIC(hl_m1, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m1, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m1 still optimal
```
### Simulate hemiptera_lepidoptera effects
```{r}
# Predict Hemiptera effects 
hem_eff <- predict_this_model(hl_m1, order = "Hemiptera")

# relevel model with Lepidoptera as reference level
hemiptera_lepidoptera <- within(hemiptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hemiptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
hemiptera_lepidoptera_plot_AB <- combine_and_plot(hem_eff, lep_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(hl_m1)

# Check residuals
hist(residuals(hl_m1))

# Check r2
r.squaredGLMM(hl_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(hl_m1)$coefficients)

# Split the coefficients into two groups
hemiptera <- corr[2:8, 1] 
lepidoptera <- corr[10:nrow(corr), 1] 

plot(hemiptera, lepidoptera)
cor(hemiptera, lepidoptera)

rm(hem_eff, corr, hl_m1, hl_m4, hl_m5, hl_m6, hl_m7, lep_eff, lep_m1, hemiptera, lepidoptera, hemiptera_lepidoptera)
```

# hemiptera_coleoptera abundance
```{r}
# Studies
hemi_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hemiptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hemiptera_coleoptera <- model_data_ab %>% filter(SS %in% hemi_col_ss) %>% filter(Order %in% c("Hemiptera", "Coleoptera")) 

# maximal model
hc_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_coleoptera)

# remove block
hc_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_coleoptera)

# remove study
hc_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m1 best model

model_plot(hc_m1)

rm(hc_m2, hc_m3)

# model estimates
summary(hc_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS) + (1 | SSB), data = hemiptera_coleoptera)

## Compare the models
AIC(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7)

# hc_m1 still optimal
```
### Simulate hemiptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(hc_m1, order = "Coleoptera")

# relevel model with Hemiptera as reference level
hemiptera_coleoptera <- within(hemiptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
hem_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hemiptera_coleoptera)

summary(hem_m1)
Anova(hem_m1)

# Predict Hemiptera effects 
hem_eff <- predict_this_model(hem_m1, order = "Hemiptera")

# Combine effects and plot
hemiptera_coleoptera_plot_AB <- combine_and_plot(col_eff, hem_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(hc_m1)

# Check residuals
hist(residuals(hc_m1))

# Check r2
r.squaredGLMM(hc_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(hc_m1)$coefficients)

# Split the coefficients into two groups
coleoptera <- corr[2:8, 1] 
hemiptera <- corr[10:nrow(corr), 1] 

plot(coleoptera, hemiptera)
cor(coleoptera, hemiptera)

rm(col_eff, corr, hc_m1, hc_m4, hc_m5, hc_m6, hc_m7, hem_eff, hem_m1, coleoptera, hemiptera, hemiptera_coleoptera)
```


## Coleoptera

### coleoptera_lepidoptera abundance
```{r}
# Studies
col_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
coleoptera_lepidoptera <- model_data_ab %>% filter(SS %in% col_lep_ss) %>% filter(Order %in% c("Coleoptera", "Lepidoptera"))

# maximal model
cl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_lepidoptera)

# remove block
cl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_lepidoptera)

# remove study
cl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_lepidoptera)

# Compare models 
AIC(cl_m1, cl_m2, cl_m3) # cl_m1 best model

model_plot(cl_m1)

rm(cl_m2, cl_m3)

# model estimates
summary(cl_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = coleoptera_lepidoptera)

## Just land use as predictor
cl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1 | SSB), data = coleoptera_lepidoptera)

## Just Higher_taxon as the predictor
cl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1 | SSB), data = coleoptera_lepidoptera)

## Make a null, intercept only model
cl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS) + (1 | SSB), data = coleoptera_lepidoptera)

## Compare the models
AIC(cl_m1, cl_m4, cl_m5, cl_m6, cl_m7)
model.sel(cl_m1, cl_m4, cl_m5, cl_m6, cl_m7)

# cl_m1 still optimal
```
### Simulate coleoptera_lepidoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(cl_m1, order = "Coleoptera")

# relevel model with Lepidoptera as reference level
coleoptera_lepidoptera <- within(coleoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = coleoptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
coleoptera_lepidoptera_plot_AB <- combine_and_plot(col_eff, lep_eff, diversity = "Abundance")

# Extract f ratio, df and p value
anova(cl_m1)

# Check residuals
hist(residuals(cl_m1))

# Check r2
r.squaredGLMM(cl_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(cl_m1)$coefficients)

# Split the coefficients into two groups
coleoptera <- corr[2:8, 1] 
lepidoptera <- corr[10:nrow(corr), 1] 

plot(coleoptera, lepidoptera)
cor(coleoptera, lepidoptera)

rm(col_eff, corr, cl_m1, cl_m4, cl_m5, cl_m6, cl_m7, lep_eff, lep_m1, coleoptera, lepidoptera, coleoptera_lepidoptera)
```


### Order comparisons for Species Richness

### Prepare the model data
```{r}
# Log transform species richness
model_data_sr$logSR <- log(model_data_sr$SpeciesRichness + 1)

# Check the distributions
hist(model_data_sr$SpeciesRichness) ; hist(model_data_sr$logSR) ; hist(model_data_ab$logAbundance) ; hist(log(model_data_ab$TotalAbundance + 1))

# Have a look at sample sizes
table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)

# Collapse intense and light land use intensities to have a more even spread of the data
model_data_sr <- 
  model_data_sr %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
# Have a look at sample sizes
table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)
```

## Diptera

# diptera_hymenoptera species richness
```{r}

# Studies
dip_hym_ss_sr <-  model_data_sr %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Its the same sets of studies for abundance and richness so I don't need to recalculate the studies for species richness data
cbind(dip_hym_ss_sr, dip_hym_ss) %>% View()

# Model data
diptera_hymenoptera <- model_data_sr %>% filter(SS %in% dip_hym_ss_sr) %>% filter(Order %in% c("Diptera", "Hymenoptera"))

# maximal model
dhy_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hymenoptera)

# remove block
dhy_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# remove study
dhy_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hymenoptera)

# Compare models 
AIC(dhy_m1, dhy_m2, dhy_m3) # dhy_m2 best model

model_plot(dhy_m2)

rm(dhy_m1, dhy_m3)

summary(dhy_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dhy_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just land use as predictor
dhy_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just Higher_taxon as the predictor
dhy_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Make a null, intercept only model
dhy_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Compare the models
AIC(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)
model.sel(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)

# dhy_m2 still the best
```
### Simulate diptera_hymenoptera effects
```{r}
# Predict Diptera effects
dip_eff <- predict_this_model(dhy_m2, order = "Diptera")

# relevel model with hymenoptera as reference level
diptera_hymenoptera <- within(diptera_hymenoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# Predict hymenoptera effects
hym_eff <- predict_this_model(hym_m1, order = "Hymenoptera")

# Combine effects and plot them
diptera_hymenoptera_plot_SR <- combine_and_plot(dip_eff, hym_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(dhy_m2)

# Check residuals
hist(residuals(dhy_m2))

# Check r2
r.squaredGLMM(dhy_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(dhy_m2)$coefficients)

# Split the coefficients into two groups
diptera <- corr[2:8, 1] 
hymenoptera <- corr[10:nrow(corr), 1] 

plot(diptera, hymenoptera)
cor(diptera, hymenoptera)

rm(dip_eff, corr, dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7, hym_eff, hym_m1, hymenoptera, diptera, diptera_hymenoptera)
```

# diptera_coleoptera species richness
```{r}
# Model data
diptera_coleoptera <- model_data_sr %>% filter(SS %in% dip_col_ss) %>% filter(Order %in% c("Diptera", "Coleoptera")) 

# maximal model
dc_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_coleoptera)

# remove block
dc_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_coleoptera)

# remove study
dc_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_coleoptera)

# Compare models 
AIC(dc_m1, dc_m2, dc_m3) # dc_m2 best model

model_plot(dc_m2)
rm(dc_m1, dc_m3)

# model estimates
summary(dc_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dc_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Just land use as predictor
dc_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Just Higher_taxon as the predictor
dc_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Make a null, intercept only model
dc_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = diptera_coleoptera)

## Compare the models
AIC(dc_m2, dc_m4, dc_m5, dc_m6, dc_m7)
model.sel(dc_m2, dc_m4, dc_m5, dc_m6, dc_m7)

# dc_m7 (null intercept only) has lower AIC than dc_m2 
```
### Simulate diptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(dc_m2, order = "Coleoptera")

# relevel model with Diptera as reference level
diptera_coleoptera <- within(diptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Diptera"))

# maximal model
dip_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_coleoptera)

model_plot(dip_m1)
summary(dip_m1)
Anova(dip_m1)

# Predict Diptera effects - remember that this overwrites previous effects of Diptera model
dip_eff <- predict_this_model(dip_m1, order = "Diptera")

# Combine effects and relevel Diptera as reference
diptera_coleoptera_plot_SR <- combine_and_plot(dip_eff, col_eff, relevel = "Diptera", diversity = "Species_richness")

# Extract f ratio, df and p value
anova(dc_m2)

# Check residuals
hist(residuals(dc_m2))

# Check r2
r.squaredGLMM(dc_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(dc_m2)$coefficients)

# Split the coefficients into two groups
col <- corr[2:8, 1] 
dip <- corr[10:nrow(corr), 1] 

plot(col, dip)
cor(col, dip)

rm(col_eff, corr, dc_m2, dc_m4, dc_m5, dc_m6, dc_m7, dip_eff, dip_m1, col, dip, diptera_coleoptera)
```

# diptera_hemiptera species richness
```{r}
# Model data
diptera_hemiptera <- model_data_sr %>% filter(SS %in% dip_hemi_ss) %>% filter(Order %in% c("Diptera", "Hemiptera")) 

# maximal model
dh_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

# remove block
dh_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hemiptera)

# remove study
dh_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

# Compare models 
AIC(dh_m1, dh_m2, dh_m3) # dh_m3 best model

model_plot(dh_m3)

rm(dh_m1, dh_m2)

# model estimates
summary(dh_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dh_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID), data = diptera_hemiptera)

## Just land use as predictor
dh_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID), data = diptera_hemiptera)

## Just Higher_taxon as the predictor
dh_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID), data = diptera_hemiptera)

## Make a null, intercept only model
dh_m7 <- lmer(logSR ~ (1 | Source_ID), data = diptera_hemiptera)

## Compare the models
AIC(dh_m3, dh_m4, dh_m5, dh_m6, dh_m7)
model.sel(dh_m3, dh_m4, dh_m5, dh_m6, dh_m7)

# dh_m3 still optimal
```
### Simulate diptera_hemiptera effects
```{r}
# Predict Diptera effects 
dip_eff <- predict_this_model(dh_m3, order = "Diptera")

# relevel model with Hemiptera as reference level
diptera_hemiptera <- within(diptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
hemi_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

model_plot(hemi_m1)
summary(hemi_m1)
Anova(hemi_m1)

# Predict Hemiptera effects 
hemi_eff <- predict_this_model(hemi_m1, order = "Hemiptera")

# Combine effects and plot
diptera_hemiptera_plot_SR <- combine_and_plot(dip_eff, hemi_eff, diversity = "Species_richness") 

# Extract f ratio, df and p value
anova(dh_m3)

# Check residuals
hist(residuals(dh_m3))

# Check r2
r.squaredGLMM(dh_m3)

# Extract correlation coefficients
corr <- as.matrix(summary(dh_m3)$coefficients)

# Split the coefficients into two groups
dip <- corr[2:8, 1] 
hemi <- corr[10:nrow(corr), 1] 

plot(dip, hemi)
cor(dip, hemi)

rm(hemi_eff, corr, dh_m3, dh_m4, dh_m5, dh_m6, dh_m7, dip_eff, hemi_m1, dip, hemi, diptera_hemiptera)
```

# diptera_lepidoptera species richness
```{r}

# Model data
diptera_lepidoptera <- model_data_sr %>% filter(SS %in% dip_lep_ss) %>% filter(Order %in% c("Diptera", "Lepidoptera")) 

# maximal model
dl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_lepidoptera)

# remove block
dl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_lepidoptera)

# remove study
dl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

# Compare models 
AIC(dl_m1, dl_m2, dl_m3) # dl_m3 best model

model_plot(dl_m3)
rm(dl_m2, dl_m1)

# model estimates
summary(dl_m3)
Anova(dl_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID), data = diptera_lepidoptera)

## Just land use as predictor
dl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID), data = diptera_lepidoptera)

## Just Higher_taxon as the predictor
dl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID), data = diptera_lepidoptera)

## Make a null, intercept only model
dl_m7 <- lmer(logSR ~ (1 | Source_ID), data = diptera_lepidoptera)

## Compare the models
AIC(dl_m3, dl_m4, dl_m5, dl_m6, dl_m7)
model.sel(dl_m3, dl_m4, dl_m5, dl_m6, dl_m7)

# dl_m6 has lower AIC than dl_m3
```
### Simulate diptera_lepidoptera effects
```{r}
# Predict Diptera effects 
dip_eff <- predict_this_model(dl_m3, order = "Diptera")

# relevel model with Lepidoptera as reference level
diptera_lepidoptera <- within(diptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
diptera_lepidoptera_plot_SR <- combine_and_plot(dip_eff, lep_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(dl_m3)

# Check residuals
hist(residuals(dl_m3))

# Check r2
r.squaredGLMM(dl_m3)

# Extract correlation coefficients
corr <- as.matrix(summary(dl_m3)$coefficients)

# Split the coefficients into two groups
dip <- corr[2:8, 1] 
lep <- corr[10:nrow(corr), 1] 

plot(dip, lep)
cor(dip, lep)

rm(dip_eff, corr, dl_m3, dl_m4, dl_m5, dl_m6, dl_m7, lep_eff, lep_m1, dip, lep, diptera_lepidoptera)
```


## Hymenoptera

# hymenoptera_coleoptera species richness
```{r}
# Model data
hymenoptera_coleoptera <- model_data_sr %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) 

# maximal model
hc_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# remove block
hc_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

# remove study
hc_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m2 best model

model_plot(hc_m2)
rm(hc_m1, hc_m3)

# model estimates
summary(hc_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Compare the models
AIC(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)

# hc_m2 still optimal

```
### Simulate hymenoptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(hc_m2, order = "Coleoptera")

# relevel model with Hymenoptera as reference level
hymenoptera_coleoptera <- within(hymenoptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

model_plot(hym_m1)
summary(hym_m1)
Anova(hym_m1)

# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hym_m1, order = "Hymenoptera")

# Combine effects and plot
hymenoptera_coleoptera_plot_SR <- combine_and_plot(col_eff, hym_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(hc_m2)

# Check residuals
hist(residuals(hc_m2))

# Check r2
r.squaredGLMM(hc_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(hc_m2)$coefficients)

# Split the coefficients into two groups
col <- corr[2:8, 1] 
hym <- corr[10:nrow(corr), 1] 

plot(col, hym)
cor(col, hym)

rm(col_eff, corr, hc_m2, hc_m4, hc_m5, hc_m6, hc_m7, hym_eff, hym_m1, col, hym, hymenoptera_coleoptera)
```

# hymenoptera_hemiptera species richness
```{r}
# Model data
hymenoptera_hemiptera <- model_data_sr %>% filter(SS %in% hym_hemi_ss) %>% filter(Order %in% c("Hymenoptera", "Hemiptera")) 

# maximal model
hh_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_hemiptera)

# remove block
hh_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_hemiptera)

# remove study
hh_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_hemiptera)

# Compare models 
AIC(hh_m1, hh_m2, hh_m3) # hh_m2 best model

model_plot(hh_m2)
rm(hh_m1, hh_m3)

# model estimates
summary(hh_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hh_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just land use as predictor
hh_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just Higher_taxon as the predictor
hh_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Make a null, intercept only model
hh_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Compare the models
AIC(hh_m2, hh_m4, hh_m5, hh_m6, hh_m7)
model.sel(hh_m2, hh_m4, hh_m5, hh_m6, hh_m7)

# hh_m2 still optimal

```
### Simulate hymenoptera_hemiptera effects
```{r}
# Predict Hemiptera effects 
hem_eff <- predict_this_model(hh_m2, order = "Hemiptera")

# relevel model with Hymenoptera as reference level
hymenoptera_hemiptera <- within(hymenoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_hemiptera)

model_plot(hym_m1)
summary(hym_m1)
Anova(hym_m1)

# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hym_m1, order = "Hymenoptera")

# Combine effects and plot
hymenoptera_hemiptera_plot_SR <- combine_and_plot(hem_eff, hym_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(hh_m2)

# Check residuals
hist(residuals(hh_m2))

# Check r2
r.squaredGLMM(hh_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(hh_m2)$coefficients)

# Split the coefficients into two groups
hemi <- corr[2:8, 1] 
hym <- corr[10:nrow(corr), 1] 

plot(hemi, hym)
cor(hemi, hym)

rm(hem_eff, corr, hh_m2, hh_m4, hh_m5, hh_m6, hh_m7, hym_eff, hym_m1, hemi, hym, hymenoptera_hemiptera)
```

# hymenoptera_lepidoptera species_richness
```{r}
# Model data
hymenoptera_lepidoptera <- model_data_sr %>% filter(SS %in% hym_lep_ss) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera")) 

# maximal model
hl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_lepidoptera)

# remove block
hl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

# remove study
hl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m2 best model

model_plot(hl_m2)
rm(hl_m1, hl_m3)

# model estimates
summary(hl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Compare the models
AIC(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m2 still optimal
```
### Simulate hymenoptera_lepidoptera effects
```{r}
# Predict Hymenoptera effects 
hym_eff <- predict_this_model(hl_m2, order = "Hymenoptera")

# relevel model with Lepidoptera as reference level
hymenoptera_lepidoptera <- within(hymenoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
hymenoptera_lepidoptera_plot_SR <- combine_and_plot(hym_eff, lep_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(hl_m2)

# Check residuals
hist(residuals(hl_m2))

# Check r2
r.squaredGLMM(hl_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(hl_m2)$coefficients)

# Split the coefficients into two groups
hym <- corr[2:8, 1] 
lep <- corr[10:nrow(corr), 1] 

plot(hym, lep)
cor(hym, lep)

rm(hym_eff, corr, hl_m2, hl_m4, hl_m5, hl_m6, hl_m7, lep_eff, lep_m1, hym, lep, hymenoptera_lepidoptera)
```


## Hemiptera

# hemiptera_lepidoptera species richness
```{r}
# Model data
hemiptera_lepidoptera <- model_data_sr %>% filter(SS %in% hemi_lep_ss) %>% filter(Order %in% c("Hemiptera", "Lepidoptera")) 

# maximal model
hl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_lepidoptera)

# remove block
hl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_lepidoptera)

# remove study
hl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m3 best model

model_plot(hl_m3)
rm(hl_m2, hl_m1)

# model estimates
summary(hl_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID), data = hemiptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID), data = hemiptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID), data = hemiptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logSR ~ (1 | Source_ID), data = hemiptera_lepidoptera)

## Compare the models
AIC(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m3 still optimal
```
### Simulate hemiptera_lepidoptera effects
```{r}
# Predict Hemiptera effects 
hem_eff <- predict_this_model(hl_m3, order = "Hemiptera")

# relevel model with Lepidoptera as reference level
hemiptera_lepidoptera <- within(hemiptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
hemiptera_lepidoptera_plot_SR <- combine_and_plot(hem_eff, lep_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(hl_m3)

# Check residuals
hist(residuals(hl_m3))

# Check r2
r.squaredGLMM(hl_m3)

# Extract correlation coefficients
corr <- as.matrix(summary(hl_m3)$coefficients)

# Split the coefficients into two groups
hemi <- corr[2:8, 1] 
lep <- corr[10:nrow(corr), 1] 

plot(hemi, lep)
cor(hemi, lep)

rm(hem_eff, corr, hl_m3, hl_m4, hl_m5, hl_m6, hl_m7, lep_eff, lep_m1, hemi, lep, hemiptera_lepidoptera)
```

# hemiptera_coleoptera species_richness
```{r}
# Model data
hemiptera_coleoptera <- model_data_sr %>% filter(SS %in% hemi_col_ss) %>% filter(Order %in% c("Hemiptera", "Coleoptera")) 

# maximal model
hc_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_coleoptera)

# remove block
hc_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_coleoptera)

# remove study
hc_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m1 best model

model_plot(hc_m1)
rm(hc_m2, hc_m3)

# model estimates
summary(hc_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS) + (1|SSB), data = hemiptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS) + (1|SSB), data = hemiptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS) + (1|SSB), data = hemiptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS) + (1|SSB), data = hemiptera_coleoptera)

## Compare the models
AIC(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7)

# hc_m1 still optimal
```
### Simulate hemiptera_coleoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(hc_m1, order = "Coleoptera")

# relevel model with Hemiptera as reference level
hemiptera_coleoptera <- within(hemiptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
hem_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hemiptera_coleoptera)

model_plot(hem_m1)
summary(hem_m1)
Anova(hem_m1)

# Predict Hemiptera effects 
hem_eff <- predict_this_model(hem_m1, order = "Hemiptera")

# Combine effects and plot
hemiptera_coleoptera_plot_SR <- combine_and_plot(col_eff, hem_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(hc_m1)

# Check residuals
hist(residuals(hc_m1))

# Check r2
r.squaredGLMM(hc_m1)

# Extract correlation coefficients
corr <- as.matrix(summary(hc_m1)$coefficients)

# Split the coefficients into two groups
col <- corr[2:8, 1] 
hemi<- corr[10:nrow(corr), 1] 

plot(col, hemi)
cor(col, hemi)

rm(col_eff, corr, hc_m1, hc_m4, hc_m5, hc_m6, hc_m7, hem_eff, hem_m1, col, hemi, hemiptera_coleoptera)
```


## Coleoptera

# coleoptera_lepidoptera species richness
```{r}
# Model data
coleoptera_lepidoptera <- model_data_sr %>% filter(SS %in% col_lep_ss) %>% filter(Order %in% c("Coleoptera", "Lepidoptera")) 

# maximal model
cl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_lepidoptera)

# remove block
cl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_lepidoptera)

# remove study
cl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_lepidoptera)

# Compare models 
AIC(cl_m1, cl_m2, cl_m3) # cl_m2 best model

model_plot(cl_m2)
rm(cl_m1, cl_m3)

# model estimates
summary(cl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1 | SS), data = coleoptera_lepidoptera)

## Just land use as predictor
cl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1 | SS), data = coleoptera_lepidoptera)

## Just Higher_taxon as the predictor
cl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1 | SS), data = coleoptera_lepidoptera)

## Make a null, intercept only model
cl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1 | SS), data = coleoptera_lepidoptera)

## Compare the models
AIC(cl_m2, cl_m4, cl_m5, cl_m6, cl_m7)
model.sel(cl_m2, cl_m4, cl_m5, cl_m6, cl_m7)

# cl_m2 still optimal
```
### Simulate coleoptera_lepidoptera effects
```{r}
# Predict Coleoptera effects 
col_eff <- predict_this_model(cl_m2, order = "Coleoptera")

# relevel model with Lepidoptera as reference level
coleoptera_lepidoptera <- within(coleoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_lepidoptera)

model_plot(lep_m1)
summary(lep_m1)
Anova(lep_m1)

# Predict Lepidoptera effects 
lep_eff <- predict_this_model(lep_m1, order = "Lepidoptera")

# Combine effects and plot
coleoptera_lepidoptera_plot_SR <- combine_and_plot(col_eff, lep_eff, diversity = "Species_richness")

# Extract f ratio, df and p value
anova(cl_m2)

# Check residuals
hist(residuals(cl_m2))

# Check r2
r.squaredGLMM(cl_m2)

# Extract correlation coefficients
corr <- as.matrix(summary(cl_m2)$coefficients)

# Split the coefficients into two groups
col <- corr[2:8, 1] 
lep <- corr[10:nrow(corr), 1] 

plot(col, lep)
cor(col, lep)

rm(col_eff, corr, cl_m2, cl_m4, cl_m5, cl_m6, cl_m7, lep_eff, lep_m1, col, lep, coleoptera_lepidoptera)
```

# Calculate number of sites for each comparison of orders
```{r}
# Sites

# Doesn't matter if we filter model_data_ab or model_data_sr as they contain the same studies

# dip_hym
dip_hym_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Diptera", "Hymenoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# dip_col
dip_col_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Diptera", "Coleoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# dip_hemi
dip_hemi_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Diptera", "Hemiptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# dip_lep
dip_lep_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Diptera", "Lepidoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# hym_col
hym_col_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# hym_hemi
hym_hemi_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# hym_lep
hym_lep_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# hemi_col
hemi_col_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Hemiptera", "Coleoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# hemi_lep
hemi_lep_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()

# col_lep
col_lep_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 2) %>% pull(SSBS) %>% unique()
```


## GGSAVE
```{r}
dip_col <- ggarrange(diptera_coleoptera_plot_AB, diptera_coleoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/dip_col.png", dip_col, height = 7, width = 7)

dip_hemi <- ggarrange(diptera_hemiptera_plot_AB, diptera_hemiptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/dip_hemi.png", dip_hemi, height = 7, width = 7)

dip_hym <- ggarrange(diptera_hymenoptera_plot_AB, diptera_hymenoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/dip_hym.png", dip_hym, height = 7, width = 7)
     
dip_lep <- ggarrange(diptera_lepidoptera_plot_AB, diptera_lepidoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/dip_lep.png", dip_lep, height = 7, width = 7)         

hym_lep <- ggarrange(hymenoptera_lepidoptera_plot_AB, hymenoptera_lepidoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/hym_lep.png", hym_lep, height = 7, width = 7)    

hym_hemi <- ggarrange(hymenoptera_hemiptera_plot_AB, hymenoptera_hemiptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/hym_hemi.png", hym_hemi, height = 7, width = 7)    

hym_col <- ggarrange(hymenoptera_coleoptera_plot_AB, hymenoptera_coleoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/hym_col.png", hym_col, height = 7, width = 7)    

hemi_lep <- ggarrange(hemiptera_lepidoptera_plot_AB, hemiptera_lepidoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/hemi_lep.png", hemi_lep, height = 7, width = 7)  

hemi_col <- ggarrange(hemiptera_coleoptera_plot_AB, hemiptera_coleoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/hemi_col.png", hemi_col, height = 7, width = 7)    

col_lep <- ggarrange(coleoptera_lepidoptera_plot_AB, coleoptera_lepidoptera_plot_SR, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/updated_figures/col_lep.png", col_lep, height = 7, width = 7)  
```

### Calculate number of studies and sites for 5/4 order model
```{r}

# 36 studies, 579 sites that compare all five orders
five_ss <- model_data_ab %>% dplyr::select(SS, Order) %>% unique() %>% group_by(SS) %>% tally() %>% filter(n == 5) %>% pull(SS) %>% unique()
five_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 5) %>% pull(SSBS) %>% unique()
# Subset our model data for studies that include all five orders
all_five <- model_data_ab %>% filter(SS %in% five_ss) 

# 21 studies, 375 sites that compare 4 orders
four_ss <- model_data_ab %>% dplyr::select(SS, Order) %>% unique() %>% group_by(SS) %>% tally() %>% filter(n == 4) %>% pull(SS) %>% unique()
all_four <- model_data_ab %>% filter(SS %in% four_ss) 
four_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n == 4) %>% pull(SSBS) %>% unique()

# 57 studies and 954 sites that compare >= 4 orders
fourplus_ss <- model_data_ab %>% dplyr::select(SS, Order) %>% unique() %>% group_by(SS) %>% tally() %>% filter(n >= 4) %>% pull(SS) %>% unique()
fourplus_studies <- model_data_ab %>% filter(SS %in% fourplus_ss)
fourplus_ssbs <- model_data_ab %>% dplyr::select(SSBS, Order) %>% unique() %>%  group_by(SSBS) %>% 
  tally() %>% filter(n >= 4) %>% pull(SSBS) %>% unique()

```

# Land use design of the sites for each of the five orders
```{r}
table(model_data_ab$Order, model_data_ab$Predominant_land_use) %>% View()
```

