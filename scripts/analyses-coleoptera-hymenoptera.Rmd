---
title: "SR_models"
author: "Justin Isip"
date: '2022-08-01'
output: html_document
---


### Clear the workspace
```{r}
rm(list=ls())
```

### Load required packages
```{r}
library(tidyverse) # data processing
library(lme4) # for mixed effects models
library(car) # for getting anova tables with significance values
library(DHARMa) # for model criticism plots
library(MuMIn) # for checking explanatory power of mixed effects models
library(sjPlot) # for visualising results
library(effects) # for extracting model effects
library(merTools) # useful for a few things, but we're using it for extracting estimates for plotting
library(emmeans) # testing multiple comparisons (but also useful for plotting)
library(coefplot) # visualising model coefficients
library(cli)
```

### Load in model plot function
```{r}

## Load in a model criticism function - this function is used for checking the residual/model diagnostic plots to test that the model is meeting all of its assumptions
model_plot <-function(mod.for.plot){
  require(lattice)
  
  # set up a 2 x 2 grid for plotting
  par(mfrow = c(2,2))
  par(ask = TRUE)
  
  # qqplot
  qqnorm(resid(mod.for.plot))
  qqline(resid(mod.for.plot), col = 2)
  
  # residuals vs fitted plot
  plot(fitted(mod.for.plot), resid(mod.for.plot),xlab = "Fitted Values", ylab = "Residuals", main = "Residuals vs fitted")
  abline(h=0, lty=2)
  lines(smooth.spline(fitted(mod.for.plot), resid(mod.for.plot)), col = "red")
  
  # histogram of residuals
  hist(resid(mod.for.plot))
  
  # random effects distribution
  dotplot(ranef(mod.for.plot,condVar = TRUE))
}
```

### Load add_order_fold function to split the diversity data into exclusive insect orders 
```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  #
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Flies"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Beetles"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Butterflies"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Bugs"
    data$order_fold[data$Higher_taxon == "Odonata" &
                    data$Higher_taxon == "Trichoptera" &
                    data$Higher_taxon == "Ephemeroptera" &
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Class == "Insecta" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherInsects"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

### Load function to calculate total abundance for each site x order_fold combination
```{r}

get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
  # Was throwing up error messages about convergence so I got rid of line 168 from the function
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
    # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance)) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

### Load all other functions
```{r}
source("/Applications/PhD/Andy/data_prep_functions.R")
source("/Applications/PhD/Andy/site_comparison_functions.R")
```

### Read in the data
```{r}
diversity <- readRDS("../data/diversity-2022-04-13-02-33-10.rds")
```

### Correct for sampling effort
```{r}
if(check_sampling_effort_nas(diversity) ==
   FALSE) stop("Some studies have NA for sampling effort in only some sites!")

diversity <- correct_for_sampling_effort(diversity)
print(summarise_diversity(diversity))
```

### Merge sites
```{r}
merged <- merge_sites(diversity, verbose = TRUE) 
```

### Filter merged sites for multi-group studies on insects only
```{r}
insects <-
  merged %>%
  filter(Class == "Insecta") %>% # filter only for insects
  group_by(SS) %>% # group by SS
  mutate(
    Multiple_groups = 
      case_when(
        (length(unique(Higher_taxon))) > 1 ~ "YES",
        (length(unique(Higher_taxon))) == 1 ~ "NO")) %>% # for each study create a new column called multiple groups = YES/NO - 
  # YES if there's more than one unique higher taxon within that study, NO if not
  # Filter the data for studies with multiple groups
  filter(Multiple_groups == "YES") %>% # filter for only the rows for studies (YES) with multiple groups
  ungroup() %>% 
  droplevels()
```

### Add_order_fold to allow taxonomic cross-validation and split insects into exclusive groups
```{r}
# Split insects into flies, beetles, butterflies, hymenoptera, bugs, aquatics and other insects 
insects <- add_order_fold(insects, verbose = TRUE)
```

### Calculate site level diversity metrics using get_site_abundances_order and order_fold for each site x order combination
```{r}
fold_abundances <- get_site_abundances_order(insects, 
                                  order_folds = TRUE, verbose = TRUE)

# There are 10571 sites because there are 10571 rows and each row is a site x order combination 

table(fold_abundances$order_fold) # number of rows for each site x order combination

```

### Fix up your explanatory variables 
```{r}

# Rename predominant habitat since its not really habitat we're looking at
fold_abundances <- rename(fold_abundances,
                Predominant_land_use = Predominant_habitat)


# Relevel the land use and use intensity classes
fold_abundances <- fold_abundances %>%
  
  mutate(
    
    # collapse primary forest and non-forest together into primary vegetation as these aren't well distinguished
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Primary forest" = "Primary", 
                                         "Primary non-forest" = "Primary"),
    
    # indeterminate secondary veg and cannot decide get NA
    Predominant_land_use = na_if(Predominant_land_use, "Secondary vegetation (indeterminate age)"),
    Predominant_land_use = na_if(Predominant_land_use, "Cannot decide"),
    Use_intensity = na_if(Use_intensity, "Cannot decide"),
    
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# take a look at the LandUse/Use intensity split
table(fold_abundances$Predominant_land_use, fold_abundances$Use_intensity)

```

### Complete cases
```{r}
model_data_ab <- drop_na(fold_abundances, 
                         RescaledAbundance, Predominant_land_use,
                         Use_intensity)

model_data_sr <- drop_na(fold_abundances, 
                         SpeciesRichness, Predominant_land_use,
                         Use_intensity)

```

### Prepare the coleoptera vs hymenoptera dataframe (abundance)
```{r}

# Log transform rescaled abundance
model_data_ab$logAbundance <- log(model_data_ab$RescaledAbundance + 1)

# Subset abundance data for coleoptera and hymenoptera
coleoptera_hymenoptera_ab <-
  model_data_ab %>%
  filter(Higher_taxon == "Hymenoptera" | Higher_taxon == "Coleoptera") %>%
  droplevels()

# Check the distributions
hist(coleoptera_hymenoptera_ab$RescaledAbundance) ; hist(coleoptera_hymenoptera_ab$logAbundance)

# Have a look at sample sizes
table(coleoptera_hymenoptera_ab$Predominant_land_use, coleoptera_hymenoptera_ab$Use_intensity)

# Collapse land uses and use intensities to have a more even spread of the data
coleoptera_hymenoptera_ab <- 
  coleoptera_hymenoptera_ab %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                  "Young secondary vegetation" = "Secondary", 
                                  "Intermediate secondary vegetation" = "Secondary",
                                  "Mature secondary vegetation" = "Secondary"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# Have a look at sample sizes
table(coleoptera_hymenoptera_ab$Predominant_land_use, coleoptera_hymenoptera_ab$Use_intensity)
```

### Backwards stepwise model selection of abundance for coleoptera vs hymenoptera
```{r}

# Check the data for collinearity
source("https://highstat.com/Books/Book2/HighstatLibV10.R")

corvif(coleoptera_hymenoptera_ab[ , c("Predominant_land_use", "Use_intensity", "Higher_taxon")]) 

# Everything is under 3!

# Create your maximal model with all the variables and interactions
col_hym_ab1 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = coleoptera_hymenoptera_ab
  )

# Definitions of interactions:

#   Predominant_land_use:Higher_taxon - does the difference in abundance between land uses depend on higher taxon?

# Predominant_land_use:Use_intensity - does the difference in abundance between land uses depend on use intensity?

# Use_intensity:Higher_taxon - does the difference in abundance between use intensities depend on higher taxon?


# Check model plots!
model_plot(col_hym_ab1)
```

### Choose the optimum random effects structure (abundance)
```{r} 
# Remove SSB
col_hym_ab2 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_hymenoptera_ab
  )

#model_plot(col_hym_ab2)

# Remove SS
col_hym_ab3 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID),
    data = coleoptera_hymenoptera_ab
  )

#model_plot(col_hym_ab3)

# Compare models using AIC
AIC(col_hym_ab1, col_hym_ab2, col_hym_ab3)

# col_hym_ab1 is the optimum model (all of the random effects) 
```

### Choose the optimum fixed effects structure (abundance)
```{r}

# Have a look at the significance of the terms

Anova(col_hym_ab1) 

# Use_intensity:Higher_taxon is not a significant interaction in the model so we can remove this term 

# Model simplification
col_hym_ab1.1 <- update(col_hym_ab1,~.- Use_intensity:Higher_taxon)

# Test to see if I've lost a significant amount of explanatory power by removing this interaction

# The test I'll use is a likelihood ratio test (LRT)
anova(col_hym_ab1.1, col_hym_ab1)

# The LRT is not significant, so by removing this interaction from the model, I have not lost a significant amount of explanatory power. This means I can keep the simpler model (without the Use_intensity:Higher_taxon interaction). 

# Check the Anova table again for the next most complicated, least significant term.

Anova(col_hym_ab1.1) # All of the remaining interactions and terms are significant.

# Therefore col_hym_ab1.1 is our minimum adequate model but not our maximal model as we dropped the interaction between Use_intensity:Higher_taxon

# now lets look at the model estimates
summary(col_hym_ab1.1)

# Let's make a coefficients table of the model
sjPlot::tab_model(col_hym_ab1.1, 
                  show.re.var= TRUE)

# Visualise model coefficients
coefplot(col_hym_ab1.1)

# Let's make a coefficients table of the model
sjPlot::plot_model(col_hym_ab1.1, type = "int") ; sjPlot::plot_model(col_hym_ab1.1) 

sjPlot::plot_model(col_hym_ab1.1, type ="pred") 

```

### Prepare the coleoptera vs hymenoptera dataframe (species richness)
```{r}

# First, lets log transform species richness
model_data_sr$logSR <- log(model_data_sr$SpeciesRichness + 1)

# Compare the distributions for the overall SR dataset
hist(model_data_sr$SpeciesRichness); hist(model_data_sr$logSR) 

# data is still right skewed despite log transforming, proceed with caution

# Subset for coleoptera and hymenoptera
coleoptera_hymenoptera_sr <-
  model_data_sr %>%
  filter(Higher_taxon == "Hymenoptera" | Higher_taxon == "Coleoptera") %>%
  droplevels()

# Compare the distributions just for coleoptera vs hymenoptera
hist(coleoptera_hymenoptera_sr$SpeciesRichness); hist(coleoptera_hymenoptera_sr$logSR)


# Have a look at sample sizes
table(coleoptera_hymenoptera_sr$Predominant_land_use, coleoptera_hymenoptera_sr$Use_intensity)

# There are very few sites for some land use x use intensity combinations
# I will collapse some so we have enough sites
# Lets collapse light and intense use so that we have minimal versus high use
# Lets also collapse the three secondary vegetation categories into one category called secondary

coleoptera_hymenoptera_sr <- 
  coleoptera_hymenoptera_sr %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                  "Young secondary vegetation" = "Secondary", 
                                  "Intermediate secondary vegetation" = "Secondary",
                                  "Mature secondary vegetation" = "Secondary"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
  
# Have a look at sample sizes
table(coleoptera_hymenoptera_sr$Predominant_land_use, coleoptera_hymenoptera_sr$Use_intensity)

# Ok things look better now, all combinations have over 100 sites
# except pasture (minimal use) which has 63 sites
```

### Backwards stepwise model selection of species richness for coleoptera vs hymenoptera
```{r}

# Check the data for collinearity

corvif(coleoptera_hymenoptera_sr[ , c("Predominant_land_use", "Use_intensity", "Higher_taxon")]) 

# Everything is under 3!

# Create your maximal model with all the variables and interactions
col_hym_sr1 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = coleoptera_hymenoptera_sr
  )

# Check model plots!
model_plot(col_hym_sr1)
```

### Choose the optimum random effects structure (SR)
```{r}

# Remove SSB
col_hym_sr2 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_hymenoptera_sr
  )

#model_plot(col_hym_sr2)

# Remove SS
col_hym_sr3 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID),
    data = coleoptera_hymenoptera_sr
  )

#model_plot(col_hym_sr3)

# Compare models using AIC
AIC(col_hym_sr1, col_hym_sr2, col_hym_sr3)

# col_hym_sr2 has the lowest AIC value (only Source_ID and SS as a random effect, but not SSB) 
# and is therefore the optimum model
```

### Choose the best fixed effects structure (SR)
```{r}
# Have a look at the significance of the terms

Anova(col_hym_sr2) 
# Predominant_land_use:Use_intensity is not a significant interaction in the model so we can remove this term 

# Model simplification
col_hym_sr2.1 <- update(col_hym_sr2,~.- Predominant_land_use:Use_intensity)

# Test to see if I've lost a significant amount of explanatory power by removing this interaction

# The test I'll use is a likelihood ratio test (LRT)
anova(col_hym_sr2.1, col_hym_sr2)

# The LRT is not significant, so by removing this interaction from the model, I have not lost a significant amount of explanatory power. This means I can keep the simpler model (without the Predominant_land_use:Use_intensity interaction). 

# Check the Anova table again for the next most complicated, least significant term.
Anova(col_hym_sr2.1) 

# Use intensity is not a significant fixed effect in our model, but the interaction between use intensity:higher_taxon is significant, therefore we cannot remove use intensity. Everything left in the model is significant, therefore col_hym_sr2.1 is our minimum adequate model.

# Look at the model estimates
summary(col_hym_sr2.1) 
# Source_ID is accounting for a lot of the variation

# Let's make a coefficients table of the model
sjPlot::tab_model(col_hym_sr2.1, 
                  show.re.var= TRUE)

# Visualise model coefficients
coefplot(col_hym_sr2.1)
sjPlot::plot_model(col_hym_sr2.1, type = "int") ; sjPlot::plot_model(col_hym_sr2.1) 
sjPlot::plot_model(col_hym_sr2.1, type ="pred") 
```

### Prepare the lepidoptera vs diptera dataframe (abundance)
```{r}

# Subset abundance data for lepidoptera and diptera
lepidoptera_diptera_ab <-
  model_data_ab %>%
  filter(Higher_taxon == "Lepidoptera" | Higher_taxon == "Diptera") %>%
  droplevels()

# Check the distributions
hist(lepidoptera_diptera_ab$RescaledAbundance) ; hist(lepidoptera_diptera_ab$logAbundance)

# Have a look at sample sizes
table(lepidoptera_diptera_ab$Predominant_land_use, lepidoptera_diptera_ab$Use_intensity)

# Collapse land uses and use intensities to have a more even spread of the data
lepidoptera_diptera_ab <- 
  lepidoptera_diptera_ab %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                  "Young secondary vegetation" = "Secondary", 
                                  "Intermediate secondary vegetation" = "Secondary",
                                  "Mature secondary vegetation" = "Secondary"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# Have a look at sample sizes
table(lepidoptera_diptera_ab$Predominant_land_use, lepidoptera_diptera_ab$Use_intensity) 

# Everything is reasonable, 62 sites for minimal use pasture but should be ok!
```

### Backwards stepwise model selection of abundance for lepidoptera vs diptera
```{r}

# Check the data for collinearity
source("https://highstat.com/Books/Book2/HighstatLibV10.R")

corvif(lepidoptera_diptera_ab[ , c("Predominant_land_use", "Use_intensity", "Higher_taxon")]) # Everything is under 3, A ok!

# Create your maximal model with all the variables and interactions
lep_dip_ab1 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = lepidoptera_diptera_ab
  )

# Definitions of interactions:
# Predominant_land_use:Higher_taxon - does the difference in species richness between land uses depend on higher taxon?
# Predominant_land_use:Use_intensity - does the difference in species richness between land uses depend on use intensity?
# Use_intensity:Higher_taxon - does the difference in species richness between use intensities depend on higher taxon?


# Check model plots!
model_plot(lep_dip_ab1)

# Choose the best random effects

# Remove SSB
lep_dip_ab2 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = lepidoptera_diptera_ab
  )

model_plot(lep_dip_ab2)

# Remove SS
lep_dip_ab3 <-
  lmer(
    logAbundance ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID),
    data = lepidoptera_diptera_ab
  )

model_plot(lep_dip_ab3)

# Compare models using AIC
AIC(lep_dip_ab1, lep_dip_ab2, lep_dip_ab3)

# lep_dip_ab2 is the best model, with Source_ID and SS as a random effect but no SSB, but only just by 1.5 AIC value..

# Choose the best fixed effects structure

# Have a look at the significance of the terms
Anova(lep_dip_ab2) # Use_intensity:Higher_taxon is not a significant interaction in the model so we can remove this term 
                   # The response of leps to high use is not significantly different compared to dips in high use.

# Model simplification
lep_dip_ab2.1 <- update(lep_dip_ab2,~.- Use_intensity:Higher_taxon)

# Test to see if I've lost a significant amount of explanatory power by removing this interaction
# The test I'll use is a likelihood ratio test (LRT)
anova(lep_dip_ab2.1, lep_dip_ab2)

# The LRT is not significant, so by removing this interaction from the model, I have not lost a significant amount of
# explanatory power. This means I can keep the simpler model (without the Use_intensity:Higher_taxon interaction). 

# Check the Anova table again for the next most complicated, least significant term.
Anova(lep_dip_ab2.1) 

# Everything left in the model is significant, therefore lep_dip_ab2.1 is our minimum adequate model but not our maximal model as we dropped the interaction between Use_intensity:Higher_taxon.

# Look at the model estimates
summary(lep_dip_ab2.1)

# Let's make a coefficients table of the model
sjPlot::tab_model(lep_dip_ab2.1, 
                  show.re.var= TRUE)

# Visualise model coefficients
coefplot(lep_dip_ab2.1)
```

### Prepare the lepidoptera vs diptera dataframe (species richness)
```{r}

# Subset abundance data for lepidoptera and diptera
lepidoptera_diptera_sr <-
  model_data_sr %>%
  filter(Higher_taxon == "Lepidoptera" | Higher_taxon == "Diptera") %>%
  droplevels()

# Check the distributions
hist(lepidoptera_diptera_sr$SpeciesRichness) ; hist(lepidoptera_diptera_sr$logSR)

# Have a look at sample sizes
table(lepidoptera_diptera_sr$Predominant_land_use, lepidoptera_diptera_sr$Use_intensity)

# Collapse land uses and use intensities to have a more even spread of the data
lepidoptera_diptera_sr <- 
  lepidoptera_diptera_sr %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                  "Young secondary vegetation" = "Secondary", 
                                  "Intermediate secondary vegetation" = "Secondary",
                                  "Mature secondary vegetation" = "Secondary"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# Have a look at sample sizes
table(lepidoptera_diptera_sr$Predominant_land_use, lepidoptera_diptera_sr$Use_intensity) 

# Everything is reasonable, 62 sites for minimal use pasture but should be ok!
```

### Backwards stepwise model selection of abundance for lepidoptera vs diptera
```{r}

# Check the data for collinearity
source("https://highstat.com/Books/Book2/HighstatLibV10.R")

corvif(lepidoptera_diptera_sr[ , c("Predominant_land_use", "Use_intensity", "Higher_taxon")]) # Everything is under 3, A ok!

# Create your maximal model with all the variables and interactions
lep_dip_sr1 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = lepidoptera_diptera_sr
  )

# Definitions of interactions:
# Predominant_land_use:Higher_taxon - does the difference in species richness between land uses depend on higher taxon?
# Predominant_land_use:Use_intensity - does the difference in species richness between land uses depend on use intensity?
# Use_intensity:Higher_taxon - does the difference in species richness between use intensities depend on higher taxon?


# Check model plots!
model_plot(lep_dip_sr1)

# Choose the best random effects

# Remove SSB
lep_dip_sr2 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = lepidoptera_diptera_sr
  )

model_plot(lep_dip_sr2)

# Remove SS
lep_dip_sr3 <-
  lmer(
    logSR ~ Predominant_land_use + Use_intensity + Higher_taxon + Predominant_land_use:Higher_taxon +
      Predominant_land_use:Use_intensity + Use_intensity:Higher_taxon + (1 | Source_ID),
    data = lepidoptera_diptera_sr
  )

model_plot(lep_dip_sr3)

# Compare models using AIC
AIC(lep_dip_sr1, lep_dip_sr2, lep_dip_sr3)

# lep_dip_sr1 is the best model, with all of the random effects.

# Choose the best fixed effects structure

# Have a look at the significance of the terms
Anova(lep_dip_sr1) # Use_intensity:Higher_taxon is the least significant interaction in the model so we can remove this term 
                   # Predominant_land_use:Use_intensity is also just not significant
                   
# Model simplification
lep_dip_sr1.1 <- update(lep_dip_sr1,~.- Use_intensity:Higher_taxon)

# Test to see if I've lost a significant amount of explanatory power by removing this interaction
anova(lep_dip_sr1.1, lep_dip_sr1)

# The LRT is not significant, so by removing this interaction from the model, I have not lost a significant amount of
# explanatory power. This means I can keep the simpler model (without the Use_intensity:Higher_taxon interaction). 

# Check the Anova table again for the next most complicated, least significant term.
Anova(lep_dip_sr1.1) # Predominant_land_use:Use_intensity is not significant (just), lets see what happens when we remove it..

# Model simplification
lep_dip_sr1.2 <- update(lep_dip_sr1.1,~.- Predominant_land_use:Use_intensity)

# Test to see if I've lost a significant amount of explanatory power by removing this interaction
anova(lep_dip_sr1.2, lep_dip_sr1.1)

# The LRT is not significant, we can remove the interaction of Predominant_land_use:Use_intensity 

# Check the Anova table again for the next most complicated, least significant term.
Anova(lep_dip_sr1.2)

# Everything left in the model is significant, therefore lep_dip_sr1.2 is our minimum adequate model but not our maximal model as we dropped two interactions 1) Use_intensity:Higher_taxon 2) Predominant_land_use:Use_intensity.

# Look at the model estimates
summary(lep_dip_sr1.2)

# Let's make a coefficients table of the model
sjPlot::tab_model(lep_dip_sr1.2, 
                  show.re.var= TRUE)

# Visualise model coefficients
coefplot(lep_dip_sr1.2)
```

### Mess around code
```{r}
a <- fold_abundances %>% dplyr::select(SS, SSBS, SSBST, Predominant_habitat, Use_intensity, order_fold, the_order_folds)
b <- model_data_sr %>% dplyr::select(SS,SSBS, SSBST, Predominant_land_use, Use_intensity, 
                                     the_order_folds, SpeciesRichness, logSR,TotalAbundance, MaxAbundance, RescaledAbundance, 
                                     sqrtRescaledAbundance)
zero_SR <- model_data_sr %>% dplyr::select(SS,SSBS, SSBST, Predominant_land_use, Use_intensity, 
                                     the_order_folds, SpeciesRichness, logSR,TotalAbundance, MaxAbundance, RescaledAbundance, 
                                     sqrtRescaledAbundance) %>% filter(SpeciesRichness == 0)

sum(model_data_sr$SpeciesRichness == 0) # there are 2367 / 8354 sites with 0 species richness data
sum(model_data_ab$RescaledAbundance == 0) # there are 2367 / 8354 sites with 0 abundance data, same for all other abundance metrics
sum(model_data_sr$SpeciesRichness == 0)/nrow(model_data_sr) * 100 # 28% of sites have 0 for species richness

# model_data_sr$logSR <- log(model_data_sr$SpeciesRichness + 1) even though we + 1 for zeros, log(1) = 0, so we have sites with 0 
# species richness.

# Sites have zero species richness due to the taxon within a site not being resolved to species level. 

```

###
```{r}

```

###
```{r}

```

###
```{r}

```




