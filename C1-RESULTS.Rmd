---
title: "Untitled"
author: "Justin Isip"
date: "2024-02-20"
output: html_document
---

#### This markdown follows the one from scratch markdown, but will now create % difference in abundance and species richness plots for all the comparisons.

#### Clear the work space

```{r}
rm(list=ls())
```

#### Load required packages

```{r, include =FALSE}
library(tidyverse) # data processing
library(lme4) # for mixed effects models
library(car) # for getting anova tables with significance values
library(DHARMa) # for model criticism plots
library(MuMIn) # for checking explanatory power of mixed effects models
library(sjPlot) # for visualising results
library(effects) # for extracting model effects
library(merTools) # useful for a few things, but we're using it for extracting estimates for plotting
library(emmeans) # testing multiple comparisons (but also useful for plotting)
library(coefplot) # visualising model coefficients
library(lmerTest) # for p values and degrees of freedom from anova table
library(ggpubr) # arranging plots
```

#### Load add_order_fold function to split the diversity data into exclusive insect orders

```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Diptera"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Coleoptera"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Lepidoptera"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Hemiptera"
    data$order_fold[data$Higher_taxon == "Arachnida"] <- "Arachnida"
    data$order_fold[data$Higher_taxon == "Odonata" |
                    data$Higher_taxon == "Trichoptera" |
                    data$Higher_taxon == "Ephemeroptera" |
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Phylum == "Arthropoda" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Arachnida" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherArthropods"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

#### Load get_site_abundances_order function to calculate total abundance for each site x order_fold combination

```{r}
# Calculate total abundance for each site --------------------------------------
# Modified to clarify reporting is on site x fold combinations
get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
        # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance),
           MinNonZero = min(TotalAbundance[TotalAbundance > 0])) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
    # If a study reports abundance as a count, add 1 to all values; otherwise
  # add 1/2 the minimum non-zero value; then log-transform to get a useful
  # logAbundance value that may be more symmetric than sqrtRescaledAbundance.
  sites$to_add <- ifelse(sites$Diversity_metric_unit %in%
                           c("individuals", "times observed"), 1,
                         sites$MinNonZero/2)
  sites$logAbundance <- log(sites$TotalAbundance + sites$to_add)
  
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

#### Load all other functions

```{r}
source("/Applications/PhD/Andy/data_prep_functions.R")
source("/Applications/PhD/Andy/site_comparison_functions.R")
source("https://highstat.com/Books/Book2/HighstatLibV10.R") # collinearity
```

#### Read in the data

```{r}
diversity <- readRDS("./data/diversity-2023-09-14-02-33-21.rds")
```

#### Correct for sampling effort

```{r}
if(check_sampling_effort_nas(diversity) ==
   FALSE) stop("Some studies have NA for sampling effort in only some sites!")

diversity <- correct_for_sampling_effort(diversity)
print(summarise_diversity(diversity))
```

#### Merge sites
```{r}
merged <- merge_sites(diversity, verbose = TRUE) 

merged %>% filter(Class == "Insecta") %>%  dplyr::select(SS, Order, Sampling_method) %>%  View()

```

#### First, I will find the studies which contain data for multiple insect groups but subset at the source level, rather than the study level. 

#### The idea being that some sources may contain multiple separate studies with different sampling methods for different insect groups. 

#### An example could be, within a source, Study 1: Malaise traps for Diptera, Study 2: Pitfall traps for Coleoptera, Study 3: Sweep nets for Lepidoptera, these could be separate studies with different sampling methods within a source, but would have been conducted at the EXACT SAME set of sites and habitats. 

#### Therefore they are still precisely matched and suitable for my analysis. 

#### I may be missing data which has multiple groups subset at the source level but not at the study level, and this data would not be extracted if I subset ONLY at the study level.

```{r, warning = FALSE}
# Subset multiple orders at the source level
source_multiple <- merged %>% 
  filter(Higher_taxon %in% c("Diptera", "Coleoptera", "Lepidoptera", "Hymenoptera", "Hemiptera")) %>% 
  group_by(Source_ID) %>%  
  mutate(
    Multiple_groups = 
      case_when(
        (length(unique(Higher_taxon))) > 1 ~ "YES",
        (length(unique(Higher_taxon))) == 1 ~ "NO")) %>%  
  filter(Multiple_groups == "YES") %>% 
  droplevels()

# Subset multiple orders at the study level
ss_multiple <- merged %>% 
  filter(Higher_taxon %in% c("Diptera", "Coleoptera", "Lepidoptera", "Hymenoptera", "Hemiptera")) %>% 
  group_by(SS) %>%  
  mutate(
    Multiple_groups = 
      case_when(
        (length(unique(Higher_taxon))) > 1 ~ "YES",
        (length(unique(Higher_taxon))) == 1 ~ "NO")) %>%  
  filter(Multiple_groups == "YES") %>% 
  droplevels()



# Which data is subset at the source level but not at the study level?
source_only <- anti_join(source_multiple, ss_multiple, 
by = c("Source_ID", "SS", "Order", "Sampling_method", "Site_name", "Habitat_as_described", "Latitude", "Longitude")) 
# matching based on EXACT SAME site_name, habitat_as_described and lat/long coordinates!

# Simplify source level df for merging
source_only <- source_only %>%
  mutate(site_habitat_combo = paste(Site_name, Habitat_as_described),# Concatenate site and habitat_as_described
         lat_long_combo = paste(Latitude, Longitude)) %>% # Concatenate lat and long
  dplyr::select(Source_ID, SS, Order, Sampling_method, site_habitat_combo, lat_long_combo) %>% # Select the columns of interest
  unique()
  
# Simplify the study level df for merging
studies_only <- ss_multiple %>%
  mutate(site_habitat_combo = paste(Site_name, Habitat_as_described),
         lat_long_combo = paste(Latitude, Longitude)) %>% 
  dplyr::select(Source_ID, SS, Order, Sampling_method, site_habitat_combo, lat_long_combo) %>%
  unique()

# Merge the studies_only df and source_only df only by rows that have an EXACT MATCH in their values for site_habitat_combo (i.e have the EXACT same sites and habitats)
same_site_habitat <- inner_join(studies_only, source_only, by = c("site_habitat_combo", "lat_long_combo")) 

# the 10 additional studies subset at the source level 
same_site_habitat %>% dplyr::select(Source_ID.y, SS.y, Order.y, Sampling_method.y) %>% unique() 
# Check there's no missing lat/long or site/habitat data
sum(is.na(studies_only$lat_long_combo))
sum(is.na(source_only$site_habitat_combo))

# The unique studies in this column are the studies which have the EXACT same sites and habitats subset at the source level
data2add <- unique(same_site_habitat$SS.y) %>% droplevels()
print(data2add)

rm(same_site_habitat, source_only, studies_only)
```

#### Merge source level data with study level multi-group data

```{r}
# Filter for those additional studies subset at source level
source_multiple <- source_multiple %>% filter(SS %in% data2add) %>% droplevels() 

# Merge the additional 10 studies subset at the source level to the dataset subset at the study level
overall <- rbind(source_multiple, ss_multiple)

rm(source_multiple, ss_multiple, data2add, diversity)
```

#### Now that I have my overall dataset (with multiple insect groups subset at both the source and study level), I will update the sampling methods for a number of studies based on checking the source publication. The idea being that some studies in my dataset have an obscure/unspecified sampling method (e.g. specimen collection, systematic searching, various, multiple, mixed trap etc).

```{r}
# First ungroup the df
overall <- overall %>% ungroup()

```

```{r}
# Update the sampling methods
overall <- overall %>%
  mutate(Sampling_method = case_when(
    SS == "AD1_2002__Vazquez 1" ~ "flower visitation observation",
    SS == "AD1_2009__Vergara 1" ~ "flower visitation observation",
    SS == "AD1_2011__Bates 1" ~ "Pan traps/sweep nets/hand searching", # multiple
    SS == "AD1_2011__Weiner 1" ~ "flower visitation observation",
    SS == "AD1_2013__Grass 1" ~ "flower visitation observation",
    SS == "AR1_2008__Basset 1" ~ "Malaise traps/yellow pan traps/pitfall traps", # multiple
    SS == "CC1_2005__Barratt 1" ~ "soil sample",
    SS == "CC1_2005__Barratt 2" ~ "soil sample",
    SS == "CC1_2008__Schon 1" ~ "soil cores along transects",
    SS == "CC1_2008__Schon 2" ~ "soil cores along transects",
    SS == "CC1_2010__Schon 2" ~ "soil cores along transects",
    SS == "CC1_2012__Waite 2" ~ "bole traps/flight intercept trap/foliage sampling", # multiple
    SS == "CC1_2013__Litchwark 1" ~ "flower visitation observation",
    SS == "CC1_2014__Rader 1" ~ "flight intercept trap/pan trap", # multiple
    SS == "DG1_2012__Ge 1" ~ "soil cores along transects",
    SS == "GP1_2009__Vasconcelos 2" ~ "litter collection",
    SS == "HP1_2006__Lachat 1" ~ "Funnel pitfall traps/ malaise trap/flight intercept trap/pyramid shaped emergence trap", # multiple
    SS == "MH1_2009__Turner 1" ~ "Leaf litter sampling/ferns cut and bagged/fogging for canopy species", # multiple
    SS == "SC1_2005__Richardson 1" ~ "litter collection",
    SS == "SJ2_2019__Eckert 1" ~ "pit-fall traps", # multiple "Pitfall trapping/direct sampling (i.e. active searching) within quadrats" but didn't include direct sampling as not a PREDICTS sampling method
    SS == "VB1_2005__Eggleton 2" ~ "Hand sorting in quadrat and winkler bags", # multiple
    SS == "VB1_2012a_Carpenter 1" ~ "Soil cores/pitfall traps", # multiple
    SS == "VB1_2012__LeightonGoodall 1" ~ "Leaf litter sampling/soil sampling", # multiple
    SS == "GP1_2009__Vasconcelos 1" ~ "litter collection", # this study was subset at source level
    SS == "VB1_2012__Carpenter 5" ~ "soil sampling/litter collection/pitfall traps", # multiple - this study was subset at source level
    SS == "AD1_2006__Blanche 1" ~ "flower visitation observation",
    SS == "AD1_2006__Blanche 2" ~ "flower visitation observation",
    SS == "AD1_2007__Meyer 2" ~ "flower visitation observation",
    SS == "SH1_2011__Todd 1" ~ "flight intercept/pan trap/pitfall trap", # multiple
    SS == "VB1_2020__Burton 2" ~ "litter collection", # multiple
    TRUE ~ Sampling_method
  ))

# Merge similar methods, e.g. sweep netting and sweep net.
overall <- overall %>%
mutate(Sampling_method = recode_factor(Sampling_method,
                                       "sweep netting" = "sweep net", 
                                       # Combine sweep net and sweep netting
                                       "sweep_netting" = "sweep net",
                                       "soil core" = "soil sample",
                                      "soil cores along transects" = "soil sample", 
                            # Combine soil cores, soil cores along transect and soil sample
                                      "mixed traps" = "multiple", 
                                      # Combine mixed traps with multiple traps
                                      "window trap" = "flight trap" 
                            # Combine window trap with flight trap as they are the same thing
                                      ))
```

#### Some studies sample larvae, speaking with Gavin Broad (Entomologist at the NHM), you would only expect to find larvae in the soil, therefore all other instances of larvae caught with any sampling method other than soil sampling are bycatch. I will filter PREDICTS only for larvae sampled in the soil below.

```{r}
# Lets have a look at all instances of larvae
overall %>% 
  filter(grepl('larv|immatu|pupa|nymphe|nymph_', Taxon_name_entered, ignore.case = T)) %>% 
  # different words for larvae 
  dplyr::select(SS, Higher_taxon, Taxon_name_entered, Order, Genus, Species, Sampling_method) %>% 
  filter(Higher_taxon %in% c("Diptera", "Coleoptera", "Lepidoptera", " %>% enoptera", "Hemiptera")) %>%  # orders relevant to my analysis
  unique
```

```{r}
# Larvae_keep contains data only on larvae where they have been sampled appropriately in the soil.
larvae_keep <- overall %>%  
  filter(grepl('larv|immatu|pupa|nymphe|nymph_', Taxon_name_entered, ignore.case = T) & Sampling_method %in% 
           c("soil sample",
             "soil sampling/litter collection/pitfall traps",
             "Soil cores/pitfall traps",
             "Leaf litter sampling/soil sampling")) %>%  
              droplevels()

# Those studies that have multiple sampling methods including soil sampling, do not have many instances of larvae so it should not be a problem to include them.
```

#### Now, based on the expert spreadsheet sent over by Andrew (containing the sampling methods used by experts for their order(s) of interest). I will, for each sampling method, filter for the orders which are appropriately sampled, i.e. not bycatch.

```{r}

# active visual surveys good for all five orders
active_visual_surveys <- overall %>% 
  filter(Order %in% c("Lepidoptera", "Coleoptera", "Diptera", "Hymenoptera", "Hemiptera") 
      & Sampling_method %in% c("sweep net","aerial transect","flower visitation observation", 
      "visual encounter survey","systematic searching")) 
# these five PREDICTS methods constitute active visual surveys in the expert spreadsheet.


# light trap - good for all except Hemiptera
light_trap <- overall %>% filter(Order %in% c("Lepidoptera", "Coleoptera", "Diptera", "Hymenoptera") & Sampling_method == "light trap")

# pan trap - good for all
pan_trap <- overall %>% 
  filter(Order %in% c("Coleoptera", "Diptera", "Hymenoptera", "Hemiptera", "Lepidoptera") & Sampling_method %in% c("pan traps","Pan traps/sweep nets/hand searching","Malaise traps/yellow pan traps/pitfall traps","flight intercept trap/pan trap", "flight intercept/pan trap/pitfall trap"))

# You can see for pan traps there are examples of multiple sampling methods, when I merge all of the cleaned methods I will pass a function that will remove duplicate rows, so this won't be an issue.

# flight intercept / harp trap - good for Hymenoptera, Coleoptera and Diptera 
flight_trap <- overall %>% filter(Order %in% c("Coleoptera", "Hymenoptera", "Diptera") & Sampling_method %in% 
                                    c("flight trap",
                                      "bole traps/flight intercept trap/foliage sampling",
                                      "flight intercept trap/pan trap",
                                      "Funnel pitfall traps/ malaise trap/flight intercept trap/pyramid shaped emergence trap",
                                      "flight intercept/pan trap/pitfall trap",
                                      "harp trap"))

# Malaise trap - good for all except Lepidoptera
malaise_trap <- overall %>% filter(Order %in% c("Coleoptera", "Diptera", "Hymenoptera", "Hemiptera") & Sampling_method %in% c("malaise traps",
                                                                                                          "Malaise traps/yellow pan traps/pitfall traps",
                                                                  "Funnel pitfall traps/ malaise trap/flight intercept trap/pyramid shaped emergence trap"))


# Winkler bags or litter collection only good for beetles and ants, other groups bycatch. 
winkler_beetles <- overall %>% 
  filter(Order == "Coleoptera" & 
           Sampling_method %in% c("litter collection","soil sampling/litter collection/pitfall traps","Hand sorting in quadrat and winkler bags","Leaf litter sampling/ferns cut and bagged/fogging for canopy species","Leaf litter sampling/soil sampling"))

winkler_ants <- overall %>% 
  filter(Order == "Hymenoptera" & Family == "Formicidae" & 
           Sampling_method %in% c("litter collection","soil sampling/litter collection/pitfall traps","Hand sorting in quadrat and winkler bags","Leaf litter sampling/ferns cut and bagged/fogging for canopy species","Leaf litter sampling/soil sampling"))

# All expert methods have now been cleaned for non-bycatch data.
```

#### Some of the PREDICTS sampling methods could not be assigned to an expert sampling method. 

#### These include - "soil sampling", "trap nests", "bole trap", "suction samplers", "live traps" and "baited traps".

#### I will remove bycatch from these methods based on comms with Victoria Burton, Gavin Broad and Ben Woodcock. Also note, that where a study contained multiple sampling methods, if any of those multiple sampling methods was suitable for any of the groups then it was included.
```{r}
# Soil sample only good for ants, all other groups bycatch.
soil_sampling <- overall %>% 
  filter(Order == "Hymenoptera" & Family == "Formicidae" & 
           Sampling_method %in% c("soil sample","soil sampling/litter collection/pitfall traps","Soil cores/pitfall traps","Leaf litter sampling/soil sampling"))


# Glue trap good for Hymenoptera, Diptera and Hemiptera, other orders bycatch.
glue_trap <- overall %>% 
  filter(Order %in% c("Hymenoptera", "Diptera", "Hemiptera") & Sampling_method == "glue traps")

# Bole trap only good for Coleoptera and Hemiptera
bole_trap <- overall %>%  
  filter(Order %in% c("Coleoptera", "Hemiptera") & 
           Sampling_method %in% c("bole trap","bole traps/flight intercept trap/foliage sampling"))

# BW says suction samplers good for Coleoptera and Hemiptera but not Hymenoptera and Lepidoptera.
suction <- overall %>% filter(Order %in% c("Coleoptera", "Hemiptera") & Sampling_method == "suction samplers")

# Trap nests only good for Hymenoptera says VB.
trap_nests <- overall %>% filter(Order == "Hymenoptera" & Sampling_method == "trap nests")

# Pitfall traps good for only Coleoptera and ants says VB (surprisingly not good for Hemiptera) - includes baited-pitfall too
pitfall_beetles <- overall %>% filter(Order == "Coleoptera" & 
                                        Sampling_method %in% c("Funnel pitfall traps/ malaise trap/flight intercept trap/pyramid shaped emergence trap","Malaise traps/yellow pan traps/pitfall traps","Soil cores/pitfall traps","soil sampling/litter collection/pitfall traps", 
                                                              "pit-fall traps", 
                                                               "baited pit-fall traps", 
                                                               "flight intercept/pan trap/pitfall trap"))

pitfall_ants <- overall %>% filter(Order == "Hymenoptera" & Family == "Formicidae" 
                                   & Sampling_method %in% c("Funnel pitfall traps/ malaise trap/flight intercept trap/pyramid shaped emergence trap",
                                                               "Malaise traps/yellow pan traps/pitfall traps", 
                                                               "Soil cores/pitfall traps", 
                                                               "soil sampling/litter collection/pitfall traps", 
                                                               "pit-fall traps", 
                                                               "baited pit-fall traps", 
                                                               "flight intercept/pan trap/pitfall trap"))

# 2023 Smith is the only paper that uses baited-traps as a sampling method, Diptera and Hymenoptera are OK (Hymenoptera > 20% of the individuals) but Coleoptera, Hemiptera, and Lepidoptera bycatch. 
baited_trap <- overall %>% filter(Order %in% c("Diptera", "Hymenoptera") & Sampling_method == "baited traps") 

# Live traps (TN_1_2007_Bouyer 2 and TN_1_2007_Bouyer 3) all groups are appropriately sampled - checked source paper.
live_trap <- overall %>% filter(Sampling_method == "live traps")

# All non-expert methods have now been cleaned for non-bycatch data.
```

#### Now that I've removed bycatch from all of the sampling methods in PREDICTS, I will combine them with the appropriately sampled larvae data to have a cleaned multi-group dataset.

```{r}
clean <- bind_rows(active_visual_surveys,
                   baited_trap,
                   bole_trap,
                   flight_trap,
                   glue_trap,
                   larvae_keep,
                   light_trap,
                   live_trap,
                   malaise_trap,
                   pan_trap,
                   pitfall_ants,
                   pitfall_beetles,
                   soil_sampling,
                   suction,
                   trap_nests,
                   winkler_ants,
                   winkler_beetles) 

# Remove duplicate rows as some data will have been duplicated due to the studies with multiple sampling methods.
clean <- unique(clean)

# Relevel the 'Order' variable alphabetically due to rebinding
clean$Order <- factor(clean$Order, levels = sort(levels(clean$Order)))

# Relevel the 'Higher_taxon' variable alphabetically due to rebinding
clean$Higher_taxon <- factor(clean$Higher_taxon, levels = sort(levels(clean$Higher_taxon)))

# Tidy the environment
rm(active_visual_surveys,baited_trap,bole_trap,flight_trap,glue_trap,larvae_keep,light_trap,live_trap,malaise_trap,pan_trap,pitfall_ants,pitfall_beetles,soil_sampling,suction,trap_nests,winkler_ants,winkler_beetles)
```

#### Lets have a look at the appropriate sampling methods for each of the Orders.

```{r}
clean %>% group_by(Order) %>% reframe(Sampling_method) %>% unique() 
```

#### I will see if there are any sampling methods which are VALID for an Order if it was used in ANY study where that Order is the Order contributing most individuals to the data (not just the studies that have multiple orders).

```{r}
# This code lets me see which studies caught a lot of individuals for Hemiptera
merged %>% 
  filter(Class == "Insecta") %>% 
  dplyr::select(Source_ID, SS, Order, Sampling_method, Taxon_name_entered) %>% 
  unique() %>% 
  group_by(SS, Order, Sampling_method) %>% 
  summarise(Count = n()) %>%
  filter(Order == "Hemiptera")
```

#### Prepare model data

#### Load add_order_fold function to split the cleaned data into exclusive insect orders

```{r}

add_order_fold <- function(data, folds = "default", verbose = TRUE){
  
  # By default (and nothing else is yet coded up), this puts each row into
  # an insect order that each have a decent, number of rows of data. 
  # This allows site-level values to be obtained within
  # each of the order folds in turn.
  
  # Set up order_fold, a factor that holds the fold identity.
  data$order_fold <- rep(NA, nrow(data))
  
  # Rows are assigned to folds based on the higher taxonomy information.
  if (folds == "default"){
    data$order_fold[data$Higher_taxon == "Diptera"] <- "Diptera"
    data$order_fold[data$Higher_taxon == "Coleoptera"] <- "Coleoptera"
    data$order_fold[data$Higher_taxon == "Lepidoptera"] <- "Lepidoptera"
    data$order_fold[data$Higher_taxon == "Hymenoptera"] <- "Hymenoptera"
    data$order_fold[data$Higher_taxon == "Hemiptera"] <- "Hemiptera"
    data$order_fold[data$Higher_taxon == "Arachnida"] <- "Arachnida"
    data$order_fold[data$Higher_taxon == "Odonata" |
                    data$Higher_taxon == "Trichoptera" |
                    data$Higher_taxon == "Ephemeroptera" |
                    data$Higher_taxon == "Plecoptera" ] <- "Aquatics"
    data$order_fold[data$Phylum == "Arthropoda" & 
                      data$Higher_taxon != "Diptera" & 
                      data$Higher_taxon != "Coleoptera" &
                      data$Higher_taxon != "Lepidoptera" &
                      data$Higher_taxon != "Hymenoptera" &
                      data$Higher_taxon != "Hemiptera" &
                      data$Higher_taxon != "Arachnida" &
                      data$Higher_taxon != "Odonata" &
                      data$Higher_taxon != "Trichoptera" &
                      data$Higher_taxon != "Ephemeroptera" &
                      data$Higher_taxon != "Plecoptera"] <- "OtherArthropods"
  }else{
    stop("Only the default folds have been coded up so far!")
  }
  
  data$order_fold <- as.factor(data$order_fold)
  
  if (verbose == TRUE){
    # By default, report on the breakdown of records per fold.
    cat("Numbers of rows within each order fold are as follows:\n\n")
    print(table(data$order_fold))
  }
  
  return(data)
}

```

#### Load get_site_abundances_order function to calculate total abundance for each site x order_fold combination

```{r}
# Calculate total abundance for each site --------------------------------------
# Modified to clarify reporting is on site x fold combinations
get_site_abundances_order <- function(data, 
                                order_folds = FALSE,
                                verbose = TRUE){
  # This calculates site metrics for each site or, if desired, each order fold
  # within each site.
  
  # Make it a data frame to avoid having to deal with a tibble.
  data <- as.data.frame(data)
  
  # Set up a variable for uniquely identifying the site x order_fold combination
  # or, if order_folds == FALSE, the site. This is what grouping is then done
  # by.
  print(table(data$order_fold))
  
  if (order_folds == TRUE){
    data$the_order_folds <- data$order_fold
  }else{
    data$the_order_folds <- ""
  }
  
  # Just for debugging
  print(table(data$the_order_folds))
  
  # Start to calculate site-level metrics.
  sites <- data %>%
    
    # pull out only the merged diversity data
    distinct(merge_ID, .keep_all = TRUE) %>%
    
    # Re-make SSB and SSBS values since we've now dropped a bunch of values; and
    # also add SSBST which is that order x site combo. The trimws is because the
    # SSBST would otherwise end in a space if order_folds == FALSE.
    mutate(SS = paste(Source_ID, Study_number),
           SSB = paste(SS, Block),
           SSBS = paste(SSB, Site_number),
           SSBST = trimws(paste(SSBS, the_order_folds))) %>%
    
    # group by SSBST (each unique value corresponds to a unique site x fold)
    group_by(SSBST) %>%
    
    # Now add up all the abundance measurements within each site and also 
    # estimate coverage.
    mutate(TotalAbundance = ifelse(Diversity_metric_type == "Abundance",
                                   sum(merged_diversity, na.rm = TRUE),
                                   # If the diversity metric type isn't 
                                   # Abundance, then leave the TotalAbundance 
                                   # measurement as NA.
                                   NA),
           
           SpeciesRichness = ifelse(Diversity_metric_type == "Species richness",
                                    merged_diversity,
                                    # for abundance and occurrence measurements,
                                    # count the number of unique species names 
                                    # that are present at the site 
                                    n_distinct(Best_guess_binomial[merged_diversity > 0])),
           
           coverage = get.SC2(merged_diversity)) %>%
    
    # ungroup
    ungroup() %>%
    
    # pull out unique site/fold combinations.
    distinct(SSBST, .keep_all = TRUE) %>%
    
    # now group by Study ID and fold.
    group_by(SS, the_order_folds) %>%
    
        # pull out the maximum abundance for each study/fold combination.
    mutate(MaxAbundance = max(TotalAbundance),
           MinNonZero = min(TotalAbundance[TotalAbundance > 0])) %>%
    
    # ungroup.
    ungroup() %>%
    
    # now rescale total abundance, so that within each study, the maximum is 1.
    mutate(RescaledAbundance = TotalAbundance/MaxAbundance) %>%
    
    mutate(sqrtRescaledAbundance = sqrt(RescaledAbundance)) 
  
    # If a study reports abundance as a count, add 1 to all values; otherwise
  # add 1/2 the minimum non-zero value; then log-transform to get a useful
  # logAbundance value that may be more symmetric than sqrtRescaledAbundance.
  sites$to_add <- ifelse(sites$Diversity_metric_unit %in%
                           c("individuals", "times observed"), 1,
                         sites$MinNonZero/2)
  sites$logAbundance <- log(sites$TotalAbundance + sites$to_add)
  
  
  # Remove NA values and drop levels
  sites <- as.data.frame(sites)
  sites <- droplevels(subset(sites, !is.na(sqrtRescaledAbundance)))
  
  if (verbose == TRUE){
    # Summarise structure of site-level data frame
    cat("\nThere are abundance data for:\n")
    cat(paste("   ", sum(!is.na(sites$sqrtRescaledAbundance)), "sites, from\n"))
    cat(paste("   ", 
              length(unique(sites$SS[!is.na(sites$sqrtRescaledAbundance)])), 
              "studies and\n"))
    cat(paste("   ", 
              length(unique(sites$Source_ID[!is.na(sites$sqrtRescaledAbundance)])),
              "sources.\n"))
  }
  
  # Set provenance attributes
  attr(sites, which = "diversity_extract") <- 
    attr(data, which = "diversity_extract")
  attr(sites, which = "is_merged") <- attr(data, which = "is_merged")
  attr(sites, which = "order_folds") <- order_folds 
  attr(sites, which = "when_Created") <- Sys.time()
  
  return(sites)
}

```

#### Add_order_fold to allow taxonomic cross-validation

```{r}
# Just adds order_fold column
clean <- add_order_fold(clean, verbose = TRUE)
levels(clean$order_fold)

# Col = 159k, Dip = 26k, Hemi = 25k, Hym = 71k, Lep = 40k records.
```

#### Load in model plot function
```{r}
## Load in a model criticism function - this function is used for checking the residual/model diagnostic plots to test that the model is meeting all of its assumptions
model_plot <-function(mod.for.plot){
  require(lattice)
  
  # set up a 2 x 2 grid for plotting
  par(mfrow = c(2,2))
  par(ask = TRUE)
  
  # qqplot
  qqnorm(resid(mod.for.plot))
  qqline(resid(mod.for.plot), col = 2)
  
  # residuals vs fitted plot
  plot(fitted(mod.for.plot), resid(mod.for.plot),xlab = "Fitted Values", ylab = "Residuals", main = "Residuals vs fitted")
  abline(h=0, lty=2)
  lines(smooth.spline(fitted(mod.for.plot), resid(mod.for.plot)), col = "red")
  
  # histogram of residuals
  hist(resid(mod.for.plot))
  
  # random effects distribution
  dotplot(ranef(mod.for.plot,condVar = TRUE))
}
```

#### Collinearity
```{r}
source("https://highstat.com/Books/Book2/HighstatLibV10.R")
```



#### Calculate site level diversity metrics using get_site_abundances_order and order_fold for each site x order combination
```{r}

clean <- get_site_abundances_order(clean, order_folds = TRUE, verbose = TRUE)

table(clean$order_fold) # number of rows for each site x order combination
```

#### Fix up your explanatory variables

```{r}

# Rename predominant habitat since its not really habitat we're looking at
clean <- rename(clean,
                Predominant_land_use = Predominant_habitat)


# Relevel the land use and use intensity classes
clean <- clean %>%
  
  mutate(
    
    # collapse primary forest and non-forest together into primary vegetation as these aren't well distinguished
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Primary forest" = "Primary", 
                                         "Primary non-forest" = "Primary"),
    
    # indeterminate secondary veg and cannot decide get NA
   # Predominant_land_use = na_if(Predominant_land_use, "Secondary vegetation (indeterminate age)"), - removed as we are collapsing secondary
    Predominant_land_use = na_if(Predominant_land_use, "Cannot decide"), 
    Use_intensity = na_if(Use_intensity, "Cannot decide"),
    
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

# take a look at the LandUse/Use intensity split
table(clean$Predominant_land_use, clean$Use_intensity)
```

#### Collinearity

```{r}
source("https://highstat.com/Books/Book2/HighstatLibV10.R")
corvif(clean[ , c("Predominant_land_use", "Use_intensity")])
```

#### Complete cases

```{r}

# This will drop all the rows with NAs for abundance, land use or use intensity so we have complete data for modelling
model_data_ab <- drop_na(clean, 
                         logAbundance, Predominant_land_use,
                         Use_intensity)

model_data_sr <- drop_na(clean, 
                         SpeciesRichness, Predominant_land_use,
                         Use_intensity)
```

#### Prepare the abundance model dataframe
```{r}
# Check the distributions
hist(model_data_ab$RescaledAbundance) ; hist(model_data_ab$logAbundance) ; hist(model_data_ab$sqrtRescaledAbundance)

```

```{r}
# Have a look at sample sizes
table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity)

```

```{r}
# Collapse intense and light land use intensities to have a more even spread of the data
model_data_ab <- 
  model_data_ab %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )


table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity) # Only MSV HIGH USE (n = 73) and Pasture MINIMAL USE (n = 85) less than 100.

```

```{r}
# Relevel the land use and use intensity classes
model_data_ab <- model_data_ab %>%
  
  mutate(
    
    # collapse secondary age categories into one and include SV (indeterminate age)
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Young secondary vegetation" = "Secondary vegetation", 
                                         "Intermediate secondary vegetation" = "Secondary vegetation",
                                         "Mature secondary vegetation" = "Secondary vegetation",
                                         "Secondary vegetation (indeterminate age)" = "Secondary vegetation"),
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

table(model_data_ab$Predominant_land_use, model_data_ab$Use_intensity) # Only pasture minimal use (n = 85) is less than 100 sites.

```

```{r}
# Lets have a look at the order x land use split 
table(model_data_ab$Order, model_data_ab$Predominant_land_use) 
```

#### Prepare the SR model data
```{r}
# Log transform species richness
model_data_sr$logSR <- log(model_data_sr$SpeciesRichness + 1)

# Check the distributions
hist(model_data_sr$SpeciesRichness) ; hist(model_data_sr$logSR) 

# Have a look at sample sizes
table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)

# Collapse intense and light land use intensities to have a more even spread of the data
model_data_sr <- 
  model_data_sr %>%
  mutate(
    Use_intensity = recode_factor(Use_intensity,
                                  "Intense use" = "High_use",
                                  "Light use" = "High_use"),
# reset reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )
# Have a look at sample sizes
table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity)

# Relevel the land use and use intensity classes
model_data_sr <- model_data_sr %>%
  
  mutate(
    
    # collapse secondary age categories into one and include SV (indeterminate age)
    Predominant_land_use = recode_factor(Predominant_land_use, 
                                         "Young secondary vegetation" = "Secondary vegetation", 
                                         "Intermediate secondary vegetation" = "Secondary vegetation",
                                         "Mature secondary vegetation" = "Secondary vegetation",
                                         "Secondary vegetation (indeterminate age)" = "Secondary vegetation"),
    # set reference levels
    Predominant_land_use = factor(Predominant_land_use),
    Predominant_land_use = relevel(Predominant_land_use, ref = "Primary"),
    Use_intensity = factor(Use_intensity),
    Use_intensity = relevel(Use_intensity, ref = "Minimal use")
  )

table(model_data_sr$Predominant_land_use, model_data_sr$Use_intensity) # Only pasture minimal use (n = 85) is less than 100 sites.

# Lets have a look at the order x land use split again
table(model_data_sr$Order, model_data_sr$Predominant_land_use) 
```

#### Best way to proceed: Mick Crawley reckons an average of 30 data points to fit a parameter is comfy, 10 might work, and 3 if you're as lucky as a human can be. On that basis, I think you'll be fine - but obviously some combinations of order 1, order 2 and land use will be based on very few data indeed (so will have suitably wide CIs).

```{r, echo = T, results = "hide"}
# Lets look at Orders sampled under the same LUs and UIs
model_data_ab %>% dplyr::select(Source_ID, SS, Order, Sampling_method, Predominant_land_use, Use_intensity) %>% unique()

```

#### Are there any studies which only compare different stages of secondary vegetation? - as these would stop being informative now that I've collapsed secondary. This code groups the data by SS and then filters for studies where "all" specified SV LUs are present.

```{r}
clean %>%
  group_by(SS) %>% 
  filter(all(c("Young secondary vegetation", "Intermediate secondary vegetation", "Mature secondary vegetation") %in%   Predominant_land_use)) %>%  
  dplyr::select(SS, Predominant_land_use) %>% 
  unique() # looks like there are three studies which compare all three age categories of SV, but they also include non-SV land uses.
```

#### Lets summarise the cleaned dataset (without bycatch) now that we've prepped it for modelling

```{r}
length(unique(merged$SS)) # 975 studies in all of PREDICTS
length(unique(overall$SS)) # 113 for multi groups
length(unique(overall$SSBS)) # 4189 SITES for multi groups
# 106 SS for non bycatch multi groups before model prep
length(unique(clean$SS)) # 102 ss after model prep
length(unique(clean$SSBS)) # 2580 sites after model prep
```

#### Create land use categories and colours for plotting

```{r}
  # Land use levels
  comb_plot_limits <- c("Primary", "Secondary vegetation", "Plantation", "Pasture", "Cropland", "Urban") 

# Add specific colours for each order
group_colours <- c(Diptera = "#FFC300", Lepidoptera = "#ff5733", Hymenoptera = "#c70039", Hemiptera = "#197BBD", Coleoptera = "#581845") 
```






#### x vs x (template)

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare x and x
x_x_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("x", "x")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
x_x <- model_data_ab %>% filter(SS %in% x_x_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("x", "x")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
x_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = x)

# remove block
x_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = x)

# remove study
x_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = x)

# Compare models 
AIC(x_m1, x_m2, x_m3) # x best model

Anova(x)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
x_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = x)

## Just land use as predictor
x_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = x)

## Just Higher_taxon as the predictor
x_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = x)

## Make a null, intercept only model
x_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = x)

## Compare the models
AIC(x_m2, x_m4, x_m5, x_m6, x_m7)
model.sel(x_m2, x_m4, x_m5, x_m6, x_m7)

# x still the best
```

#### Check assumptions
```{r}
model_plot(x)
```

#### Remove other models
```{r}
rm(x_m1, x_m3, x_m4, x_m5, x_m6, x_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  x_eff <- FEsim(x, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  x_eff$term <- as.factor(x_eff$term)
  
  # pull out effects
  x_eff <- x_eff %>%
    slice(1:x) 
  
  # rename factors for ease of visualisation
  x_eff$term <- recode_factor(x_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  x_eff <- x_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(x_eff)[1] <- "Predominant_land_use"
      
      x_eff[1,3] <- 0 #shift median
      x_eff[1,5] <- 0 #shift upper
      x_eff[1,6] <- 0 #shift lower 
      
      x_eff <- x_eff %>% mutate(Order = "x")

# relevel model with x as reference level
x_x <- within(x, Higher_taxon <- relevel(Higher_taxon, ref = "x"))

# maximal model with x as ref
# make sure relevelled model follows same structure as original model
x_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | x), 
    data = x) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  x_eff <- FEsim(x_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  x_eff$term <- as.factor(x_eff$term)
  
  # pull out effects
  x_eff <- x_eff %>%
    slice(1:x) 
  
  # rename factors for ease of visualisation
  x_eff$term <- recode_factor(x_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  x_eff <- x_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(x_eff)[1] <- "Predominant_land_use"
  
      
      x_eff[1,3] <- 0 #shift median
      x_eff[1,5] <- 0 #shift upper
      x_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      x_eff <- x_eff %>% mutate(Order = "x")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(x_eff, x_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
x_x_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
x_x_plot_ab
```

#### Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(x_m2)

# Check residuals
hist(residuals(x_m2))

# Extract correlation coefficients
corr_x_ref <- as.matrix(summary(x_m2)$coefficients)
corr_x_ref <- as.matrix(summary(hym_m1)$coefficients)

x <- corr_x_ref[2:x, 1] 
x <- corr_x_ref[2:x, 1] 

cor.test(x, x) # correlation unconstrained
plot(x, x)

# regression through the origin (no intercept, only contains the slope)
m <- lm(x ~ x - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}

```


#### Species richness models (template)

#### Extract the studies and create the model data
```{r}
# Model data
x <- model_data_sr %>% filter(SS %in% x) %>% filter(Order %in% c("x", "x"))
```

#### Species richness lmer
```{r}
# maximal model
x_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = x)

# remove block
x_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = x)

# remove study
x_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = x)

# Compare models 
AIC(x_m1, x_m2, x_m3) # x marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
x_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = x)

## Just land use as predictor
x_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = x)

## Just Higher_taxon as the predictor
x_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = x)

## Make a null, intercept only model
x_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = x)

## Compare the models
AIC(x_m2, x_m4, x_m5, x_m6, x_m7)
model.sel(x_m2, x_m4, x_m5, x_m6, x_m7)

# x still optimal

# model estimates
summary(x)
```

#### Check assumptions
```{r}
model_plot(x)
```

#### Remove other models
```{r}
rm(x_m1, x_m3, x_m4, x_m5, x_m6, x_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  x_eff <- FEsim(x, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  x_eff$term <- as.factor(x_eff$term)
  
  # pull out effects
  x_eff <- x_eff %>%
    slice(1:x) 
  
  # rename factors for ease of visualisation
  x_eff$term <- recode_factor(x_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  x_eff <- x_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(x_eff)[1] <- "Predominant_land_use"

      x_eff[1,3] <- 0 #shift median
      x_eff[1,5] <- 0 #shift upper
      x_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  x_eff <- x_eff %>% mutate(Order = "x")
  
# relevel model with x as reference level
x_x <- within(x, Higher_taxon <- relevel(Higher_taxon, ref = "x"))

# maximal model with x as ref
# make sure relevelled model has same structure as original maximal model
x_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | x),
    data = x)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  x_eff <- FEsim(x_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  x_eff$term <- as.factor(x_eff$term)
  
  # pull out effects
  x_eff <- x_eff %>%
    slice(1:x) 
  
  # rename factors for ease of visualisation
  x_eff$term <- recode_factor(x_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  x_eff <- x_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(x_eff)[1] <- "Predominant_land_use"
  
      x_eff[1,3] <- 0 #shift median
      x_eff[1,5] <- 0 #shift upper
      x_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  x_eff <- x_eff %>% mutate(Order = "x")

  # Combine effects for plotting
  combined <- rbind(x_eff, x_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```
#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
x_x_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
x_x_plot_sr
```

#### Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(x)

# Check residuals
hist(residuals(x))

# Extract correlation coefficients
corr_x_ref <- as.matrix(summary(x)$coefficients)
corr_x_ref <- as.matrix(summary(x)$coefficients)

x <- corr_x_ref[2:x, 1] 
x <- corr_x_ref[2:x, 1]

plot(x, x)

cor.test(x, x) # correlation unconstrained

# regression through the origin
m <- lm(x ~ x - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
x_x <- ggarrange(x_x_plot_ab, x_x_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/x_x.png", col_hym, height = 9, width = 9)
```

#### Tidy
```{r}
rm(x)
```




#### Hymenoptera vs Coleoptera

#### Abundance models 

#### Extract the studies and create the model data
```{r}
hym_col_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Model data
hymenoptera_coleoptera <- model_data_ab %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera")) %>% droplevels()
```

#### Abundance lmer
```{r}
# maximal model
hc_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# remove block
hc_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

# remove study
hc_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m1 marginally better

# Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Compare the models
AIC(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m1, hc_m4, hc_m5, hc_m6, hc_m7) # hc_m1 still optimal

# Check assumptions
model_plot(hc_m1)

# model estimates
summary(hc_m1)
```

#### Check assumptions
```{r}
model_plot(hc_m1)
```

#### remove other models
```{r}
rm(hc_m2, hc_m3, hc_m4, hc_m5, hc_m6, hc_m7)
```

#### Simulate and prepare the fitted values for each Order 

```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(hc_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"

      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  col_eff <- col_eff %>% mutate(Order = "Coleoptera")
  
# relevel model with Hymenoptera as reference level
hymenoptera_coleoptera <- within(hymenoptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hymenoptera_coleoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")

  # Combine effects for plotting
  combined <- rbind(col_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hymenoptera_coleoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hymenoptera_coleoptera_plot_ab
```

#### Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hc_m1)

# Check residuals
hist(residuals(hc_m1))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(hc_m1)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

coleoptera <- corr_col_ref[2:6, 1] 
hymenoptera <- corr_hym_ref[2:6, 1] 

plot(coleoptera, hymenoptera)
qqnorm(hymenoptera, lty = 2)

cor(coleoptera, hymenoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(coleoptera ~ hymenoptera - 1)
plot(m)
summary.lm(m)

# Correlations
cor.test(coleoptera, hymenoptera)
cor(coleoptera, hymenoptera)

plot(coleoptera ~ hymenoptera)

# Table of coefficients
tab_model(hc_m1)

# Plot of coefficients
coefplot(hc_m1)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)


# Quick plot
ggplot(hymenoptera_coleoptera, aes(x = Predominant_land_use,
                                   y = logAbundance, 
                                   col = Higher_taxon)) +
  geom_boxplot() +
  geom_jitter()

with(hymenoptera_coleoptera, interaction.plot(Predominant_land_use, Higher_taxon, logAbundance))

# Collinearity in the independent variables
corvif(hymenoptera_coleoptera[ , c("Predominant_land_use", "Higher_taxon")])

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # positive correlation through the origin of 0.44
```

#### Tidy
```{r}
rm(col_eff, combined, corr_col_ref, corr_hym_ref, hc_m1, hym_eff, hym_m1, m, a, r, coleoptera, hymenoptera, hymenoptera_coleoptera)
```



#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
hymenoptera_coleoptera <- model_data_sr %>% filter(SS %in% hym_col_ss) %>% filter(Order %in% c("Hymenoptera", "Coleoptera"))
```

#### Species richness lmer
```{r}
# maximal model
hc_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_coleoptera)

# remove block
hc_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_coleoptera)

# remove study
hc_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_coleoptera)

# Compare models 
AIC(hc_m1, hc_m2, hc_m3) # hc_m2 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hc_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just land use as predictor
hc_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Just Higher_taxon as the predictor
hc_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Make a null, intercept only model
hc_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_coleoptera)

## Compare the models
AIC(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)
model.sel(hc_m2, hc_m4, hc_m5, hc_m6, hc_m7)

# hc_m2 still optimal

# model estimates
summary(hc_m2)
```

#### Check assumptions
```{r}
model_plot(hc_m2)
```

#### Remove other models
```{r}
rm(hc_m1, hc_m3, hc_m4, hc_m5, hc_m6, hc_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(hc_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"

      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  col_eff <- col_eff %>% mutate(Order = "Coleoptera")
  
# relevel model with Hymenoptera as reference level
hymenoptera_coleoptera <- within(hymenoptera_coleoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = hymenoptera_coleoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")

  # Combine effects for plotting
  combined <- rbind(col_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hymenoptera_coleoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hymenoptera_coleoptera_plot_sr
```

#### Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hc_m2)

# Check residuals
hist(residuals(hc_m2))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(hc_m2)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

# Split the coefficients into two groups
# coleoptera <- corr[2:6, 1] 
# hymenoptera <- corr[8:nrow(corr), 1]  # old code where I didn't set each order as the reference level.

coleoptera <- corr_col_ref[2:6, 1] 
hymenoptera <- corr_hym_ref[2:6, 1]

plot(coleoptera, hymenoptera)

cor.test(coleoptera, hymenoptera) 
cor(coleoptera, hymenoptera)

# regression through the origin
m <- lm(coleoptera ~ hymenoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
col_hym <- ggarrange(hymenoptera_coleoptera_plot_ab, hymenoptera_coleoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/col_hym.png", col_hym, height = 9, width = 9)
```

#### Tidy
```{r}
rm(col_hym, combined, corr_col_ref, corr_hym_ref, hc_m2, hym_eff, hym_m1, hymenoptera_coleoptera, hymenoptera_coleoptera_plot_sr, hymenoptera_coleoptera_plot_ab, m, coleoptera, hymenoptera, r, a, col_eff)
```





#### Hymenoptera vs Diptera

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare hymenoptera and diptera
dip_hym_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
diptera_hymenoptera <- model_data_ab %>% filter(SS %in% dip_hym_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Diptera", "Hymenoptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
dhy_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hymenoptera)

# remove block
dhy_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

# remove study
dhy_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hymenoptera)

# Compare models 
AIC(dhy_m1, dhy_m2, dhy_m3) # dhy_m2 best model

Anova(dhy_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dhy_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just land use as predictor
dhy_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Just Higher_taxon as the predictor
dhy_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Make a null, intercept only model
dhy_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_hymenoptera)

## Compare the models
AIC(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)
model.sel(dhy_m2, dhy_m4, dhy_m5, dhy_m6, dhy_m7)

# dhy_m2 still the best
```

#### Check assumptions
```{r}
model_plot(dhy_m2)
```

#### Remove other models
```{r}
rm(dhy_m1, dhy_m3, dhy_m4, dhy_m5, dhy_m6, dhy_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dhy_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"
      
      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
      
      dip_eff <- dip_eff %>% mutate(Order = "Diptera")

# relevel model with Hymenoptera as reference level
diptera_hymenoptera <- within(diptera_hymenoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hymenoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(dip_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_hymenoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_hymenoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(dhy_m2)

# Check residuals
hist(residuals(dhy_m2))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(dhy_m2)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

diptera <- corr_dip_ref[2:6, 1] 
hymenoptera <- corr_hym_ref[2:6, 1] 

# Correlations
cor.test(diptera, hymenoptera)
cor(diptera, hymenoptera)
plot(diptera, hymenoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(diptera ~ hymenoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # positive correlation through the origin of 0.44

```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_hym_ref, dhy_m2, dip_eff, hym_eff, hym_m1, m, a, r, diptera, hymenoptera, diptera_hymenoptera)
```



#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
hymenoptera_diptera <- model_data_sr %>% filter(SS %in% dip_hym_ss) %>% filter(Order %in% c("Diptera", "Hymenoptera"))
```

#### Species richness lmer
```{r}
# maximal model
hd_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_diptera)

# remove block
hd_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_diptera)

# remove study
hd_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_diptera)

# Compare models 
AIC(hd_m1, hd_m2, hd_m3) # hd_m2 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hd_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_diptera)

## Just land use as predictor
hd_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_diptera)

## Just Higher_taxon as the predictor
hd_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_diptera)

## Make a null, intercept only model
hd_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_diptera)

## Compare the models
AIC(hd_m1, hd_m2, hd_m3, hd_m4, hd_m5, hd_m6, hd_m7)
model.sel(hd_m1, hd_m2, hd_m3, hd_m4, hd_m5, hd_m6, hd_m7)

# hd_m2 still optimal

# model estimates
summary(hd_m2)
```

#### Check assumptions
```{r}
model_plot(hd_m2)
```

#### Remove other models
```{r}
rm(hd_m1, hd_m3, hd_m4, hd_m5, hd_m6, hd_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(hd_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"

      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  dip_eff <- dip_eff %>% mutate(Order = "Diptera")
  
# relevel model with Hymenoptera as reference level
hymenoptera_diptera <- within(hymenoptera_diptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_diptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")

  # Combine effects for plotting
  combined <- rbind(dip_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_hymenoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_hymenoptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hd_m2)

# Check residuals
hist(residuals(hd_m2))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(hd_m2)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

diptera <- corr_dip_ref[2:6, 1] 
hymenoptera <- corr_hym_ref[2:6, 1]

plot(diptera, hymenoptera)

cor.test(diptera, hymenoptera) 
cor(diptera, hymenoptera)

# regression through the origin
m <- lm(diptera ~ hymenoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin
```

#### Arrrange two plots so they abbut and save them
```{r}
dip_hym <- ggarrange(diptera_hymenoptera_plot_ab, diptera_hymenoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/dip_hym.png", dip_hym, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_hym_ref, dip_eff, dip_hym, diptera_hymenoptera_plot_ab, diptera_hymenoptera_plot_sr, hd_m2, hym_eff, hym_m1, hymenoptera_diptera, m, a, diptera, hymenoptera, r)
```






#### Hymenoptera vs Hemiptera

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Hymenoptera and Hemiptera
hym_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
hymenoptera_hemiptera <- model_data_ab %>% filter(SS %in% hym_hemi_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Hymenoptera", "Hemiptera")) %>% 
  droplevels() %>% 
  strings2factors()
```

#### Abundance lmer
```{r}
# maximal model
hh_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_hemiptera)

# remove block
hh_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_hemiptera)

# remove study
hh_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_hemiptera)

# Compare models 
AIC(hh_m1, hh_m2, hh_m3) # hh_m1 best model

Anova(hh_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hh_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just land use as predictor
hh_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just Higher_taxon as the predictor
hh_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Make a null, intercept only model
hh_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Compare the models
AIC(hh_m1, hh_m4, hh_m5, hh_m6, hh_m7)
model.sel(hh_m1, hh_m4, hh_m5, hh_m6, hh_m7)

# hh_m1 still the best
```

#### Check assumptions
```{r}
model_plot(hh_m1)
```

#### Remove other models
```{r}
rm(hh_m2, hh_m3, hh_m4, hh_m5, hh_m6, hh_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hh_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) # slicing first five rows as no plantation data for this comparison
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
      
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
      
      hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")

# relevel model with Hymenoptera as reference level
hymenoptera_hemiptera <- within(hymenoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with Hymenoptera as ref
hym_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS)  + (1 | SSB),
    data = hymenoptera_hemiptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(hemi_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hemiptera_hymenoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hemiptera_hymenoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hh_m1)

# Check residuals
hist(residuals(hh_m1))

# Extract correlation coefficients
corr_hemi_ref <- as.matrix(summary(hh_m1)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

hemiptera <- corr_hemi_ref[2:5, 1] # no pasture data
hymenoptera <- corr_hym_ref[2:5, 1] 

# Correlations
cor.test(hemiptera, hymenoptera)
cor(hemiptera, hymenoptera)
plot(hemiptera, hymenoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(hemiptera ~ hymenoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(combined, corr_hemi_ref, corr_hym_ref, hemi_eff, hh_m1, hym_eff, hym_m1, hymenoptera_hemiptera, m, a, hemiptera, hymenoptera, r)
```



#### Species richness models

#### Extract the studies and create the model data
```{r}
# Model data
hymenoptera_hemiptera <- model_data_sr %>% filter(SS %in% hym_hemi_ss) %>% filter(Order %in% c("Hemiptera", "Hymenoptera"))
```

#### Species richness lmer
```{r}
# maximal model
hh_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_hemiptera)

# remove block
hh_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_hemiptera)

# remove study
hh_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_hemiptera)

# Compare models 
AIC(hh_m1, hh_m2, hh_m3) # hh_m3 optimal

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hh_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just land use as predictor
hh_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Just Higher_taxon as the predictor
hh_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Make a null, intercept only model
hh_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_hemiptera)

## Compare the models
AIC(hh_m3, hh_m4, hh_m5, hh_m6, hh_m7)
model.sel(hh_m3, hh_m4, hh_m5, hh_m6, hh_m7)

# hh_m3 still optimal

# model estimates
summary(hh_m3)
```

#### Check assumptions
```{r}
model_plot(hh_m3)
```

#### Remove other models
```{r}
rm(hh_m1, hh_m2, hh_m4, hh_m5, hh_m6, hh_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hh_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"

      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")
  
# relevel model with Hymenoptera as reference level
hymenoptera_hemiptera <- within(hymenoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hymenoptera"))

# maximal model with x as ref
hym_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_hemiptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hym_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
  
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")

  # Combine effects for plotting
  combined <- rbind(hemi_eff, hym_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hemiptera_hymenoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hemiptera_hymenoptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hh_m3)

# Check residuals
hist(residuals(hh_m3))

# Extract correlation coefficients
corr_hemi_ref <- as.matrix(summary(hh_m3)$coefficients)
corr_hym_ref <- as.matrix(summary(hym_m1)$coefficients)

hemiptera <- corr_hemi_ref[2:5, 1] 
hymenoptera <- corr_hym_ref[2:5, 1]

plot(hemiptera, hymenoptera)

cor.test(hemiptera, hymenoptera)
cor(hemiptera, hymenoptera)

# regression through the origin
m <- lm(hemiptera ~ hymenoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # positive correlation through the origin of 0.44

```

#### Arrrange two plots so they abbut and save them
```{r}
hemi_hym <- ggarrange(hemiptera_hymenoptera_plot_ab, hemiptera_hymenoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/hemi_hym.png", hemi_hym, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_hemi_ref, corr_hym_ref, hemi_eff, hemi_hym, hemiptera_hymenoptera_plot_ab, hemiptera_hymenoptera_plot_sr, hh_m3, hym_eff, hym_m1, hymenoptera_hemiptera, m, a , hemiptera, hymenoptera, r)
```



#### Hymenoptera vs Lepidoptera 

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Hymenoptera and Lepidoptera
hym_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
hymenoptera_lepidoptera <- model_data_ab %>% filter(SS %in% hym_lep_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Hymenoptera", "Lepidoptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
hl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_lepidoptera)

# remove block
hl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

# remove study
hl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m2 best model

Anova(hl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Compare the models
AIC(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m2 still the best
```

#### Check assumptions
```{r}
model_plot(hl_m2)
```

#### Remove other models
```{r}
rm(hl_m1, hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hl_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"
      
      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
      
      hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")

# relevel model with Lepidoptera as reference level
hymenoptera_lepidoptera <- within(hymenoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure releveled model follows same structure as original model
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), 
    data = hymenoptera_lepidoptera) 


  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(hym_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined <- combined %>% filter(Predominant_land_use != "Plantation")
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hymenoptera_lepidoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hymenoptera_lepidoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hl_m2)

# Check residuals
hist(residuals(hl_m2))

# Extract correlation coefficients
corr_hym_ref <- as.matrix(summary(hl_m2)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

hymenoptera <- corr_hym_ref[c(2,4:6), 1] # remove plantation as too little data
lepidoptera <- corr_lep_ref[c(2,4:6), 1] 

# Correlations
cor.test(hymenoptera, lepidoptera)
cor(hymenoptera, lepidoptera)
plot(hymenoptera, lepidoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(hymenoptera ~ lepidoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(combined, corr_hym_ref, corr_lep_ref, hl_m2, hym_eff, hymenoptera_lepidoptera, lep_eff, lep_m1, m, a, hymenoptera, lepidoptera, r)
```


#### Species richness models

#### Extract the studies and create the model data
```{r}
# Model data
hymenoptera_lepidoptera <- model_data_sr %>% filter(SS %in% hym_lep_ss) %>% filter(Order %in% c("Hymenoptera", "Lepidoptera"))
```

#### Species richness lmer
```{r}
# maximal model
hl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hymenoptera_lepidoptera)

# remove block
hl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

# remove study
hl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hymenoptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m2 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hymenoptera_lepidoptera)

## Compare the models
AIC(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m2 still optimal

# model estimates
summary(hl_m2)
```

#### Check assumptions
```{r}
model_plot(hl_m2)
```

#### Remove other models
```{r}
rm(hl_m1, hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hym_eff <- FEsim(hl_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hym_eff$term <- as.factor(hym_eff$term)
  
  # pull out effects
  hym_eff <- hym_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hym_eff$term <- recode_factor(hym_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hym_eff <- hym_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hym_eff)[1] <- "Predominant_land_use"

      hym_eff[1,3] <- 0 #shift median
      hym_eff[1,5] <- 0 #shift upper
      hym_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hym_eff <- hym_eff %>% mutate(Order = "Hymenoptera")
  
# relevel model with Lepidoptera as reference level
hymenoptera_lepidoptera <- within(hymenoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure releveled model has same structure as original maximal model
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hymenoptera_lepidoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")

  # Combine effects for plotting
  combined <- rbind(hym_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined <- combined %>% filter(Predominant_land_use != "Plantation")
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hymenoptera_lepidoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hymenoptera_lepidoptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hl_m2)

# Check residuals
hist(residuals(hl_m2))

# Extract correlation coefficients
corr_hym_ref <- as.matrix(summary(hl_m2)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

hymenoptera <- corr_hym_ref[c(2,4:6), 1] 
lepidoptera <- corr_lep_ref[c(2,4:6), 1]

plot(hymenoptera, lepidoptera)

cor.test(hymenoptera, lepidoptera) # correlation unconstrained

# regression through the origin
m <- lm(hymenoptera ~ lepidoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin
```

#### Arrrange two plots so they abbut and save them
```{r}
hym_lep <- ggarrange(hymenoptera_lepidoptera_plot_ab, hymenoptera_lepidoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/hym_lep.png", hym_lep, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_hym_ref, corr_lep_ref, hl_m2, hym_eff, hym_lep, hymenoptera_lepidoptera, hymenoptera_lepidoptera_plot_ab, hymenoptera_lepidoptera_plot_sr, lep_eff, lep_m1, m, a, hymenoptera, lepidoptera, r)
```



#### Coleoptera vs Diptera 

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Coleoptera and Diptera
col_dip_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Coleoptera", "Diptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
coleoptera_diptera <- model_data_ab %>% filter(SS %in% col_dip_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Coleoptera", "Diptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
cd_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_diptera)

# remove block
cd_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_diptera)

# remove study
cd_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_diptera)

# Compare models 
AIC(cd_m1, cd_m2, cd_m3) # cd_m2 best model

Anova(cd_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cd_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_diptera)

## Just land use as predictor
cd_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = coleoptera_diptera)

## Just Higher_taxon as the predictor
cd_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_diptera)

## Make a null, intercept only model
cd_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = coleoptera_diptera)

## Compare the models
AIC(cd_m2, cd_m4, cd_m5, cd_m6, cd_m7)
model.sel(cd_m2, cd_m4, cd_m5, cd_m6, cd_m7)

# cd_m6 most optimal (suggesting abundance ~ higher_taxon fits the data better than abundance ~ LU * higher_taxon), but we will proceed with cd_m2 as we are interested in the interaction effect. 
```

#### Check assumptions
```{r}
model_plot(cd_m2)
```

#### Remove other models
```{r}
rm(cd_m1, cd_m3, cd_m4, cd_m5, cd_m6, cd_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(cd_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"
      
      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
      
      col_eff <- col_eff %>% mutate(Order = "Coleoptera")

# relevel model with Diptera as reference level
coleoptera_diptera <- within(coleoptera_diptera, Higher_taxon <- relevel(Higher_taxon, ref = "Diptera"))

# maximal model with Diptera as ref
# make sure releveled model follows same structure as original model
dip_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), 
    data = coleoptera_diptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dip_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"
  
      
      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      dip_eff <- dip_eff %>% mutate(Order = "Diptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(col_eff, dip_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_diptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_diptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(cd_m2)

# Check residuals
hist(residuals(cd_m2))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(cd_m2)$coefficients)
corr_dip_ref <- as.matrix(summary(dip_m1)$coefficients)

coleoptera <- corr_col_ref[2:6, 1] 
diptera <- corr_dip_ref[2:6, 1] 

cor.test(coleoptera, diptera) # correlation unconstrained
plot(coleoptera, diptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(coleoptera ~ diptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(cd_m2, col_eff, coleoptera_diptera, combined, corr_col_ref, corr_dip_ref, dip_eff, dip_m1, m, a, coleoptera, diptera, r)
```


#### Species richness models

#### Extract the studies and create the model data
```{r}
# Model data
coleoptera_diptera <- model_data_sr %>% filter(SS %in% col_dip_ss) %>% filter(Order %in% c("Coleoptera", "Diptera"))
```

#### Species richness lmer
```{r}
# maximal model
cd_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              coleoptera_diptera)

# remove block
cd_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    coleoptera_diptera)

# remove study
cd_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    coleoptera_diptera)

# Compare models 
AIC(cd_m1, cd_m2, cd_m3) # cd_m2 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cd_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), coleoptera_diptera)

## Just land use as predictor
cd_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), coleoptera_diptera)

## Just Higher_taxon as the predictor
cd_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), coleoptera_diptera)

## Make a null, intercept only model
cd_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), coleoptera_diptera)

## Compare the models
AIC(cd_m2, cd_m4, cd_m5, cd_m6, cd_m7)
model.sel(cd_m2, cd_m4, cd_m5, cd_m6, cd_m7)

# Interesting, cd_m2 is most optimal for abundance, but not SR. 

# model estimates
summary(cd_m2)
```

#### Check assumptions
```{r}
model_plot(cd_m2)
```

#### Remove other models
```{r}
rm(cd_m1, cd_m3, cd_m4, cd_m5, cd_m6, cd_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(cd_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"

      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  col_eff <- col_eff %>% mutate(Order = "Coleoptera")
  
# relevel model with x as reference level
coleoptera_diptera <- within(coleoptera_diptera, Higher_taxon <- relevel(Higher_taxon, ref = "Diptera"))

# maximal model with Diptera as ref
# make sure relevelled model has same structure as original maximal model
dip_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_diptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dip_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"
  
      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  dip_eff <- dip_eff %>% mutate(Order = "Diptera")

  # Combine effects for plotting
  combined <- rbind(col_eff, dip_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_diptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_diptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(cd_m2)

# Check residuals
hist(residuals(cd_m2))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(cd_m2)$coefficients)
corr_dip_ref <- as.matrix(summary(dip_m1)$coefficients)

coleoptera <- corr_col_ref[2:6, 1] 
diptera <- corr_dip_ref[2:6, 1]

plot(coleoptera, diptera)

cor.test(coleoptera, diptera) # correlation unconstrained

# regression through the origin
m <- lm(coleoptera ~ diptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
col_dip <- ggarrange(coleoptera_diptera_plot_ab, coleoptera_diptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/col_dip.png", col_dip, height = 9, width = 9)
```

#### Tidy
```{r}
rm(cd_m2, col_dip, col_eff, coleoptera_diptera, coleoptera_diptera_plot_ab, coleoptera_diptera_plot_sr, combined, corr_col_ref, corr_dip_ref, dip_eff, dip_m1, m, a, coleoptera, diptera, r)
```




#### Coleoptera vs Hemiptera

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Coleoptera and Hemiptera
col_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Coleoptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
coleoptera_hemiptera <- model_data_ab %>% filter(SS %in% col_hemi_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Coleoptera", "Hemiptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
ch_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_hemiptera)

# remove block
ch_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_hemiptera)

# remove study
ch_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_hemiptera)

# Compare models 
AIC(ch_m1, ch_m2, ch_m3) # ch_m1 best model

Anova(ch_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
ch_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Just land use as predictor
ch_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Just Higher_taxon as the predictor
ch_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Make a null, intercept only model
ch_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Compare the models
AIC(ch_m1, ch_m4, ch_m5, ch_m6, ch_m7)
model.sel(ch_m1, ch_m4, ch_m5, ch_m6, ch_m7)

# ch_m1 still the best
```

#### Check assumptions
```{r}
model_plot(ch_m1)
```

#### Remove other models
```{r}
rm(ch_m2, ch_m3, ch_m4, ch_m5, ch_m6, ch_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(ch_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"
      
      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
      
      col_eff <- col_eff %>% mutate(Order = "Coleoptera")

# relevel model with Hemiptera as reference level
coleoptera_hemiptera <- within(coleoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
# make sure relevelled model follows same structure as original model
hemi_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB), 
    data = coleoptera_hemiptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hemi_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
  
      
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(col_eff, hemi_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_hemiptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_hemiptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(ch_m1)

# Check residuals
hist(residuals(ch_m1))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(ch_m1)$coefficients)
corr_hemi_ref <- as.matrix(summary(hemi_m1)$coefficients)

coleoptera <- corr_col_ref[2:6, 1] 
hemiptera <- corr_hemi_ref[2:6, 1] 

cor.test(coleoptera, hemiptera) # correlation unconstrained
plot(coleoptera, hemiptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(coleoptera ~ hemiptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(ch_m1, col_eff, coleoptera_hemiptera, combined, corr_col_ref, corr_hemi_ref, hemi_eff, m, hemi_m1, a, coleoptera, hemiptera, r)
```


#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
coleoptera_hemiptera <- model_data_sr %>% filter(SS %in% col_hemi_ss) %>% filter(Order %in% c("Coleoptera", "Hemiptera"))
```

#### Species richness lmer
```{r}
# maximal model
ch_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_hemiptera)

# remove block
ch_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_hemiptera)

# remove study
ch_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_hemiptera)

# Compare models 
AIC(ch_m1, ch_m2, ch_m3) # ch_m1 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
ch_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Just land use as predictor
ch_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Just Higher_taxon as the predictor
ch_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Make a null, intercept only model
ch_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = coleoptera_hemiptera)

## Compare the models
AIC(ch_m1, ch_m4, ch_m5, ch_m6, ch_m7)
model.sel(ch_m1, ch_m4, ch_m5, ch_m6, ch_m7)

# ch_m1 still optimal

# model estimates
summary(ch_m1)
```

#### Check assumptions
```{r}
model_plot(ch_m1) # three sources have big intercepts
```

#### Remove other models
```{r}
rm(ch_m2, ch_m3, ch_m4, ch_m5, ch_m6, ch_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(ch_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"

      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  col_eff <- col_eff %>% mutate(Order = "Coleoptera")
  
# relevel model with x as reference level
coleoptera_hemiptera <- within(coleoptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
# make sure relevelled model has same structure as original maximal model
hemi_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = coleoptera_hemiptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hemi_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
  
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")

  # Combine effects for plotting
  combined <- rbind(col_eff, hemi_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_hemiptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_hemiptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(ch_m1)

# Check residuals
hist(residuals(ch_m1))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(ch_m1)$coefficients)
corr_hemi_ref <- as.matrix(summary(hemi_m1)$coefficients)

coleoptera <- corr_col_ref[2:6, 1] 
hemiptera <- corr_hemi_ref[2:6, 1]

plot(coleoptera, hemiptera)

cor.test(coleoptera, hemiptera) # correlation unconstrained

# regression through the origin
m <- lm(coleoptera ~ hemiptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
col_hemi <- ggarrange(coleoptera_hemiptera_plot_ab, coleoptera_hemiptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/col_hemi.png", col_hemi, height = 9, width = 9)
```

#### Tidy
```{r}
rm(ch_m1, col_eff, col_hemi, coleoptera_hemiptera, coleoptera_hemiptera_plot_ab, coleoptera_hemiptera_plot_sr, combined, corr_col_ref, corr_hemi_ref, hemi_eff, hemi_m1, m, a, coleoptera, hemiptera, r)
```




#### Coleoptera vs Lepidoptera

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Coleoptera and Lepidoptera
col_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
coleoptera_lepidoptera <- model_data_ab %>% filter(SS %in% col_lep_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Coleoptera", "Lepidoptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
cl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_lepidoptera)

# remove block
cl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_lepidoptera)

# remove study
cl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_lepidoptera)

# Compare models 
AIC(cl_m1, cl_m2, cl_m3) # cl_m2 best model

Anova(cl_m2)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Just land use as predictor
cl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Just Higher_taxon as the predictor
cl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Make a null, intercept only model
cl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Compare the models
AIC(cl_m2, cl_m4, cl_m5, cl_m6, cl_m7)
model.sel(cl_m2, cl_m4, cl_m5, cl_m6, cl_m7)

# cl_m2 still the best
```

#### Check assumptions
```{r}
model_plot(cl_m2)
```

#### Remove other models
```{r}
rm(cl_m1, cl_m3, cl_m4, cl_m5, cl_m6, cl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(cl_m2, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"
      
      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
      
      col_eff <- col_eff %>% mutate(Order = "Coleoptera")

# relevel model with Lepidoptera as reference level
coleoptera_lepidoptera <- within(coleoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure relevelled model follows same structure as original model
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS), 
    data = coleoptera_lepidoptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(lep_eff, col_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined <- combined %>% filter(Predominant_land_use != "Plantation")
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_lepidoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_lepidoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(cl_m2)

# Check residuals
hist(residuals(cl_m2))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(cl_m2)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

coleoptera <- corr_col_ref[c(2,4:6), 1] 
lepidoptera <- corr_lep_ref[c(2,4:6), 1] 

cor.test(coleoptera, lepidoptera) # correlation unconstrained
plot(coleoptera, lepidoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(coleoptera ~ lepidoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(cl_m2, col_eff, coleoptera_lepidoptera, combined, corr_col_ref, corr_lep_ref, lep_eff, lep_m1, m, a, coleoptera, lepidoptera, r)
```


#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
coleoptera_lepidoptera <- model_data_sr %>% filter(SS %in% col_lep_ss) %>% filter(Order %in% c("Coleoptera", "Lepidoptera"))
```

#### Species richness lmer
```{r}
# maximal model
cl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = coleoptera_lepidoptera)

# remove block
cl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = coleoptera_lepidoptera)

# remove study
cl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = coleoptera_lepidoptera)

# Compare models 
AIC(cl_m1, cl_m2, cl_m3) # cl_m1 marginally better model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
cl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Just land use as predictor
cl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Just Higher_taxon as the predictor
cl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Make a null, intercept only model
cl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = coleoptera_lepidoptera)

## Compare the models
AIC(cl_m1, cl_m4, cl_m5, cl_m6, cl_m7)
model.sel(cl_m1, cl_m4, cl_m5, cl_m6, cl_m7)

# cl_m1 still optimal

# model estimates
summary(cl_m1)
```

#### Check assumptions
```{r}
model_plot(cl_m1)
```

#### Remove other models
```{r}
rm(cl_m2, cl_m3, cl_m4, cl_m5, cl_m6, cl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  col_eff <- FEsim(cl_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  col_eff$term <- as.factor(col_eff$term)
  
  # pull out effects
  col_eff <- col_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  col_eff$term <- recode_factor(col_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  col_eff <- col_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(col_eff)[1] <- "Predominant_land_use"

      col_eff[1,3] <- 0 #shift median
      col_eff[1,5] <- 0 #shift upper
      col_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  col_eff <- col_eff %>% mutate(Order = "Coleoptera")
  
# relevel model with x as reference level
coleoptera_lepidoptera <- within(coleoptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with lepidoptera as ref
# make sure relevelled model has same structure as original maximal model
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
    data = coleoptera_lepidoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")

  # Combine effects for plotting
  combined <- rbind(lep_eff, col_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined <- combined %>% filter(Predominant_land_use != "Plantation")
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
coleoptera_lepidoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
coleoptera_lepidoptera_plot_sr
```

#### Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(cl_m1)

# Check residuals
hist(residuals(cl_m1))

# Extract correlation coefficients
corr_col_ref <- as.matrix(summary(cl_m1)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

coleoptera <- corr_col_ref[c(2,4:6), 1] 
lepidoptera <- corr_lep_ref[c(2,4:6), 1]

plot(coleoptera, lepidoptera)

cor.test(coleoptera, lepidoptera) # correlation unconstrained

# regression through the origin
m <- lm(coleoptera ~ lepidoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
col_lep <- ggarrange(coleoptera_lepidoptera_plot_ab, coleoptera_lepidoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/col_lep.png", col_lep, height = 9, width = 9)
```

#### Tidy
```{r}
rm(cl_m1, col_eff, col_lep, coleoptera_lepidoptera_plot_ab, coleoptera_lepidoptera_plot_sr, coleoptera_lepidoptera, combined, corr_col_ref, corr_lep_ref, lep_eff, lep_m1, m, a, coleoptera, lepidoptera, r)
```


#### Diptera vs Hemiptera 

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Diptera and Hemiptera
dip_hemi_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Hemiptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
diptera_hemiptera <- model_data_ab %>% filter(SS %in% dip_hemi_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Diptera", "Hemiptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
dh_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

# remove block
dh_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hemiptera)

# remove study
dh_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

# Compare models 
AIC(dh_m1, dh_m2, dh_m3) # dh_m1 best model

Anova(dh_m1)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dh_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Just land use as predictor
dh_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Just Higher_taxon as the predictor
dh_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Make a null, intercept only model
dh_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Compare the models
AIC(dh_m1, dh_m4, dh_m5, dh_m6, dh_m7)
model.sel(dh_m1, dh_m4, dh_m5, dh_m6, dh_m7)

# dh_m1 still the best
```

#### Check assumptions
```{r}
model_plot(dh_m1)
```

#### Remove other models
```{r}
rm(dh_m2, dh_m3, dh_m4, dh_m5, dh_m6, dh_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dh_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:5) # no plantation data 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"
      
      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
      
      dip_eff <- dip_eff %>% mutate(Order = "Diptera")

# relevel model with Hemiptera as reference level
diptera_hemiptera <- within(diptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
# make sure relevelled model follows same structure as original model
hemi_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB), 
    data = diptera_hemiptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hemi_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
  
      
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(dip_eff, hemi_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_hemiptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_hemiptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(dh_m1)

# Check residuals
hist(residuals(dh_m1))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(dh_m1)$coefficients)
corr_hemi_ref <- as.matrix(summary(hemi_m1)$coefficients)

diptera <- corr_dip_ref[2:5, 1] 
hemiptera <- corr_hemi_ref[2:5, 1] 

cor.test(diptera, hemiptera) # correlation unconstrained
plot(diptera, hemiptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(diptera ~ hemiptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_hemi_ref, dh_m1, dip_eff, diptera_hemiptera, hemi_eff, hemi_m1, m, a, diptera, hemiptera, r)
```


#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
diptera_hemiptera <- model_data_sr %>% filter(SS %in% dip_hemi_ss) %>% filter(Order %in% c("Diptera", "Hemiptera"))
```

#### Species richness lmer
```{r}
# maximal model
dh_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_hemiptera)

# remove block
dh_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_hemiptera)

# remove study
dh_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

# Compare models 
AIC(dh_m1, dh_m2, dh_m3) # dh_m3 optimal model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dh_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Just land use as predictor
dh_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Just Higher_taxon as the predictor
dh_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Make a null, intercept only model
dh_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = diptera_hemiptera)

## Compare the models
AIC(dh_m3, dh_m4, dh_m5, dh_m6, dh_m7)
model.sel(dh_m3, dh_m4, dh_m5, dh_m6, dh_m7)

# dh_m3 still optimal

# model estimates
summary(dh_m3)
```

#### Check assumptions
```{r}
model_plot(dh_m3)
```

#### Remove other models
```{r}
rm(dh_m1, dh_m2, dh_m4, dh_m5, dh_m6, dh_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dh_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"

      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  dip_eff <- dip_eff %>% mutate(Order = "Diptera")
  
# relevel model with Hemiptera as reference level
diptera_hemiptera <- within(diptera_hemiptera, Higher_taxon <- relevel(Higher_taxon, ref = "Hemiptera"))

# maximal model with Hemiptera as ref
# make sure relevelled model has same structure as original maximal model
hemi_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_hemiptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hemi_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
  
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")

  # Combine effects for plotting
  combined <- rbind(dip_eff, hemi_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_hemiptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_hemiptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(dh_m3)

# Check residuals
hist(residuals(dh_m3))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(dh_m3)$coefficients)
corr_hemi_ref <- as.matrix(summary(hemi_m1)$coefficients)

diptera <- corr_dip_ref[2:5, 1] 
hemiptera <- corr_hemi_ref[2:5, 1]

plot(diptera, hemiptera)

cor.test(diptera, hemiptera) # correlation unconstrained

# regression through the origin
m <- lm(diptera ~ hemiptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
dip_hemi <- ggarrange(diptera_hemiptera_plot_ab, diptera_hemiptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/dip_hemi.png", dip_hemi, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_hemi_ref, dh_m3, dip_eff, dip_hemi, diptera_hemiptera, diptera_hemiptera_plot_ab, diptera_hemiptera_plot_sr, hemi_eff, hemi_m1, m, a, diptera, hemiptera, r)
```




#### Diptera vs Lepidoptera

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Diptera and Lepidoptera
dip_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Diptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
diptera_lepidoptera <- model_data_ab %>% filter(SS %in% dip_lep_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Diptera", "Lepidoptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
dl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_lepidoptera)

# remove block
dl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_lepidoptera)

# remove study
dl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

# Compare models 
AIC(dl_m1, dl_m2, dl_m3) # dl_m3 best model

Anova(dl_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just land use as predictor
dl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just Higher_taxon as the predictor
dl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Make a null, intercept only model
dl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Compare the models
AIC(dl_m3, dl_m4, dl_m5, dl_m6, dl_m7)
model.sel(dl_m3, dl_m4, dl_m5, dl_m6, dl_m7)

# dl_m6 marginally better (0.3 AIC) but we're interested in the interaction effect so will go ahead with dl_m3
```

#### Check assumptions
```{r}
model_plot(dl_m3)
```

#### Remove other models
```{r}
rm(dl_m1, dl_m2, dl_m4, dl_m5, dl_m6, dl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dl_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"
      
      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
      
      dip_eff <- dip_eff %>% mutate(Order = "Diptera")

# relevel model with Lepidoptera as reference level
diptera_lepidoptera <- within(diptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure relevelled model follows same structure as original model
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID), 
    data = diptera_lepidoptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")
      
  # Combine effects for plotting and round to two decimal places
  combined <- rbind(dip_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  # remove plantation data as there is only 1 data point for each Order
  combined <- combined %>% filter(Predominant_land_use != "Plantation") 
  
  
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_lepidoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_lepidoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(dl_m3)

# Check residuals
hist(residuals(dl_m3))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(dl_m3)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

diptera <- corr_dip_ref[c(2,4:6), 1] # remove plantation as only 1 data point
lepidoptera <- corr_lep_ref[c(2,4:6), 1] 

cor.test(diptera, lepidoptera) # correlation unconstrained
plot(diptera, lepidoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(diptera ~ lepidoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_lep_ref, dip_eff, diptera_lepidoptera, dl_m3, lep_eff, lep_m1, m, a, diptera, lepidoptera, r)
```


#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
diptera_lepidoptera <- model_data_sr %>% filter(SS %in% dip_lep_ss) %>% filter(Order %in% c("Diptera", "Lepidoptera"))
```

#### Species richness lmer
```{r}
# maximal model
dl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = diptera_lepidoptera)

# remove block
dl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = diptera_lepidoptera)

# remove study
dl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

# Compare models 
AIC(dl_m1, dl_m2, dl_m3) # dl_m3 optimal model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
dl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just land use as predictor
dl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Just Higher_taxon as the predictor
dl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Make a null, intercept only model
dl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = diptera_lepidoptera)

## Compare the models
AIC(dl_m3, dl_m2, dl_m1, dl_m4, dl_m5, dl_m6, dl_m7)
model.sel(dl_m3, dl_m2, dl_m1, dl_m4, dl_m5, dl_m6, dl_m7)

# dl_m6 optimal but we are interested in interaction effect so will go ahead with dl_m3.
```

#### Check assumptions
```{r}
model_plot(dl_m3)
```

#### Remove other models
```{r}
rm(dl_m1, dl_m2, dl_m4, dl_m5, dl_m6, dl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  dip_eff <- FEsim(dl_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  dip_eff$term <- as.factor(dip_eff$term)
  
  # pull out effects
  dip_eff <- dip_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  dip_eff$term <- recode_factor(dip_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  dip_eff <- dip_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(dip_eff)[1] <- "Predominant_land_use"

      dip_eff[1,3] <- 0 #shift median
      dip_eff[1,5] <- 0 #shift upper
      dip_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  dip_eff <- dip_eff %>% mutate(Order = "Diptera")
  
# relevel model with Lepidoptera as reference level
diptera_lepidoptera <- within(diptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure relevelled model has same structure as original maximal model
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = diptera_lepidoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:6) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")

  # Combine effects for plotting
  combined <- rbind(dip_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  # remove plantation data as there is only 1 data point for each Order
  combined <- combined %>% filter(Predominant_land_use != "Plantation") 
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
diptera_lepidoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
diptera_lepidoptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(dl_m3)

# Check residuals
hist(residuals(dl_m3))

# Extract correlation coefficients
corr_dip_ref <- as.matrix(summary(dl_m3)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

diptera <- corr_dip_ref[c(2,4:6), 1] # remove plantation as only 1 data point
lepidoptera <- corr_lep_ref[c(2,4:6), 1] 

plot(diptera, lepidoptera)

cor.test(diptera, lepidoptera) # correlation unconstrained

# regression through the origin
m <- lm(diptera ~ lepidoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
dip_lep <- ggarrange(diptera_lepidoptera_plot_ab, diptera_lepidoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/dip_lep.png", dip_lep, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_dip_ref, corr_lep_ref, dip_eff, dip_lep, diptera_lepidoptera, diptera_lepidoptera_plot_ab, diptera_lepidoptera_plot_sr, dl_m3, lep_eff, lep_m1, m, a, diptera, lepidoptera, r)
```




#### Lepidoptera vs Hemiptera 

#### Extract the studies and create the model data
```{r}
# Filter for studies that only compare Hemiptera and Lepidoptera
hemi_lep_ss <-  model_data_ab %>% 
  dplyr::select(SS, Order) %>% 
  filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% 
  unique() %>% 
  group_by(SS) %>% 
  tally() %>% 
  filter(n == 2) %>% 
  pull(SS) %>% 
  unique()

# Filter our abundance model dataset for those studies:
hemiptera_lepidoptera <- model_data_ab %>% filter(SS %in% hemi_lep_ss) %>% 
  # then filter the two orders we want to compare, as some studies will have include more than those two orders
  filter(Order %in% c("Hemiptera", "Lepidoptera")) %>% 
  droplevels()
```

#### Abundance lmer
```{r}
# maximal model
hl_m1 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_lepidoptera)

# remove block
hl_m2 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_lepidoptera)

# remove study
hl_m3 <-lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m3 best model

Anova(hl_m3)

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logAbundance ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logAbundance ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logAbundance ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logAbundance ~ (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Compare the models
AIC(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m3 still optimal
```

#### Check assumptions
```{r}
model_plot(hl_m3)
```

#### Remove other models
```{r}
rm(hl_m1, hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hl_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"
      
      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
      
      hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")

# relevel model with Lepidoptera as reference level
hemiptera_lepidoptera <- within(hemiptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure relevelled model follows same structure as original model
lep_m1 <- lmer(logAbundance ~ Predominant_land_use * Higher_taxon + (1 | Source_ID), 
    data = hemiptera_lepidoptera) 

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
      
      # Grouping variable
      lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")
      
        # Combine effects for plotting and round to two decimal places
  combined <- rbind(hemi_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hemiptera_lepidoptera_plot_ab <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Total abundance difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hemiptera_lepidoptera_plot_ab
```

## Extract abundance correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hl_m3)

# Check residuals
hist(residuals(hl_m3))

# Extract correlation coefficients
corr_hemi_ref <- as.matrix(summary(hl_m3)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

hemiptera <- corr_hemi_ref[2:5, 1] 
lepidoptera <- corr_lep_ref[2:5, 1] 

cor.test(hemiptera, lepidoptera) # correlation unconstrained
plot(hemiptera, lepidoptera)

# regression through the origin (no intercept, only contains the slope)
m <- lm(hemiptera ~ lepidoptera - 1)
plot(m)
summary.lm(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Tidy
```{r}
rm(combined, corr_hemi_ref, corr_lep_ref, hemi_eff, hemiptera_lepidoptera, hl_m3, lep_eff, lep_m1, m, a, hemiptera, lepidoptera, r)
```


#### Species richness models 

#### Extract the studies and create the model data
```{r}
# Model data
hemiptera_lepidoptera <- model_data_sr %>% filter(SS %in% hemi_lep_ss) %>% filter(Order %in% c("Hemiptera", "Lepidoptera"))
```

#### Species richness lmer
```{r}
# maximal model
hl_m1 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS) + (1 | SSB),
              data = hemiptera_lepidoptera)

# remove block
hl_m2 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID) + (1 | SS),
    data = hemiptera_lepidoptera)

# remove study
hl_m3 <-lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

# Compare models 
AIC(hl_m1, hl_m2, hl_m3) # hl_m3 optimal model

## Backwards stepwise selection of fixed effects 

## Model with the interaction removed but both predictors still present
hl_m4 <- lmer(logSR ~ Predominant_land_use + Higher_taxon + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Just land use as predictor
hl_m5 <- lmer(logSR ~ Predominant_land_use + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Just Higher_taxon as the predictor
hl_m6 <- lmer(logSR ~ Higher_taxon + (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Make a null, intercept only model
hl_m7 <- lmer(logSR ~ (1 | Source_ID) + (1|SS), data = hemiptera_lepidoptera)

## Compare the models
AIC(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)
model.sel(hl_m3, hl_m4, hl_m5, hl_m6, hl_m7)

# hl_m3 still optimal

# model estimates
summary(hl_m3)
```

#### Check assumptions
```{r}
model_plot(hl_m3)
```

#### Remove other models
```{r}
rm(hl_m1, hl_m2, hl_m4, hl_m5, hl_m6, hl_m7)
```

#### Simulate and prepare the fitted values for each Order 
```{r}
  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  hemi_eff <- FEsim(hl_m3, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  hemi_eff$term <- as.factor(hemi_eff$term)
  
  # pull out effects
  hemi_eff <- hemi_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  hemi_eff$term <- recode_factor(hemi_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  hemi_eff <- hemi_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(hemi_eff)[1] <- "Predominant_land_use"

      hemi_eff[1,3] <- 0 #shift median
      hemi_eff[1,5] <- 0 #shift upper
      hemi_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  hemi_eff <- hemi_eff %>% mutate(Order = "Hemiptera")
  
# relevel model with Lepidoptera as reference level
hemiptera_lepidoptera <- within(hemiptera_lepidoptera, Higher_taxon <- relevel(Higher_taxon, ref = "Lepidoptera"))

# maximal model with Lepidoptera as ref
# make sure relevelled model has same structure as original maximal model
lep_m1 <- lmer(logSR ~ Predominant_land_use * Higher_taxon + (1 | Source_ID),
    data = hemiptera_lepidoptera)

  # gather the effects and confidence intervals using simulation. Simulate 1000 times
  lep_eff <- FEsim(lep_m1, n.sims = 1000)
  
  # make the term column a factor so it can be recoded
  lep_eff$term <- as.factor(lep_eff$term)
  
  # pull out effects
  lep_eff <- lep_eff %>%
    slice(1:5) 
  
  # rename factors for ease of visualisation
  lep_eff$term <- recode_factor(lep_eff$term, "(Intercept)" = "Primary",
                                #"Predominant_land_useYoung secondary vegetation" = "YSV",
                                #"Predominant_land_useIntermediate secondary vegetation" = "ISV",
                                #"Predominant_land_useMature secondary vegetation" = "MSV",
                                "Predominant_land_useSecondary vegetation" = "Secondary vegetation",
                                "Predominant_land_usePlantation forest" = "Plantation",
                                "Predominant_land_usePasture" = "Pasture",
                                "Predominant_land_useCropland" = "Cropland",
                                "Predominant_land_useUrban" = "Urban")
  
  
  # Add in upper and lower confidence intervals 
  lep_eff <- lep_eff %>%
    mutate(Upper_ci = (median + 1.96*sd)) %>%
    mutate(Lower_ci = (median - 1.96*sd))
  
  # Rename the sim eff term column name for joining
  colnames(lep_eff)[1] <- "Predominant_land_use"
  
      lep_eff[1,3] <- 0 #shift median
      lep_eff[1,5] <- 0 #shift upper
      lep_eff[1,6] <- 0 #shift lower 
  
  # Add in a column of Order to make sure there is a grouping variable
  lep_eff <- lep_eff %>% mutate(Order = "Lepidoptera")

  # Combine effects for plotting
  combined <- rbind(hemi_eff, lep_eff) %>% mutate_if(is.numeric, round, digits = 2)
  
  combined
```

#### Create the plot, with the fits on the log scale and setting primary to zero and plotting the coefficients for each of the land uses as departures from primary.
```{r}
hemiptera_lepidoptera_plot_sr <- combined %>%
    ggplot()+
    aes(x = Predominant_land_use, y = median, colour = Order, group = Order)+
    geom_hline(yintercept = 0, linewidth = 0.5, color = ("black"), linetype = 1)+
    geom_point(size = 3, position = position_dodge(width = 0.5))+
    geom_linerange(aes(ymin = Upper_ci, ymax = Lower_ci), position = position_dodge(width = 0.5), linewidth = 1)+
    theme_classic()+
    scale_x_discrete(limits=comb_plot_limits)+
    geom_vline(xintercept = 1.5, linetype = 2)+
    geom_vline(xintercept = 2.5, linetype = 2)+
    geom_vline(xintercept = 3.5, linetype = 2)+
    geom_vline(xintercept = 4.5, linetype = 2)+
    geom_vline(xintercept = 5.5, linetype = 2)+
    #geom_vline(xintercept = 6.5, linetype = 2)+ removed due to lower LU categories
    #geom_vline(xintercept = 7.5, linetype = 2)+
    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
          axis.title.x = element_blank(),
          panel.border = element_rect(colour = "black",  fill=NA))+
    xlab("Land use intensity class")+
    ylab("(Log) Species richness difference") +
    scale_colour_manual(values=group_colours) + # this overrides the colours for the groups as above
    guides(color = guide_legend(
      override.aes=list(shape = 15, size = 8))) +
        scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
  
hemiptera_lepidoptera_plot_sr
```

## Extract species richness correlations and significance tests (unconstrained and through the origin)
```{r}
# Extract f ratio, df and p value
anova(hl_m3)

# Check residuals
hist(residuals(hl_m3))

# Extract correlation coefficients
corr_hemi_ref <- as.matrix(summary(hl_m3)$coefficients)
corr_lep_ref <- as.matrix(summary(lep_m1)$coefficients)

hemiptera <- corr_hemi_ref[2:5, 1] 
lepidoptera <- corr_lep_ref[2:5, 1]

plot(hemiptera, lepidoptera)

cor.test(hemiptera, lepidoptera) # correlation unconstrained

# regression through the origin
m <- lm(hemiptera ~ lepidoptera - 1)

# This model has only one coefficient, with no intercept, it only contains the slope
summary(m)

# get r2 from the summary; square-root it and give the result the correct sign to get the correlation coefficient through the origin
r <- sqrt(summary(m)$r.squared)
r

# and change the sign if you need to 
a <- ifelse(coef(m) > 0, r, -r)

a # correlation through the origin

```

#### Arrrange two plots so they abbut and save them
```{r}
hemi_lep <- ggarrange(hemiptera_lepidoptera_plot_ab, hemiptera_lepidoptera_plot_sr, nrow = 2, common.legend =  TRUE, legend = "bottom") 
ggsave("./figures/log_figures_bycatch_removed/hemi_lep.png", hemi_lep, height = 9, width = 9)
```

#### Tidy
```{r}
rm(combined, corr_hemi_ref, corr_lep_ref, hemi_eff, hemi_lep, hemiptera_lepidoptera, hemiptera_lepidoptera_plot_ab, hemiptera_lepidoptera_plot_sr, hl_m3, lep_eff, lep_m1, m, a, hemiptera, lepidoptera, r)
```




#### Calculate number of sites / studies per comparison
